<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head><title>Tailor Swyfte</title><link href="epub.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e80a1ec8-ed8e-40f7-ba3d-26a647960341" name="Adept.expected.resource"/></head><body data-type="book"><section data-pdf-bookmark="Chapter 11. Tailor Swyfte" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch11">
<h1><span class="label">Chapter 11. </span>Tailor Swyfte</h1>

<blockquote>
<p>
From the embryonic whale to the monkey with no tail
</p>
<p data-type="attribution">
They Might Be Giants, “Mammal” (1992)
</p>
</blockquote>

<p>The challenge in this chapter will be to write a version of <code>tail</code>, which is the converse of <code>head</code> from <a data-type="xref" href="ch04.html#ch04">Chapter 4</a>.<a data-primary="tail utility" data-type="indexterm" id="ix_tail"/>
The program will show you the last bytes or lines of one or more files or <code>STDIN</code>, usually defaulting to the last 10 lines.
Again the program will have to deal with bad input and will possibly mangle Unicode characters.
The challenge program will read only regular files, so we won’t bother with <code>STDIN</code>.</p>

<p>In this chapter, you will learn how to do the following:</p>

<ul>
<li>
<p>Initialize a static, global, computed value</p>
</li>
<li>
<p>Seek to a line or byte position in a filehandle</p>
</li>
<li>
<p>Indicate multiple trait bounds on a type using the <code>where</code> clause</p>
</li>
<li>
<p>Build a release binary with Cargo<a data-primary="trait bounds" data-type="indexterm" id="id1284"/><a data-primary="where clause" data-type="indexterm" id="id1285"/></p>
</li>
<li>
<p>Benchmark programs to compare runtime performance</p>
</li>
</ul>






<section data-pdf-bookmark="How tail Works" data-type="sect1"><div class="sect1" id="id105">
<h1>How tail Works</h1>

<p>To demonstrate how the <a data-primary="tail utility" data-secondary="how it works" data-type="indexterm" id="ix_tailhow"/>challenge program should work, I’ll first show you a portion of the manual page for the BSD <code>tail</code>.<a data-primary="BSD version" data-secondary="tail utility" data-type="indexterm" id="id1286"/>
Note that the challenge program will only implement some of these features:<a data-primary="+ (plus sign)" data-secondary="before numbers in tail utility" data-type="indexterm" id="id1287"/><a data-primary="- (dash or minus sign)" data-secondary="before numbers in tail utility" data-type="indexterm" id="id1288"/></p>

<pre class="widows_orphans_44" data-type="programlisting">TAIL(1)                   BSD General Commands Manual                  TAIL(1)

NAME
     tail -- display the last part of a file

SYNOPSIS
     tail [-F | -f | -r] [-q] [-b number | -c number | -n number] [file ...]

DESCRIPTION
     The tail utility displays the contents of file or, by default, its stan-
     dard input, to the standard output.

     The display begins at a byte, line or 512-byte block location in the
     input.  Numbers having a leading plus ('+') sign are relative to the
     beginning of the input, for example, ''-c +2'' starts the display at the
     second byte of the input.  Numbers having a leading minus ('-') sign or
     no explicit sign are relative to the end of the input, for example,
     ''-n2'' displays the last two lines of the input.  The default starting
     location is ''-n 10'', or the last 10 lines of the input.</pre>

<p>The BSD version has many options, but these are the only ones relevant to the challenge program:</p>

<pre data-type="programlisting">     -c number
             The location is number bytes.

     -n number
             The location is number lines.

     -q      Suppresses printing of headers when multiple files are being
             examined.

     If more than a single file is specified, each file is preceded by a
     header consisting of the string ''==&gt; XXX &lt;=='' where XXX is the name of
     the file unless -q flag is specified.</pre>

<p>Here’s part of the manual page for GNU <code>tail</code>, which <a data-primary="GNU version" data-secondary="tail utility" data-type="indexterm" id="id1289"/>includes long option names:</p>

<pre data-type="programlisting">TAIL(1)                          User Commands                         TAIL(1)

NAME
    tail - output the last part of files

SYNOPSIS
    tail [OPTION]... [FILE]...

DESCRIPTION
    Print  the  last  10  lines of each FILE to standard output.  With more
    than one FILE, precede each with a header giving the file  name.   With
    no FILE, or when FILE is -, read standard input.

    Mandatory  arguments  to  long  options are mandatory for short options
    too.

    -c, --bytes=K
           output the last K bytes; or use -c +K to output  bytes  starting
           with the Kth of each file

    -n, --lines=K
           output the last K lines, instead of the last 10; or use -n +K to
              output starting with the Kth</pre>

<p>I’ll use files in the book’s <em>11_tailr/tests/inputs</em> directory to demonstrate the features of <code>tail</code> that the challenge will implement.
As in previous chapters, there are examples with Windows line endings that must be preserved in the output. The files I’ll use are:</p>

<ul>
<li>
<p><em>empty.txt</em>:  an empty file</p>
</li>
<li>
<p><em>one.txt</em>:    a file with one line of UTF-8 Unicode text</p>
</li>
<li>
<p><em>two.txt</em>:    a file with two lines of ASCII text</p>
</li>
<li>
<p><em>three.txt</em>:  a file with three lines of ASCII text and CRLF line terminators</p>
</li>
<li>
<p><em>twelve.txt</em>: a file with 12 lines of ASCII text</p>
</li>
</ul>

<p>Change into the chapter’s directory:</p>

<pre data-type="programlisting">$ cd 11_tailr</pre>

<p>By default, <code>tail</code> will show the last 10 <a data-primary="tail utility" data-secondary="how it works" data-tertiary="tail showing last 10 lines of a file" data-type="indexterm" id="id1290"/>lines of a file, which you can see with <em>tests/inputs/twelve.txt</em>:</p>

<pre data-type="programlisting">$ tail tests/inputs/twelve.txt
three
four
five
six
seven
eight
nine
ten
eleven
twelve</pre>

<p>Run it with <code>-n 4</code> to see the last four lines:</p>

<pre data-type="programlisting">$ tail -n 4 tests/inputs/twelve.txt
nine
ten
eleven
twelve</pre>

<p>Use <code>-c 10</code> to select the last ten bytes of the file.<a data-primary="bytes" data-secondary="tail showing last 10 bytes of a file" data-type="indexterm" id="id1291"/>
In the following output, there are eight byte-sized characters and two byte-sized newline characters, for a total of ten bytes.<a data-primary="$ (dollar sign)" data-secondary="ends of lines in cat -e" data-type="indexterm" id="id1292"/><a data-primary="cat (concatenate) command" data-secondary="-e option" data-type="indexterm" id="id1293"/>
Pipe the output to <code>cat -e</code> to display the dollar sign (<code>$</code>) to indicate the newlines:</p>

<pre data-type="programlisting">$ tail -c 10 tests/inputs/twelve.txt | cat -e
en$
twelve$</pre>

<p>With multiple input files, <code>tail</code> will print separators between each file.<a data-primary="separators between input files in tail" data-type="indexterm" id="id1294"/>
Any errors opening files (such as for nonexistent or unreadable files) will be noted to <code>STDERR</code> without any file headers.
For instance, <em>blargh</em> represents a nonexistent file in the following command:</p>

<pre data-type="programlisting">$ tail -n 1 tests/inputs/one.txt <strong>blargh</strong> tests/inputs/three.txt
==&gt; tests/inputs/one.txt &lt;==
Öne line, four wordś.
<strong>tail: blargh: No such file or directory</strong>

==&gt; tests/inputs/three.txt &lt;==
four words.</pre>

<p>The <code>-q</code> flag will suppress the file headers:</p>

<pre data-type="programlisting">$ tail <strong>-q</strong> -n 1 tests/inputs/*.txt
Öne line, four wordś.
ten
four words.
Four words.</pre>

<p>Requesting more lines or bytes than a file contains<a data-primary="bytes" data-secondary="requesting more bytes than file contains in tail" data-type="indexterm" id="id1295"/><a data-primary="lines" data-secondary="requesting more lines than file contains in tail" data-type="indexterm" id="id1296"/> is not an error and will cause <code>tail</code> to print the entire file:</p>

<pre data-type="programlisting">$ tail -n 1000 tests/inputs/one.txt
Öne line, four wordś.
$ tail -c 1000 tests/inputs/one.txt
Öne line, four wordś.</pre>

<p>As noted in the manual pages, <code>-n</code> or <code>-c</code> values may begin with a plus sign to indicate a line or byte position from the <em>beginning</em> of the file rather than the end.<a data-primary="beginning of file, byte or line position from" data-type="indexterm" id="id1297"/>
A start position beyond the end of the file is not an error, and <code>tail</code> will print nothing, which you can see if you run <strong><code>tail -n +1000 tests/inputs/one.txt</code></strong>.
In the following command, I use <code>-n +8</code> to start printing from line 8:</p>

<pre data-type="programlisting">$ tail -n +8 tests/inputs/twelve.txt
eight
nine
ten
eleven
twelve</pre>

<p>It’s possible to split multibyte characters with byte selection.<a data-primary="bytes" data-secondary="selection of, splitting multibyte characters in tail" data-type="indexterm" id="id1298"/>
For example, the <em>tests​/⁠inputs/one.txt</em> file starts with the Unicode character <em>Ö</em>, which is two bytes long.<a data-primary="Unicode" data-secondary="multibyte character Ö" data-type="indexterm" id="id1299"/>
In the following command, I use <code>-c +2</code> to start printing from the second byte, which will split the multibyte character, resulting <a data-primary="unknown character" data-type="indexterm" id="id1300"/>in the unknown character:</p>

<pre data-type="programlisting">$ tail -c +2 tests/inputs/one.txt
�ne line, four wordś.</pre>

<p class="pagebreak-before">To start printing from the second <em>character</em>, I must use <code>-c +3</code> to start printing from the third <em>byte</em>:</p>

<pre data-type="programlisting">$ tail -c +3 tests/inputs/one.txt
ne line, four wordś.</pre>

<p>The end of <em>tests/inputs/one.txt</em> has a funky Unicode <em>ś</em> thrown in for good measure, which is a multibyte Unicode character.<a data-primary="bytes" data-secondary="requesting last four bytes of a file in tail" data-type="indexterm" id="id1301"/><a data-primary="Unicode" data-secondary="multibyte character ś" data-type="indexterm" id="id1302"/>
If you request the last four bytes of the file, two will be for <em>ś</em>, one for the period, and one for the final newline:</p>

<pre data-type="programlisting">$ tail -c 4 tests/inputs/one.txt
ś.</pre>

<p>If you ask for only three, the <em>ś</em> will be split, and you should see the Unicode <em>unknown</em> character:</p>

<pre data-type="programlisting">$ tail -c 3 tests/inputs/one.txt
�.</pre>

<p>Both the BSD and GNU versions will accept <code>0</code> and <code>-0</code> for <code>-n</code> or <code>-c</code>.
The GNU version will show no output at all, while the BSD version will show no output when run with a single file but will still show the file headers when there are multiple input files.<a data-primary="BSD version" data-secondary="tail utility" data-type="indexterm" id="id1303"/>
The following behavior of BSD is expected of the challenge program:</p>

<pre data-type="programlisting">$ tail -n 0 tests/inputs/*
==&gt; tests/inputs/empty.txt &lt;==

==&gt; tests/inputs/one.txt &lt;==

==&gt; tests/inputs/three.txt &lt;==

==&gt; tests/inputs/twelve.txt &lt;==

==&gt; tests/inputs/two.txt &lt;==</pre>

<p>Both versions interpret the value <code>+0</code> as starting at the zeroth line or byte, so the whole file will be shown:</p>

<pre data-type="programlisting">$ tail -n +0 tests/inputs/one.txt
Öne line, four wordś.
$ tail -c +0 tests/inputs/one.txt
Öne line, four wordś.</pre>

<p>Both versions will reject any value for <code>-n</code> or <code>-c</code> that cannot be parsed as an integer:</p>

<pre data-type="programlisting">$ tail -c foo tests/inputs/one.txt
tail: illegal offset -- foo</pre>

<p>While <code>tail</code> has several more features, this is as much as your program needs to implement.<a data-primary="tail utility" data-secondary="how it works" data-startref="ix_tailhow" data-type="indexterm" id="id1304"/></p>
</div></section>






<section data-pdf-bookmark="Getting Started" data-type="sect1"><div class="sect1" id="id106">
<h1>Getting Started</h1>

<p>The challenge program<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="getting started" data-type="indexterm" id="id1305"/> will be called <code>tailr</code> (pronounced <em>tay-ler</em>).
I recommend you begin with <strong><code>cargo new tailr</code></strong> and then add the following dependencies to <em>Cargo.toml</em>:</p>

<pre data-code-language="toml" data-type="programlisting"><code class="k">[</code><code class="k">dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">anyhow</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.0.79</code><code class="s2">"</code><code class="w">
</code><code class="n">clap</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">version</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">4.5.0</code><code class="s2">"</code><code class="p">,</code><code class="w"> </code><code class="n">features</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"</code><code class="s2">derive</code><code class="s2">"</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">
</code><code class="n">num</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.4.1</code><code class="s2">"</code><code class="w">
</code><code class="n">once_cell</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.19.0</code><code class="s2">"</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO1-1" id="co_tailor_swyfte_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">
</code><code class="n">regex</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.10.3</code><code class="s2">"</code><code class="w">

</code><code class="k">[</code><code class="k">dev-dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">assert_cmd</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">2.0.13</code><code class="s2">"</code><code class="w">
</code><code class="n">predicates</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">3.0.4</code><code class="s2">"</code><code class="w">
</code><code class="n">pretty_assertions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.4.0</code><code class="s2">"</code><code class="w">
</code><code class="n">rand</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.8.5</code><code class="s2">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO1-1" id="callout_tailor_swyfte_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <a href="https://oreil.ly/DXeXE"><code>once_cell</code> crate</a> will be used to create a computed static value.<a data-primary="static, global, computed value" data-secondary="using once_cell crate to create" data-type="indexterm" id="id1306"/><a data-primary="once_cell crate" data-type="indexterm" id="id1307"/></p></dd>
</dl>

<p>Copy the book’s <em>11_tailr/tests</em> directory into your project, and then run <strong><code>cargo test</code></strong> to download the needed crates, build your program, and ensure that you fail all the tests.</p>








<section data-pdf-bookmark="Defining the Arguments" data-type="sect2"><div class="sect2" id="id107">
<h2>Defining the Arguments</h2>

<p>I’ll start by defining the <code>Args</code> struct in <em>src/main.rs</em> as in <a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="defining the arguments" data-type="indexterm" id="ix_tailwrdefarg"/>previous chapters:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">derive(Debug)</code><code class="cp">]</code><code class="w">
</code><code class="k">struct</code><code> </code><code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">files</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO2-1" id="co_tailor_swyfte_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">lines</code><code>:</code><code> </code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO2-2" id="co_tailor_swyfte_CO2-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">bytes</code><code>:</code><code> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO2-3" id="co_tailor_swyfte_CO2-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="n">quiet</code><code>:</code><code> </code><code class="kt">bool</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO2-4" id="co_tailor_swyfte_CO2-4"><img alt="4" src="assets/4.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO2-1" id="callout_tailor_swyfte_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>files</code> is a vector of strings.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO2-2" id="callout_tailor_swyfte_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>lines</code> should default to “10” to indicate the last 10 lines.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO2-3" id="callout_tailor_swyfte_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>bytes</code> is an optional number of bytes to select.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO2-4" id="callout_tailor_swyfte_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>quiet</code> flag is a Boolean for whether or not to suppress the headers between multiple files.<a data-primary="quiet flag" data-type="indexterm" id="id1308"/></p></dd>
</dl>

<p class="pagebreak-before">Either annotate the <code>Args</code> for the <code>clap</code> derive<a data-primary="derive pattern" data-secondary="using in tailr program" data-type="indexterm" id="id1309"/> pattern, or use the following as a skeleton for <code>get_args</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_args</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code>::<code class="n">new</code><code class="p">(</code><code class="s">"tailr"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"0.1.0"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"Ken Youens-Clark &lt;kyclark@gmail.com&gt;"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"Rust version of `tail`"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="c1">// What goes here?</code>
<code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">();</code><code class="w"/>

<code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">files</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">lines</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">bytes</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">quiet</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>I suggest you start your <code>main</code> function by printing the arguments:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">args</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_args</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"{args:#?}"</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>First, get your program to print the <a data-primary="usage statement" data-secondary="tailr utility" data-type="indexterm" id="id1310"/>following usage:</p>

<pre data-type="programlisting">$ cargo run -- -h
Rust version of `tail`

Usage: tailr [OPTIONS] &lt;FILE&gt;...

Arguments:
  &lt;FILE&gt;...  Input file(s)

Options:
  -n, --lines &lt;LINES&gt;  Number of lines [default: 10]
  -c, --bytes &lt;BYTES&gt;  Number of bytes
  -q, --quiet          Suppress headers
  -h, --help           Print help
  -V, --version        Print version</pre>

<p>If you run the program with no arguments, it should fail with an error that at least one <a data-primary="STDIN" data-secondary="tailr not reading by default" data-type="indexterm" id="id1311"/>file argument is required because this program will not read <code>STDIN</code> by default:</p>

<pre data-type="programlisting">$ cargo run
error: the following required arguments were not provided:
  &lt;FILE&gt;...

Usage: tailr &lt;FILE&gt;...</pre>

<p>The <code>--bytes</code> and <code>--lines</code> options <a data-primary="bytes" data-secondary="bytes option in tailr" data-type="indexterm" id="id1312"/><a data-primary="lines" data-secondary="lines option in tailr" data-type="indexterm" id="id1313"/>should be mutually exclusive:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/empty.txt --bytes 1 --lines 1
error: the argument '--bytes &lt;BYTES&gt;' cannot be used with '--lines &lt;LINES&gt;'

Usage: tailr --bytes &lt;BYTES&gt; &lt;FILES&gt;...</pre>

<p>Run the<a data-primary="files argument" data-secondary="tailr program" data-type="indexterm" id="id1314"/> program with a file argument and see if you can get this output:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/one.txt
Args {
    files: [
        "tests/inputs/one.txt", <a class="co" href="#callout_tailor_swyfte_CO3-1" id="co_tailor_swyfte_CO3-1"><img alt="1" src="assets/1.png"/></a>
    ],
    lines: "10", <a class="co" href="#callout_tailor_swyfte_CO3-2" id="co_tailor_swyfte_CO3-2"><img alt="2" src="assets/2.png"/></a>
    bytes: None, <a class="co" href="#callout_tailor_swyfte_CO3-3" id="co_tailor_swyfte_CO3-3"><img alt="3" src="assets/3.png"/></a>
    quiet: false, <a class="co" href="#callout_tailor_swyfte_CO3-4" id="co_tailor_swyfte_CO3-4"><img alt="4" src="assets/4.png"/></a>
}</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO3-1" id="callout_tailor_swyfte_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The positional argument goes into <code>files</code>.<a data-primary="lines" data-secondary="lines option in tailr" data-type="indexterm" id="id1315"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO3-2" id="callout_tailor_swyfte_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>lines</code> argument should default to “10” to take the last 10 lines.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO3-3" id="callout_tailor_swyfte_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>bytes</code> argument should default to <code>None</code>.<a data-primary="bytes" data-secondary="bytes option in tailr" data-type="indexterm" id="id1316"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO3-4" id="callout_tailor_swyfte_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>quiet</code> option should default to <code>false</code>.<a data-primary="quiet option (tailr)" data-type="indexterm" id="id1317"/></p></dd>
</dl>

<p>Run the program with multiple<a data-primary="-c, --bytes option (tailr)" data-primary-sortas="c" data-type="indexterm" id="id1318"/> file arguments and the <code>-c</code> option to ensure you get the following output:</p>

<pre data-type="programlisting">$ cargo run -- -q -c 4 tests/inputs/*.txt
Args {
    files: [
        "tests/inputs/empty.txt", <a class="co" href="#callout_tailor_swyfte_CO4-1" id="co_tailor_swyfte_CO4-1"><img alt="1" src="assets/1.png"/></a>
        "tests/inputs/one.txt",
        "tests/inputs/three.txt",
        "tests/inputs/twelve.txt",
        "tests/inputs/two.txt",
    ],
    lines: "10", <a class="co" href="#callout_tailor_swyfte_CO4-2" id="co_tailor_swyfte_CO4-2"><img alt="2" src="assets/2.png"/></a>
    bytes: Some( <a class="co" href="#callout_tailor_swyfte_CO4-3" id="co_tailor_swyfte_CO4-3"><img alt="3" src="assets/3.png"/></a>
        "4",
    ),
    quiet: true, <a class="co" href="#callout_tailor_swyfte_CO4-4" id="co_tailor_swyfte_CO4-4"><img alt="4" src="assets/4.png"/></a>
}</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO4-1" id="callout_tailor_swyfte_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The positional arguments are parsed as <code>files</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO4-2" id="callout_tailor_swyfte_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>lines</code> argument is still set to the default.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO4-3" id="callout_tailor_swyfte_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Now <code>bytes</code> is set to <code>Some("4")</code> to indicate the last four bytes should be taken.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO4-4" id="callout_tailor_swyfte_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>-q</code> flag causes the <code>quiet</code> option to be <code>true</code>.<a data-primary="quiet option (tailr)" data-type="indexterm" id="id1319"/><a data-primary="tail utility" data-secondary="writing tailr version" data-startref="ix_tailwrdefarg" data-tertiary="defining the arguments" data-type="indexterm" id="id1320"/></p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Pause here and get your program output to match the preceding examples. Your program should also pass two of the tests included with <strong><code>cargo test dies</code></strong>.</p>
</div>
</div></section>








<section data-pdf-bookmark="Parsing and Validating the Command-Line Arguments" data-type="sect2"><div class="sect2" id="id108">
<h2>Parsing and Validating the Command-Line Arguments</h2>

<p>I’ll show you how I wrote my <code>get_args</code> <a data-primary="parsing and validating arguments (tailr)" data-type="indexterm" id="ix_parseval"/><a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="parsing and validating command-line arguments" data-type="indexterm" id="ix_tailwrprsvalarg"/><a data-primary="get_args function" data-secondary="tailr utility" data-type="indexterm" id="id1321"/> function.
Be sure to add <code>use clap::{Arg, ArgAction, Command}</code> for the following:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">get_args</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">"</code><code class="s">tailr</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"</code><code class="s">0.1.0</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"</code><code class="s">Ken Youens-Clark &lt;kyclark@gmail.com&gt;</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"</code><code class="s">Rust version of `tail`</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">Arg</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">"</code><code class="s">files</code><code class="s">"</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO5-1" id="co_tailor_swyfte_CO5-1"><img alt="1" src="assets/1.png"/></a><code class="w">
                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"</code><code class="s">FILE</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"</code><code class="s">Input file(s)</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">required</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">num_args</code><code class="p">(</code><code class="mi">1</code><code class="o">..</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">Arg</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">"</code><code class="s">lines</code><code class="s">"</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO5-2" id="co_tailor_swyfte_CO5-2"><img alt="2" src="assets/2.png"/></a><code class="w">
                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'n'</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"</code><code class="s">lines</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"</code><code class="s">LINES</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"</code><code class="s">Number of lines</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">default_value</code><code class="p">(</code><code class="s">"</code><code class="s">10</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">Arg</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">"</code><code class="s">bytes</code><code class="s">"</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO5-3" id="co_tailor_swyfte_CO5-3"><img alt="3" src="assets/3.png"/></a><code class="w">
                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'c'</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"</code><code class="s">bytes</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"</code><code class="s">BYTES</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">conflicts_with</code><code class="p">(</code><code class="s">"</code><code class="s">lines</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"</code><code class="s">Number of bytes</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">Arg</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">"</code><code class="s">quiet</code><code class="s">"</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO5-4" id="co_tailor_swyfte_CO5-4"><img alt="4" src="assets/4.png"/></a><code class="w">
                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'q'</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"</code><code class="s">quiet</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">action</code><code class="p">(</code><code class="n">ArgAction</code><code>::</code><code class="n">SetTrue</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"</code><code class="s">Suppress headers</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="n">files</code><code>:</code><code> </code><code class="nc">matches</code><code class="p">.</code><code class="n">get_many</code><code class="p">(</code><code class="s">"</code><code class="s">files</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">cloned</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">lines</code><code>:</code><code> </code><code class="nc">matches</code><code class="p">.</code><code class="n">get_one</code><code class="p">(</code><code class="s">"</code><code class="s">lines</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">cloned</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">bytes</code><code>:</code><code> </code><code class="nc">matches</code><code class="p">.</code><code class="n">get_one</code><code class="p">(</code><code class="s">"</code><code class="s">bytes</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">cloned</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">quiet</code><code>:</code><code> </code><code class="nc">matches</code><code class="p">.</code><code class="n">get_flag</code><code class="p">(</code><code class="s">"</code><code class="s">quiet</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO5-1" id="callout_tailor_swyfte_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>files</code> argument is positional and requires at least one value.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO5-2" id="callout_tailor_swyfte_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>lines</code> argument has a default value of <code>10</code>.<a data-primary="files argument" data-type="indexterm" id="id1322"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO5-3" id="callout_tailor_swyfte_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>bytes</code> argument is optional and conflicts with <code>lines</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO5-4" id="callout_tailor_swyfte_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>quiet</code> flag is optional.<a data-primary="quiet option (tailr)" data-type="indexterm" id="id1323"/><a data-primary="bytes" data-secondary="bytes option in tailr" data-type="indexterm" id="id1324"/><a data-primary="lines" data-secondary="lines option in tailr" data-type="indexterm" id="id1325"/></p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Because the <code>--lines</code> and <code>--bytes</code> are mutually exclusive, you might prefer to put them into an <code>ArgGroup</code> as in <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>.</p>
</div>

<p>For the derive pattern,<a data-primary="derive pattern" data-secondary="using in tailr program" data-type="indexterm" id="id1326"/> add <code>use clap::Parser</code> and the following annotations to the <code>Args</code> struct;</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[derive(Debug, Parser)]</code><code class="w"/>
<code class="cp">#[command(author, version, about)]</code><code class="w"/>
<code class="sd">/// Rust version of `tail`</code>
<code class="k">struct</code> <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="sd">/// Input file(s)</code>
<code class="w">    </code><code class="cp">#[arg(required = true)]</code><code class="w"/>
<code class="w">    </code><code class="n">files</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Number of lines</code>
<code class="w">    </code><code class="cp">#[arg(value_name = </code><code class="s">"LINES"</code><code class="cp">, short('n'), long, default_value = </code><code class="s">"10"</code><code class="cp">)]</code><code class="w"/>
<code class="w">    </code><code class="n">lines</code>: <code class="nb">String</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Number of bytes</code>
<code class="w">    </code><code class="cp">#[arg(value_name = </code><code class="s">"BYTES"</code><code class="cp">, short('c'), long, conflicts_with(</code><code class="s">"lines"</code><code class="cp">))]</code><code class="w"/>
<code class="w">    </code><code class="n">bytes</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Suppress headers</code>
<code class="w">    </code><code class="cp">#[arg(short, long)]</code><code class="w"/>
<code class="w">    </code><code class="n">quiet</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Next, I’ll restructure my code to call a <code>run</code> function as in previous chapters.
Add <code>use anyhow::Result</code> for the following code:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">run</code><code class="p">(</code><code class="n">Args</code>::<code class="n">parse</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"{e}"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="n">std</code>::<code class="n">process</code>::<code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">_args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>My next challenge is to validate the <code>lines</code> and <code>bytes</code> arguments.<a data-primary="tail utility" data-secondary="writing tailr version" data-startref="ix_tailwrprsvalarg" data-tertiary="parsing and validating command-line arguments" data-type="indexterm" id="id1327"/></p>
</div></section>








<section data-pdf-bookmark="Parsing Positive and Negative Numeric Arguments" data-type="sect2"><div class="sect2" id="id109">
<h2>Parsing Positive and Negative Numeric Arguments</h2>

<p>The challenge program has similar options as <code>headr</code>, but this program must handle both positive and negative values for the number of lines or bytes.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="parsing positive and negative numeric arguments" data-type="indexterm" id="ix_tailwrprsnum"/><a data-primary="parsing and validating arguments (tailr)" data-secondary="parsing positive and negative numeric arguments" data-type="indexterm" id="ix_parsevalnum"/>
In <code>headr</code>, I used an <em>unsigned</em> integer that can represent only positive values.<a data-primary="unsigned integers" data-type="indexterm" id="id1328"/>
In this program, I will use <a href="https://oreil.ly/7grA6"><code>i64</code></a>, the 64-bit signed integer type, to also store negative numbers.<a data-primary="i64 type" data-type="indexterm" id="id1329"/>
Additionally, I need some way to differentiate between <code>0</code>, which means <em>nothing</em> should be selected, and <code>+0</code>, which means <em>everything</em> should be selected.
I decided to create an <code>enum</code> called <code>TakeValue</code> to represent this, but you may choose a different way<a data-primary="TakeValue enum" data-type="indexterm" id="id1330"/>:</p>

<pre class="widows_5" data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">derive(Debug, PartialEq)</code><code class="cp">]</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO6-1" id="co_tailor_swyfte_CO6-1"><img alt="1" src="assets/1.png"/></a><code class="w">
</code><code class="k">enum</code><code> </code><code class="nc">TakeValue</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">PlusZero</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO6-2" id="co_tailor_swyfte_CO6-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">TakeNum</code><code class="p">(</code><code class="kt">i64</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO6-3" id="co_tailor_swyfte_CO6-3"><img alt="3" src="assets/3.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO6-1" id="callout_tailor_swyfte_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>PartialEq</code> is needed by the tests to compare values.<a data-primary="PartialEq trait" data-type="indexterm" id="id1331"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO6-2" id="callout_tailor_swyfte_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>This variant represents an argument of <code>+0</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO6-3" id="callout_tailor_swyfte_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>This variant represents a valid integer value.</p></dd>
</dl>

<p>To refer to the <code>enum</code> values without the <code>TakeValue</code> prefix, add the following to your imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">TakeValue</code>::<code class="o">*</code><code class="p">;</code><code class="w"/></pre>

<p>Following is the start of the function <code>parse_num</code> I’d like you to write that will accept a string and will return a <code>TakeValue</code> or an error:<a data-primary="parse_num function" data-type="indexterm" id="id1332"/></p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">parse_num</code><code class="p">(</code><code class="n">val</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">TakeValue</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="fm">unimplemented!</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p class="pagebreak-before">Add the following<a data-primary="unit tests" data-secondary="test_parse_num function" data-type="indexterm" id="id1333"/> unit test to a <code>tests</code> module in your <em>src/main.rs</em>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[cfg(test)]</code><code class="w"/>
<code class="k">mod</code> <code class="nn">tests</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="k">super</code>::<code class="p">{</code><code class="n">parse_num</code><code class="p">,</code><code class="w"> </code><code class="n">TakeValue</code>::<code class="o">*</code><code class="p">};</code><code class="w"/>

<code class="w">    </code><code class="cp">#[test]</code><code class="w"/>
<code class="w">    </code><code class="k">fn</code> <code class="nf">test_parse_num</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="c1">// All integers should be interpreted as negative numbers</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"3"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">3</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="c1">// A leading "+" should result in a positive number</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"+3"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">3</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="c1">// An explicit "-" value should result in a negative number</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"-3"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">3</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="c1">// Zero is zero</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"0"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="c1">// Plus zero is special</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"+0"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">PlusZero</code><code class="p">);</code><code class="w"/>

<code class="w">        </code><code class="c1">// Test boundaries</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MAX</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MIN</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">((</code><code class="kt">i64</code>::<code class="n">MIN</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">).</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MIN</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="fm">format!</code><code class="p">(</code><code class="s">"+{}"</code><code class="p">,</code><code class="w"> </code><code class="kt">i64</code>::<code class="n">MAX</code><code class="p">));</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MAX</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MIN</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"> </code><code class="n">TakeNum</code><code class="p">(</code><code class="kt">i64</code>::<code class="n">MIN</code><code class="p">));</code><code class="w"/>

<code class="w">        </code><code class="c1">// A floating-point value is invalid</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"3.14"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_err</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap_err</code><code class="p">().</code><code class="n">to_string</code><code class="p">(),</code><code class="w"> </code><code class="s">"3.14"</code><code class="p">);</code><code class="w"/>

<code class="w">        </code><code class="c1">// Any non-integer string is invalid</code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="s">"foo"</code><code class="p">.</code><code class="n">to_string</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_err</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">unwrap_err</code><code class="p">().</code><code class="n">to_string</code><code class="p">(),</code><code class="w"> </code><code class="s">"foo"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I suggest that you stop reading and take some time to write 
<span class="keep-together">this function.</span> Do not proceed until it passes <strong><code>cargo test test_parse_num</code></strong>. In the next section, I’ll share my solution.</p>
</div>

<p>Once you have a working function, use it in your <code>run</code> to parse the lines and bytes.
For the following code, be sure <a data-primary="anyhow::anyhow macro" data-type="indexterm" id="id1334"/>to add <code>use anyhow::anyhow</code> to your imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="n">args</code><code class="p">.</code><code class="n">lines</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"illegal line count -- {e}"</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"/>

<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">args</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">bytes</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">parse_num</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">transpose</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"illegal byte count -- {e}"</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"/>

<code class="w">    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"lines = {lines:?}"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"bytes = {bytes:?}"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>When run with the default values, the output should look like the following:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/empty.txt
lines = TakeNum(-10)
bytes = None</pre>

<p>Run your program with a value for the bytes to ensure it is parsed correctly:</p>

<pre data-type="programlisting">$ cargo run -- -c 4 tests/inputs/empty.txt
lines = TakeNum(-10)
bytes = Some(TakeNum(-4))</pre>

<p>You probably noticed that the value <code>4</code> was parsed as a negative number even though it was provided as a positive value.
The numeric values for <code>lines</code> and <code>bytes</code> should be negative to indicate that the program will take values from the <em>end</em> of the file.<a data-primary="end of file starting position in tailr" data-type="indexterm" id="id1335"/><a data-primary="lines" data-secondary="lines option in tailr" data-tertiary="negative and positive values for" data-type="indexterm" id="id1336"/><a data-primary="bytes" data-secondary="bytes option in tailr" data-tertiary="negative and positive values for" data-type="indexterm" id="id1337"/>
A plus sign is required to indicate that the<a data-primary="+ (plus sign)" data-secondary="beginning of file starting position in tailr" data-type="indexterm" id="id1338"/><a data-primary="beginning of file starting position in tailr" data-type="indexterm" id="id1339"/><a data-primary="-n, --lines option (tailr)" data-primary-sortas="n" data-type="indexterm" id="id1340"/> starting position is from the <em>beginning</em> of the file:</p>

<pre data-type="programlisting">$ cargo run -- -n +5 tests/inputs/twelve.txt <a class="co" href="#callout_tailor_swyfte_CO7-1" id="co_tailor_swyfte_CO7-1"><img alt="1" src="assets/1.png"/></a>
lines = TakeNum(5) <a class="co" href="#callout_tailor_swyfte_CO7-2" id="co_tailor_swyfte_CO7-2"><img alt="2" src="assets/2.png"/></a>
bytes = None</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO7-1" id="callout_tailor_swyfte_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>+5</code> argument indicates the program should start printing on the fifth line.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO7-2" id="callout_tailor_swyfte_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The value is interpreted as a positive integer.</p></dd>
</dl>

<p>Both <code>-n</code> and <code>-c</code> are allowed to have a value of <code>0</code>, which will mean that no lines or bytes will be shown:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/empty.txt -c 0
lines = TakeNum(-10)
bytes = Some(TakeNum(0))</pre>

<p>As with the<a data-primary="+0 starting point in tail" data-type="indexterm" id="id1341"/> original versions, the value <code>+0</code> indicates that the starting point is the beginning of the file, so all the content will be shown:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/empty.txt -n +0
lines = PlusZero <a class="co" href="#callout_tailor_swyfte_CO8-1" id="co_tailor_swyfte_CO8-1"><img alt="1" src="assets/1.png"/></a>
bytes = None</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO8-1" id="callout_tailor_swyfte_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>PlusZero</code> variant <a data-primary="PlusZero enum variant" data-type="indexterm" id="id1342"/>represents <code>+0</code>.</p></dd>
</dl>

<p>Any noninteger<a data-primary="-n, --lines option (tailr)" data-primary-sortas="n" data-secondary="rejecting noninteger values" data-type="indexterm" id="id1343"/><a data-primary="-c, --bytes option (tailr)" data-primary-sortas="c" data-secondary="rejecting noninteger values" data-type="indexterm" id="id1344"/> value for <code>-n</code> and <code>-c</code> should be rejected:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/empty.txt -n foo
illegal line count -- foo
$ cargo run -- tests/inputs/empty.txt -c bar
illegal byte count -- bar</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop here and implement this much of the program. If you need some guidance on validating the numeric arguments for <code>bytes</code> and <code>lines</code>, I’ll discuss that in the next section.<a data-primary="tail utility" data-secondary="writing tailr version" data-startref="ix_tailwrprsnum" data-tertiary="parsing positive and negative numeric arguments" data-type="indexterm" id="id1345"/><a data-primary="parsing and validating arguments (tailr)" data-secondary="parsing positive and negative numeric arguments" data-startref="ix_parsevalnum" data-type="indexterm" id="id1346"/></p>
</div>
</div></section>








<section data-pdf-bookmark="Using a Regular Expression to Match an Integer with an Optional Sign" data-type="sect2"><div class="sect2" id="id110">
<h2>Using a Regular Expression to Match an Integer with an Optional Sign</h2>

<p>Following is one version of the <code>parse_num</code> function<a data-primary="parse_num function" data-secondary="using regex to match positive or negative integers" data-type="indexterm" id="id1347"/> that passes the tests.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="regular expression matching integers with optional sign" data-type="indexterm" id="ix_tailwrregex"/><a data-primary="regular expressions" data-secondary="using to match integer with optional sign" data-type="indexterm" id="ix_regexint"/><a data-primary="integers" data-secondary="using regular expression to match integer with optional sign" data-type="indexterm" id="ix_intmtch"/>
Here I chose to use a regular expression to see if the input value matches an expected pattern of text.<a data-primary="regex::Regex type" data-type="indexterm" id="id1348"/> If you want to include this version in your program, be sure to add <code>use regex::Regex</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">parse_num</code><code class="p">(</code><code class="n">val</code><code>:</code><code> </code><code class="nb">String</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="n">TakeValue</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">num_re</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Regex</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="s">r"^([+-])?(\d+)$"</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-1" id="co_tailor_swyfte_CO9-1"><img alt="1" src="assets/1.png"/></a><code class="w">

    </code><code class="k">match</code><code class="w"> </code><code class="n">num_re</code><code class="p">.</code><code class="n">captures</code><code class="p">(</code><code class="o">&amp;</code><code class="n">val</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="n">caps</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">sign</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">caps</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">.</code><code class="n">map_or</code><code class="p">(</code><code class="s">"</code><code class="s">-</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="o">|</code><code class="n">m</code><code class="o">|</code><code class="w"> </code><code class="n">m</code><code class="p">.</code><code class="n">as_str</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-2" id="co_tailor_swyfte_CO9-2"><img alt="2" src="assets/2.png"/></a><code class="w">
            </code><code class="kd">let</code><code class="w"> </code><code class="n">signed_num</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">                </code><code class="fm">format!</code><code class="p">(</code><code class="s">"</code><code class="s">{sign}{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">caps</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">as_str</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-3" id="co_tailor_swyfte_CO9-3"><img alt="3" src="assets/3.png"/></a><code class="w">

            </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">num</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">signed_num</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-4" id="co_tailor_swyfte_CO9-4"><img alt="4" src="assets/4.png"/></a><code class="w">
                </code><code class="k">if</code><code class="w"> </code><code class="n">sign</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="s">"</code><code class="s">+</code><code class="s">"</code><code class="w"> </code><code class="o">&amp;</code><code class="o">&amp;</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-5" id="co_tailor_swyfte_CO9-5"><img alt="5" src="assets/5.png"/></a><code class="w">
                    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">PlusZero</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-6" id="co_tailor_swyfte_CO9-6"><img alt="6" src="assets/6.png"/></a><code class="w">
                </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">TakeNum</code><code class="p">(</code><code class="n">num</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-7" id="co_tailor_swyfte_CO9-7"><img alt="7" src="assets/7.png"/></a><code class="w">
                </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="n">bail</code><code class="o">!</code><code class="p">(</code><code class="n">val</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-8" id="co_tailor_swyfte_CO9-8"><img alt="8" src="assets/8.png"/></a><code class="w">
            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="n">bail</code><code class="o">!</code><code class="p">(</code><code class="n">val</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO9-9" id="co_tailor_swyfte_CO9-9"><img alt="9" src="assets/9.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO9-1" id="callout_tailor_swyfte_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a regex to find an optional leading <code>+</code> or <code>-</code> sign followed by one or more numbers.<a data-primary="+ (plus sign)" data-secondary="matching in regular expressions" data-type="indexterm" id="id1349"/><a data-primary="- (dash or minus sign)" data-secondary="matching in regular expressions" data-type="indexterm" id="id1350"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-2" id="callout_tailor_swyfte_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>If the regex matches, the optional sign will be the first capture. Assume the minus sign if there is no match.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-3" id="callout_tailor_swyfte_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The digits of the number will be in the second capture. Format the sign and digits into a string.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-4" id="callout_tailor_swyfte_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Attempt to parse the number as an <code>i64</code>, which Rust infers from the function’s return type.<a data-primary="i64 type" data-type="indexterm" id="id1351"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-5" id="callout_tailor_swyfte_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Check if the sign is a plus and the parsed value is <code>0</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-6" id="callout_tailor_swyfte_CO9-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>If so, return the <code>PlusZero</code> variant.<a data-primary="PlusZero enum variant" data-type="indexterm" id="id1352"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-7" id="callout_tailor_swyfte_CO9-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Otherwise, return the parsed value as the <code>TakeNum</code> variant.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-8" id="callout_tailor_swyfte_CO9-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Return the unparsable number as an error.<a data-primary="TakeNum enum variant" data-type="indexterm" id="id1353"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO9-9" id="callout_tailor_swyfte_CO9-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Return an invalid argument as an error.</p></dd>
</dl>

<p>Regular expression syntax can be daunting to the uninitiated.
<a data-type="xref" href="#fig_11.1">Figure 11-1</a> shows each element of the pattern used in the preceding function.</p>

<figure><div class="figure" id="fig_11.1">
<img alt="clru 1101" src="assets/clru_1101.png"/>
<h6><span class="label">Figure 11-1. </span>This is a regular expression that will match a positive or negative integer.</h6>
</div></figure>

<p>You’ve seen much of this syntax in previous programs.
Here’s a review of all the parts of this regex:</p>

<ul>
<li>
<p>The <code>^</code> indicates the beginning of a string. Without this, the pattern could match anywhere inside the string.<a data-primary="^ (caret)" data-secondary="beginning of string matching in regular expressions" data-type="indexterm" id="id1354"/><a data-primary="() (parentheses)" data-secondary="grouping and capturing in regular expressions" data-type="indexterm" id="id1355"/></p>
</li>
<li>
<p>Parentheses group and capture values, making them available through <a href="https://oreil.ly/O6frw"><code>Regex::captures</code></a>.<a data-primary="Regex::captures" data-type="indexterm" id="id1356"/></p>
</li>
<li>
<p>Square brackets (<code>[]</code>) create a <em>character class</em> that will match any of the contained values.<a data-primary="character classes" data-type="indexterm" id="id1357"/><a data-primary="[] (square brackets)" data-secondary="indicating character classes in regular expressions" data-type="indexterm" id="id1358"/><a data-primary="- (dash or minus sign)" data-secondary="denoting range in character classes in regular expressions" data-type="indexterm" id="id1359"/><a data-primary="ranges" data-secondary="in character classes in regular expressions" data-secondary-sortas="character" data-type="indexterm" id="id1360"/> A dash (<code>-</code>) inside a character class can be used to denote a range, such as <code>[0-9]</code> to indicate all the characters from 0 to 9.<sup><a data-type="noteref" href="ch11.html#id1361" id="id1361-marker">1</a></sup> To indicate a literal dash, it should occur last.</p>
</li>
<li>
<p>A <code>?</code> makes the preceding pattern optional.<a data-primary="? (question mark)" data-secondary="in regular expressions" data-type="indexterm" id="id1362"/><a data-primary="\d (digits) in regular expressions" data-type="indexterm" id="id1363"/></p>
</li>
<li>
<p>The <code>\d</code> is shorthand for the character class <code>[0-9]</code> and so matches any digit. <a data-primary="+ (plus sign)" data-secondary="matching in regular expressions" data-type="indexterm" id="id1364"/>The 
<span class="keep-together"><code>+</code> suffix</span> indicates <em>one or more</em> of the preceding pattern.</p>
</li>
<li>
<p>The <code>$</code> indicates the end of the string.<a data-primary="$ (dollar sign)" data-secondary="end of string matching in regular expressions" data-type="indexterm" id="id1365"/> Without this, the regular expression would match even when additional characters follow a successful match.</p>
</li>
</ul>

<p>I’d like to make one small change.
The first line of the preceding function creates a regular expression by parsing the pattern <em>each time</em> the function is called:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">parse_num</code><code class="p">(</code><code class="n">val</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">TakeValue</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">num_re</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Regex</code>::<code class="n">new</code><code class="p">(</code><code class="s">r"^([+-])?(\d+)$"</code><code class="p">).</code><code class="n">unwrap</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>I’d like my program to do the work of compiling the regex just once.
You’ve seen in earlier tests how I’ve used <code>const</code> to create a constant value.
It’s common to use <code>ALL_CAPS</code> to<a data-primary="ALL_CAPS, using to name global constants" data-type="indexterm" id="id1366"/><a data-primary="constants" data-type="indexterm" id="id1367"/> name global constants and to place them near the top of the crate, 
<span class="keep-together">like so</span>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="c1">// This will not compile</code>
<code class="k">const</code><code class="w"> </code><code class="n">NUM_RE</code>: <code class="nc">Regex</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Regex</code>::<code class="n">new</code><code class="p">(</code><code class="s">r"^([+-])?(\d+)$"</code><code class="p">).</code><code class="n">unwrap</code><code class="p">();</code><code class="w"/></pre>

<p>If I try to run the test again, I get the<a data-primary="constants" data-secondary="error using computed value for" data-type="indexterm" id="id1368"/> following error telling me that I cannot use a computed value for a constant:</p>

<pre data-type="programlisting">error[E0015]: cannot call non-const fn `regex::Regex::new` in constants
 --&gt; src/main.rs:7:23
  |
7 | const NUM_RE: Regex = Regex::new(r"^([+-])?(\d+)$").unwrap();
  |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |
  = note: calls in constants are limited to constant functions, tuple structs
    and tuple variants</pre>

<p>Enter <code>once_cell</code>, which provides a mechanism for creating lazily evaluated statics.<a data-primary="lazily evaluated statics" data-type="indexterm" id="id1369"/><a data-primary="once_cell crate" data-type="indexterm" id="id1370"/>
To use this, you must first add the dependency to <em>Cargo.toml</em>, which I included at the start of this chapter.
To create a lazily evaluated regular expression just <a data-primary="regular expressions" data-secondary="creating lazily evaluated regular expression" data-type="indexterm" id="id1371"/>one time in my program, I add the following to the top of <em>src/main.rs</em>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">use</code><code class="w"> </code><code class="n">once_cell</code>::<code class="n">sync</code>::<code class="n">OnceCell</code><code class="p">;</code><code class="w"/>

<code class="k">static</code><code class="w"> </code><code class="n">NUM_RE</code>: <code class="nc">OnceCell</code><code class="o">&lt;</code><code class="n">Regex</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">OnceCell</code>::<code class="n">new</code><code class="p">();</code><code class="w"/></pre>

<p>The only<a data-primary="static, global, computed value" data-type="indexterm" id="id1372"/> change to the <code>parse_num</code> function is to initialize <code>NUM_RE</code> the first time the function is called:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">parse_num</code><code class="p">(</code><code class="n">val</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">TakeValue</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">num_re</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">        </code><code class="n">NUM_RE</code><code class="p">.</code><code class="n">get_or_init</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="n">Regex</code>::<code class="n">new</code><code class="p">(</code><code class="s">r"^([+-])?(\d+)$"</code><code class="p">).</code><code class="n">unwrap</code><code class="p">());</code><code class="w"/>
<code class="w">    </code><code class="c1">// Same as before</code>
<code class="p">}</code><code class="w"/></pre>

<p>It is not a requirement that you use a regular expression to parse the numeric arguments.<a data-primary="parsing and validating arguments (tailr)" data-secondary="parsing numeric arguments using Rust's internal parsing" data-type="indexterm" id="id1373"/>
Here’s a method that relies only on Rust’s internal parsing capabilities:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">parse_num</code><code class="p">(</code><code class="n">val</code><code>:</code><code> </code><code class="nb">String</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="n">TakeValue</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">signs</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="kt">char</code><code class="p">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="p">[</code><code class="sc">'+'</code><code class="p">,</code><code class="w"> </code><code class="sc">'-'</code><code class="p">]</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO10-1" id="co_tailor_swyfte_CO10-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">val</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="n">signs</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO10-2" id="co_tailor_swyfte_CO10-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">val</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">val</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="kt">i64</code><code>::</code><code class="n">wrapping_neg</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO10-3" id="co_tailor_swyfte_CO10-3"><img alt="3" src="assets/3.png"/></a><code class="w">

    </code><code class="k">match</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">num</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="o">&amp;</code><code class="o">&amp;</code><code class="w"> </code><code class="n">val</code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="sc">'+'</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO10-4" id="co_tailor_swyfte_CO10-4"><img alt="4" src="assets/4.png"/></a><code class="w">
                </code><code class="nb">Ok</code><code class="p">(</code><code class="n">PlusZero</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="nb">Ok</code><code class="p">(</code><code class="n">TakeNum</code><code class="p">(</code><code class="n">num</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="n">bail</code><code class="o">!</code><code class="p">(</code><code class="n">val</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO10-5" id="co_tailor_swyfte_CO10-5"><img alt="5" src="assets/5.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO10-1" id="callout_tailor_swyfte_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The type annotation is required because Rust infers the type <code>&amp;[char; 2]</code>, which is a reference to an array, but I want to coerce the value to a slice.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO10-2" id="callout_tailor_swyfte_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>If the given value starts with a plus or minus sign, use <code>str::parse</code>, which will use the sign to create a positive or<a data-primary="str::parse function" data-type="indexterm" id="id1374"/> negative number, respectively.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO10-3" id="callout_tailor_swyfte_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Otherwise, parse the number and use <a href="https://oreil.ly/H2gWn"><code>i64::wrapping_neg</code></a> to compute the negative value; that is, a positive value will be returned as negative, while a negative value will remain negative.<a data-primary="i64::wrapping_neg function" data-type="indexterm" id="id1375"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO10-4" id="callout_tailor_swyfte_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>If the result is a successfully parsed <code>i64</code>, check whether to return <code>PlusZero</code> when the number is <code>0</code> and the given value starts with a plus sign; otherwise, return the parsed value.<a data-primary="PlusZero enum variant" data-type="indexterm" id="id1376"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO10-5" id="callout_tailor_swyfte_CO10-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Return the unparsable value as an error.</p></dd>
</dl>

<p>You may have found another way to figure this out, and that’s the point with functions and testing.
It doesn’t much matter <em>how</em> a function is written as long as it passes the tests.
A function is a black box where something goes in and something comes out, and we write enough tests to convince ourselves that the function works 
<span class="keep-together">correctly.</span><a data-primary="regular expressions" data-secondary="using to match integer with optional sign" data-startref="ix_regexint" data-type="indexterm" id="id1377"/><a data-primary="integers" data-secondary="using regular expression to match integer with optional sign" data-startref="ix_intmtch" data-type="indexterm" id="id1378"/><a data-primary="tail utility" data-secondary="writing tailr version" data-startref="ix_tailwrregex" data-tertiary="regular expression matching integers with optional sign" data-type="indexterm" id="id1379"/></p>
</div></section>








<section data-pdf-bookmark="Processing the Files" data-type="sect2"><div class="sect2" id="id111">
<h2>Processing the Files</h2>

<p>Expand your <code>run</code> function to iterate the given files and attempt to open them.<a data-primary="parsing and validating arguments (tailr)" data-startref="ix_parseval" data-type="indexterm" id="id1380"/><a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="processing the files" data-type="indexterm" id="id1381"/>
Since the challenge does not<a data-primary="std::fs::File" data-type="indexterm" id="id1382"/> include reading <code>STDIN</code>, you only need to add <code>use std::fs::File</code> for the following code:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// Same as before</code>

<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">File</code>::<code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"{filename}: {err}"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="fm">println!</code><code class="p">(</code><code class="s">"Opened {filename}"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>

<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Run your program with both good and bad filenames to verify this works.
Additionally, your program should now pass <strong><code>cargo test skips_bad_file</code></strong>.
In the following command, <em>blargh</em> represents a nonexistent file:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/one.txt <strong>blargh</strong>
Opened tests/inputs/one.txt
<strong>blargh: No such file or directory (os error 2)</strong></pre>
</div></section>








<section data-pdf-bookmark="Counting the Total Lines and Bytes in a File" data-type="sect2"><div class="sect2" id="id112">
<h2>Counting the Total Lines and Bytes in a File</h2>

<p>Next, it’s time to figure out how to read a file from a given byte or line location.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="counting total lines and bytes in a file" data-type="indexterm" id="ix_tailwrcount"/><a data-primary="lines" data-secondary="counting total in file using tailr" data-type="indexterm" id="ix_linect"/><a data-primary="bytes" data-secondary="counting total bytes in a file in tailr" data-type="indexterm" id="ix_bytect"/><a data-primary="count_lines_bytes function" data-type="indexterm" id="ix_ctlnbyt"/>
For instance, the default case is to print the last 10 lines of a file, so I need to know how many lines are in the file to figure out which is the tenth from the end.
The same is true for bytes.
I also need to determine if the user has requested more lines or bytes than the file contains.
When this value is negative—meaning the user wants to start beyond the beginning of the file—the program should print the entire file.
When this value is positive—meaning the user wants to start beyond the end of the file—the program should print nothing.</p>

<p>I decided to create a function called <code>count_lines_bytes</code> that takes a filename and returns a tuple containing the total number of lines and bytes in the file.
Here is the function’s signature:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">count_lines_bytes</code><code class="p">(</code><code class="n">filename</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="kt">i64</code><code class="p">,</code><code class="w"> </code><code class="kt">i64</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="fm">unimplemented!</code><code class="p">()</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>If you want <a data-primary="unit tests" data-secondary="test_count_lines_bytes function" data-type="indexterm" id="id1383"/>to create this function, modify your <code>tests</code> module to add the following unit test:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[cfg(test)]</code><code class="w"/>
<code class="k">mod</code> <code class="nn">tests</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="k">super</code>::<code class="p">{</code><code class="n">count_lines_bytes</code><code class="p">,</code><code class="w"> </code><code class="n">parse_num</code><code class="p">,</code><code class="w"> </code><code class="n">TakeValue</code>::<code class="o">*</code><code class="p">};</code><code class="w"/>

<code class="w">    </code><code class="cp">#[test]</code><code class="w"/>
<code class="w">    </code><code class="k">fn</code> <code class="nf">test_parse_num</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"> </code><code class="c1">// Same as before</code>

<code class="w">    </code><code class="cp">#[test]</code><code class="w"/>
<code class="w">    </code><code class="k">fn</code> <code class="nf">test_count_lines_bytes</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="s">"tests/inputs/one.txt"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="n">bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">();</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">bytes</code><code class="p">,</code><code class="w"> </code><code class="mi">24</code><code class="p">);</code><code class="w"/>

<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="s">"tests/inputs/twelve.txt"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">());</code><code class="w"/>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="n">bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">();</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="mi">12</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">bytes</code><code class="p">,</code><code class="w"> </code><code class="mi">63</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Pause here and write the code that passes <strong><code>cargo test test_count_lines_bytes</code></strong>.</p>
</div>

<p>You can expand your <code>run</code> to temporarily print the count of lines and bytes in input files:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// Same as before</code>

<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">File</code>::<code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"{filename}: {err}"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">total_lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">                    </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"/>
<code class="w">                </code><code class="fm">println!</code><code class="p">(</code><code class="w"/>
<code class="w">                    </code><code class="s">"{filename} has {total_lines} lines, {total_bytes} bytes"</code><code class="w"/>
<code class="w">                </code><code class="p">);</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I decided to pass the filename to the <code>count_lines_bytes</code> function instead of the filehandle that is returned by <code>File::open</code> because the filehandle will be consumed by the function, making it unavailable for use in selecting the bytes or lines.<a data-primary="File::open function" data-type="indexterm" id="id1384"/></p>
</div>

<p>Verify that it looks OK:</p>

<pre data-type="programlisting">$ cargo run tests/inputs/one.txt tests/inputs/twelve.txt
tests/inputs/one.txt has 1 lines, 24 bytes
tests/inputs/twelve.txt has 12 lines, 63 bytes</pre>
</div></section>








<section data-pdf-bookmark="Finding the Starting Line to Print" data-type="sect2"><div class="sect2" id="id113">
<h2>Finding the Starting Line to Print</h2>

<p>My next step was to write a function to print the lines of a given file.
Following is the signature of my <code>print_lines</code> function.<a data-primary="count_lines_bytes function" data-startref="ix_ctlnbyt" data-type="indexterm" id="id1385"/><a data-primary="lines" data-secondary="counting total in file using tailr" data-startref="ix_linect" data-type="indexterm" id="id1386"/><a data-primary="tail utility" data-secondary="writing tailr version" data-startref="ix_tailwrcount" data-tertiary="counting total lines and bytes in a file" data-type="indexterm" id="id1387"/><a data-primary="bytes" data-secondary="counting total bytes in a file in tailr" data-startref="ix_bytect" data-type="indexterm" id="id1388"/><a data-primary="lines" data-secondary="finding starting line to print in tailr" data-type="indexterm" id="id1389"/><a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="finding starting line to print" data-type="indexterm" id="id1390"/><a data-primary="std::io::BufRead trait" data-type="indexterm" id="id1391"/><a data-primary="BufRead trait" data-type="indexterm" id="id1392"/>
Be sure to add <code>use std::io::BufRead</code> for this:</p>

<pre class="pagebreak-before" data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">print_lines</code><code class="p">(</code><code class="w">
</code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code>:</code><code> </code><code class="nc">impl</code><code class="w"> </code><code class="n">BufRead</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO11-1" id="co_tailor_swyfte_CO11-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">num_lines</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO11-2" id="co_tailor_swyfte_CO11-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">total_lines</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO11-3" id="co_tailor_swyfte_CO11-3"><img alt="3" src="assets/3.png"/></a><code class="w">
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="fm">unimplemented!</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO11-1" id="callout_tailor_swyfte_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>file</code> argument should implement the <code>BufRead</code> trait.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO11-2" id="callout_tailor_swyfte_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>num_lines</code> argument is a <code>TakeValue</code> describing the number of lines to print.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO11-3" id="callout_tailor_swyfte_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>total_lines</code> argument is the total number of lines in this file.<a data-primary="TakeValue enum" data-type="indexterm" id="id1393"/></p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There is no unit test because this function prints to the command line. If I had chosen to return a vector of lines, I risk reading an entire file into memory, which may exceed the available memory. We will rely on the integration tests for the program’s output to ensure this works correctly.</p>
</div>

<p>I can find the starting line’s index using the number of lines the user wants to print and the total number of lines in the file.
Since I will also need this logic to find the starting byte position, I decided to write a function called <code>get_start_index</code> that will return <code>Some&lt;u64&gt;</code> when there is a valid starting position or <code>None</code> when there is not.<a data-primary="get_start_index function" data-type="indexterm" id="id1394"/>
A valid starting position must be a positive number, so I decided to return a <code>u64</code>.<a data-primary="u64 type" data-type="indexterm" id="id1395"/>
Additionally, the functions where I will use the returned index also require this type:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_start_index</code><code class="p">(</code><code class="n">take_val</code>: <code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w"> </code><code class="n">total</code>: <code class="kt">i64</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u64</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="fm">unimplemented!</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Following is a unit test you can add to the <code>tests</code> module that might help you see all the possibilities more clearly.<a data-primary="unit tests" data-secondary="test_get_start_index function" data-type="indexterm" id="id1396"/>
For instance, the function returns <code>None</code> when the given file is empty or when trying to read from a position beyond the end of the file.
Be sure to add <code>get_start_index</code> to the list of <code>super</code> imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[test]</code><code class="w"/>
<code class="k">fn</code> <code class="nf">test_get_start_index</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// +0 from an empty file (0 lines/bytes) returns None</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">PlusZero</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">),</code><code class="w"> </code><code class="nb">None</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="c1">// +0 from a nonempty file returns an index that</code>
<code class="w">    </code><code class="c1">// is one less than the number of lines/bytes</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">PlusZero</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code><code class="w"/>

<code class="w">    </code><code class="c1">// Taking 0 lines/bytes returns None</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code><code class="w"> </code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="nb">None</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="c1">// Taking any lines/bytes from an empty file returns None</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="mi">0</code><code class="p">),</code><code class="w"> </code><code class="nb">None</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="c1">// Taking more lines/bytes than is available returns None</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code><code class="w"> </code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="nb">None</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="c1">// When starting line/byte is less than total lines/bytes,</code>
<code class="w">    </code><code class="c1">// return one less than starting number</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">1</code><code class="p">));</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="mi">3</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">2</code><code class="p">));</code><code class="w"/>

<code class="w">    </code><code class="c1">// When starting line/byte is negative and less than total,</code>
<code class="w">    </code><code class="c1">// return total - start</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">9</code><code class="p">));</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">2</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">8</code><code class="p">));</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">3</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">7</code><code class="p">));</code><code class="w"/>

<code class="w">    </code><code class="c1">// When starting line/byte is negative and more than total,</code>
<code class="w">    </code><code class="c1">// return 0 to print the whole file</code>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">get_start_index</code><code class="p">(</code><code class="o">&amp;</code><code class="n">TakeNum</code><code class="p">(</code><code class="o">-</code><code class="mi">20</code><code class="p">),</code><code class="w"> </code><code class="mi">10</code><code class="p">),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Once you figure out the line index to start printing, use this information in the <code>print_lines</code> function to iterate the lines of the input file and print all the lines after the starting index, if there is one.</p>
</div></section>








<section data-pdf-bookmark="Finding the Starting Byte to Print" data-type="sect2"><div class="sect2" id="id114">
<h2>Finding the Starting Byte to Print</h2>

<p>I also wrote a function called <code>print_bytes</code> that works very similarly to <code>print_lines</code>.<a data-primary="bytes" data-secondary="finding starting byte to print in tailr" data-type="indexterm" id="id1397"/><a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="finding starting byte to print" data-type="indexterm" id="id1398"/>
The function’s signature indicates that the <code>file</code> argument <a data-primary="Read trait" data-secondary="file argument implementing" data-type="indexterm" id="id1399"/><a data-primary="Seek trait" data-type="indexterm" id="id1400"/>must implement the traits <a href="https://oreil.ly/wDxvY"><code>Read</code></a> and <a href="https://oreil.ly/vJD1W"><code>Seek</code></a>, the latter of which is a word used in many programming languages<a data-primary="traits" data-secondary="indicating multiple trait bounds" data-type="indexterm" id="id1401"/><a data-primary="read head" data-type="indexterm" id="id1402"/><a data-primary="cursor, moving to position in a stream" data-type="indexterm" id="id1403"/> for moving what’s called a <em>cursor</em> or <em>read head</em> to a particular position in a stream.
For the following code, you will need to expand your imports to include <code>std::io::{BufRead, Read, Seek}</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">print_bytes</code><code class="o">&lt;</code><code class="n">T</code><code>:</code><code> </code><code class="nc">Read</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">Seek</code><code class="o">&gt;</code><code class="p">(</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO12-1" id="co_tailor_swyfte_CO12-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code>:</code><code> </code><code class="nc">T</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO12-2" id="co_tailor_swyfte_CO12-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">num_bytes</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO12-3" id="co_tailor_swyfte_CO12-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="n">total_bytes</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO12-4" id="co_tailor_swyfte_CO12-4"><img alt="4" src="assets/4.png"/></a><code class="w">
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="fm">unimplemented!</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO12-1" id="callout_tailor_swyfte_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The generic type <code>T</code> has the trait bounds <code>Read</code> and <code>Seek</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO12-2" id="callout_tailor_swyfte_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>file</code> argument must implement the indicated traits.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO12-3" id="callout_tailor_swyfte_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>num_bytes</code> argument is a <code>TakeValue</code> describing the byte selection.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO12-4" id="callout_tailor_swyfte_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>total_bytes</code> argument is the file size in bytes.<a data-primary="trait bounds" data-type="indexterm" id="id1404"/></p></dd>
</dl>

<p>I can also write the generic types and bounds using a <a href="https://oreil.ly/aM1vI"><code>where</code> clause</a>, which <a data-primary="where clause" data-type="indexterm" id="id1405"/>you might find more readable:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">print_bytes</code><strong><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code></strong><code class="p">(</code><code class="w">
</code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code>:</code><code> </code><code class="nc">T</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">num_bytes</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">total_bytes</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">,</code><code class="w">
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w">
</code><strong><code class="k">where</code></strong><code class="w">
</code><code class="w">    </code><strong><code class="n">T</code><code>:</code><code> </code><code class="nc">Read</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">Seek</code><code class="p">,</code></strong><code class="w">
</code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="fm">unimplemented!</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>

<p>You can use the <code>get_start_index</code> function to <a data-primary="get_start_index function" data-type="indexterm" id="id1406"/>find the starting byte position from 
<span class="keep-together">the beginning</span> of the file, and then move the cursor to that position.
Remember 
<span class="keep-together">that the selected</span> byte string may contain invalid UTF-8, so my solution uses <a href="https://oreil.ly/Bs4Zl"><code>String::from_utf8_lossy</code></a> when printing the selected bytes.<a data-primary="String::from_utf8_lossy function" data-type="indexterm" id="id1407"/></p>
</div></section>








<section data-pdf-bookmark="Testing the Program with Large Input Files" data-type="sect2"><div class="sect2" id="id115">
<h2>Testing the Program with Large Input Files</h2>

<p>I have included a program in the <em>util/biggie</em> directory of my repository that will generate large input text files that you can use to stress test your program.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="testing program with large input files" data-type="indexterm" id="id1408"/><a data-primary="input files" data-secondary="large, using to test tailr" data-type="indexterm" id="id1409"/>
For instance, you can use it to create a file with a million lines of random text to use when selecting various ranges of lines and bytes.
Here is <a data-primary="biggie program" data-type="indexterm" id="id1410"/>the usage for the <code>biggie</code> program:</p>

<pre data-type="programlisting">Make big text files

Usage: biggie [OPTIONS]

Options:
  -o, --outfile &lt;FILE&gt;  Output filename [default: out.txt]
  -l, --lines &lt;LINES&gt;   Number of lines [default: 100000]
  -h, --help            Print help
  -V, --version         Print version</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This should be enough hints for you to write a solution. There’s no hurry to finish the program. Sometimes you need to step away from a difficult problem for a day or more while your subconscious mind works. Come back when your solution passes <strong><code>cargo test</code></strong>.</p>
</div>
</div></section>
</div></section>






<section class="pagebreak-before less_space" data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="id206">
<h1>Solution</h1>

<p>I’ll walk you through how I arrived at a solution, which will incorporate several dependencies as follows:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">TakeValue</code>::<code class="o">*</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">anyhow</code>::<code class="p">{</code><code class="n">anyhow</code><code class="p">,</code><code class="w"> </code><code class="n">bail</code><code class="p">,</code><code class="w"> </code><code class="nb">Result</code><code class="p">};</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">clap</code>::<code class="n">Parser</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">once_cell</code>::<code class="n">sync</code>::<code class="n">OnceCell</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">regex</code>::<code class="n">Regex</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">fs</code>::<code class="n">File</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="n">io</code>::<code class="p">{</code><code class="n">BufRead</code><code class="p">,</code><code class="w"> </code><code class="n">BufReader</code><code class="p">,</code><code class="w"> </code><code class="n">Read</code><code class="p">,</code><code class="w"> </code><code class="n">Seek</code><code class="p">,</code><code class="w"> </code><code class="n">SeekFrom</code><code class="p">},</code><code class="w"/>
<code class="p">};</code><code class="w"/></pre>

<p>I suggested writing several intermediate functions in the first part of this chapter, so next I’ll show my versions that pass the unit tests I provided.</p>








<section data-pdf-bookmark="Counting All the Lines and Bytes in a File" data-type="sect2"><div class="sect2" id="id116">
<h2>Counting All the Lines and Bytes in a File</h2>

<p>I will start by showing my <code>count_lines_bytes</code> function to count all the lines and bytes in a file.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="counting total lines and bytes in a file" data-type="indexterm" id="id1411"/><a data-primary="counts" data-secondary="counting total lines and bytes in a file" data-type="indexterm" id="id1412"/><a data-primary="BufRead::read_line function" data-type="indexterm" id="id1413"/><a data-primary="BufRead::read_until function" data-type="indexterm" id="id1414"/><a data-primary="lines" data-secondary="counting total bytes in a file in tailr" data-type="indexterm" id="id1415"/><a data-primary="bytes" data-secondary="counting total in file using tailr" data-type="indexterm" id="id1416"/>
In previous programs, I have used <a href="https://oreil.ly/aJFkc"><code>BufRead::read_line</code></a>, which writes into a <code>String</code>.
In the following function, I use <a href="https://oreil.ly/7BJaH"><code>BufRead::read_until</code></a> to read raw bytes to avoid the cost of creating strings, which I don’t need:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">count_lines_bytes</code><code class="p">(</code><code class="n">filename</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="kt">i64</code><code class="p">,</code><code class="w"> </code><code class="kt">i64</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">File</code><code>::</code><code class="n">open</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-1" id="co_tailor_swyfte_CO13-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">num_lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-2" id="co_tailor_swyfte_CO13-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">num_bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">buf</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes_read</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_until</code><code class="p">(</code><code class="sc">b'\n'</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">buf</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-3" id="co_tailor_swyfte_CO13-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">bytes_read</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-4" id="co_tailor_swyfte_CO13-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="n">num_lines</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-5" id="co_tailor_swyfte_CO13-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="n">num_bytes</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="n">bytes_read</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="kt">i64</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-6" id="co_tailor_swyfte_CO13-6"><img alt="6" src="assets/6.png"/></a><code class="w">
        </code><code class="n">buf</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-7" id="co_tailor_swyfte_CO13-7"><img alt="7" src="assets/7.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="n">num_lines</code><code class="p">,</code><code class="w"> </code><code class="n">num_bytes</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO13-8" id="co_tailor_swyfte_CO13-8"><img alt="8" src="assets/8.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO13-1" id="callout_tailor_swyfte_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a mutable filehandle to read the given filename.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-2" id="callout_tailor_swyfte_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Initialize counters for the number of lines and bytes as well as a buffer for reading the lines.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-3" id="callout_tailor_swyfte_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Use <code>BufRead::read_until</code> to read bytes until a newline byte. This function returns the number of bytes that were read from the filehandle.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-4" id="callout_tailor_swyfte_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>When no bytes were read, exit the loop.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-5" id="callout_tailor_swyfte_CO13-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Increment the line count.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-6" id="callout_tailor_swyfte_CO13-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Increment the byte count. Note that <code>BufRead::read_until</code> returns a <code>usize</code> that must be cast to <code>i64</code> to add the value to the <code>num_bytes</code> tally.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-7" id="callout_tailor_swyfte_CO13-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Clear the buffer before reading the next line.<a data-primary="usize type" data-secondary="casting to i64" data-type="indexterm" id="id1417"/><a data-primary="i64 type" data-secondary="casting usize to" data-type="indexterm" id="id1418"/><a data-primary="tuples" data-secondary="containing number of lines and bytes in a file" data-type="indexterm" id="id1419"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO13-8" id="callout_tailor_swyfte_CO13-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Return a tuple containing the number of lines and bytes in the file.</p></dd>
</dl>
</div></section>








<section data-pdf-bookmark="Finding the Start Index" data-type="sect2"><div class="sect2" id="id117">
<h2>Finding the Start Index</h2>

<p>To find the starting line or byte position, my program relies on a <code>get_start_index</code> function that <a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="finding start index" data-type="indexterm" id="id1420"/><a data-primary="get_start_index function" data-type="indexterm" id="id1421"/>uses the desired location and the total number of lines or bytes in the file:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">get_start_index</code><code class="p">(</code><code class="n">take_val</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w"> </code><code class="n">total</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u64</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">take_val</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="n">PlusZero</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">total</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO14-1" id="co_tailor_swyfte_CO14-1"><img alt="1" src="assets/1.png"/></a><code class="w">
                </code><code class="nb">Some</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="nb">None</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="n">TakeNum</code><code class="p">(</code><code class="n">num</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="mi">0</code><code class="w"> </code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">total</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="o">&amp;</code><code class="n">total</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO14-2" id="co_tailor_swyfte_CO14-2"><img alt="2" src="assets/2.png"/></a><code class="w">
                </code><code class="nb">None</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="o">&amp;</code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">total</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">-</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="p">}</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO14-3" id="co_tailor_swyfte_CO14-3"><img alt="3" src="assets/3.png"/></a><code class="w">
                </code><code class="nb">Some</code><code class="p">(</code><code class="k">if</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="kt">u64</code><code class="w"> </code><code class="p">}</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO14-4" id="co_tailor_swyfte_CO14-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO14-1" id="callout_tailor_swyfte_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>When the user wants to start at index <code>0</code>, return <code>0</code> if the file is not empty; otherwise, return <code>None</code>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO14-2" id="callout_tailor_swyfte_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Return <code>None</code> if the user wants to select nothing, the file is empty, or the user wants to select more data than is available in the file.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO14-3" id="callout_tailor_swyfte_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>If the desired number of lines or bytes is negative, add it to the total; otherwise, subtract one from the desired number to get the zero-based offset.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO14-4" id="callout_tailor_swyfte_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>If the starting index is less than <code>0</code>, return <code>0</code>; otherwise, return the starting index as a <code>u64</code>.</p></dd>
</dl>
</div></section>








<section data-pdf-bookmark="Printing the Lines" data-type="sect2"><div class="sect2" id="id118">
<h2>Printing the Lines</h2>

<p>The following is my <code>print_lines</code> function, much <a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="printing the lines" data-type="indexterm" id="id1422"/><a data-primary="lines" data-secondary="printing in tailr" data-type="indexterm" id="id1423"/><a data-primary="print_lines function" data-type="indexterm" id="id1424"/>of which is similar to <code>count_lines_bytes</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">print_lines</code><code class="p">(</code><code class="w">
</code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code>:</code><code> </code><code class="nc">impl</code><code class="w"> </code><code class="n">BufRead</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">num_lines</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">total_lines</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">,</code><code class="w">
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">start</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_start_index</code><code class="p">(</code><code class="n">num_lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_lines</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO15-1" id="co_tailor_swyfte_CO15-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">line_num</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO15-2" id="co_tailor_swyfte_CO15-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">buf</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes_read</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_until</code><code class="p">(</code><code class="sc">b'\n'</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">buf</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">bytes_read</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">line_num</code><code class="w"> </code><code class="o">&gt;</code><code class="o">=</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO15-3" id="co_tailor_swyfte_CO15-3"><img alt="3" src="assets/3.png"/></a><code class="w">
                </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8_lossy</code><code class="p">(</code><code class="o">&amp;</code><code class="n">buf</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO15-4" id="co_tailor_swyfte_CO15-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="n">line_num</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="n">buf</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO15-1" id="callout_tailor_swyfte_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Check if there is a valid starting position when trying to read the given number of lines from the total number of lines available.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO15-2" id="callout_tailor_swyfte_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Initialize variables for counting and reading lines from the file.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO15-3" id="callout_tailor_swyfte_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Check if the given line is at or beyond the starting point.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO15-4" id="callout_tailor_swyfte_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>If so, convert the bytes to a string and print.</p></dd>
</dl>

<p>Here is how I can integrate this into my <code>run</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="n">args</code><code class="p">.</code><code class="n">lines</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal line count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">_bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">args</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">bytes</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">parse_num</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">transpose</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal byte count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">File</code><code>::</code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"</code><code class="s">{filename}: {err}</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">total_lines</code><code class="p">,</code><code class="w"> </code><code class="n">_total_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">                    </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO16-1" id="co_tailor_swyfte_CO16-1"><img alt="1" src="assets/1.png"/></a><code class="w">
                </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO16-2" id="co_tailor_swyfte_CO16-2"><img alt="2" src="assets/2.png"/></a><code class="w">
                </code><code class="n">print_lines</code><code class="p">(</code><code class="n">file</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_lines</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO16-3" id="co_tailor_swyfte_CO16-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO16-1" id="callout_tailor_swyfte_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Count the total lines and bytes in the current file.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO16-2" id="callout_tailor_swyfte_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create a <code>BufReader</code> with the opened filehandle.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO16-3" id="callout_tailor_swyfte_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Print the requested number of lines.<a data-primary="BufReader struct" data-type="indexterm" id="id1425"/></p></dd>
</dl>

<p>A quick check shows this will select, for instance, the last five lines:</p>

<pre data-type="programlisting">$ cargo run -- -n 5 tests/inputs/twelve.txt
eight
nine
ten
eleven
twelve</pre>

<p>I can get the same output by starting on the eighth line:</p>

<pre data-type="programlisting">$ cargo run -- -n +8 tests/inputs/twelve.txt
eight
nine
ten
eleven
twelve</pre>

<p>If I run <strong><code>cargo test</code></strong> at this point, I pass more than two-thirds of the tests.</p>
</div></section>








<section class="pagebreak-before less_space" data-pdf-bookmark="Printing the Bytes" data-type="sect2"><div class="sect2" id="id119">
<h2>Printing the Bytes</h2>

<p>Next, I will show <a data-primary="bytes" data-secondary="printing in tailr" data-type="indexterm" id="id1426"/><a data-primary="print_bytes function" data-type="indexterm" id="id1427"/><a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="printing the bytes" data-type="indexterm" id="id1428"/>my <code>print_bytes</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">print_bytes</code><code class="o">&lt;</code><code class="n">T</code><code>:</code><code> </code><code class="nc">Read</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">Seek</code><code class="o">&gt;</code><code class="p">(</code><code class="w">
</code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code>:</code><code> </code><code class="nc">T</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">num_bytes</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">TakeValue</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">total_bytes</code><code>:</code><code> </code><code class="kt">i64</code><code class="p">,</code><code class="w">
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">start</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_start_index</code><code class="p">(</code><code class="n">num_bytes</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO17-1" id="co_tailor_swyfte_CO17-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="n">file</code><code class="p">.</code><code class="n">seek</code><code class="p">(</code><code class="n">SeekFrom</code><code>::</code><code class="n">Start</code><code class="p">(</code><code class="n">start</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO17-2" id="co_tailor_swyfte_CO17-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">buffer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO17-3" id="co_tailor_swyfte_CO17-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="n">file</code><code class="p">.</code><code class="n">read_to_end</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">buffer</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO17-4" id="co_tailor_swyfte_CO17-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">buffer</code><code class="p">.</code><code class="n">is_empty</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8_lossy</code><code class="p">(</code><code class="o">&amp;</code><code class="n">buffer</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO17-5" id="co_tailor_swyfte_CO17-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO17-1" id="callout_tailor_swyfte_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>See if there is a valid starting byte position.<a data-primary="Seek::seek function" data-type="indexterm" id="id1429"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO17-2" id="callout_tailor_swyfte_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/ki8DT"><code>Seek::seek</code></a> to move to the desired byte position as defined by <a href="https://oreil.ly/Bi8Bp"><code>SeekFrom::Start</code></a>.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO17-3" id="callout_tailor_swyfte_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Create a mutable buffer for reading the bytes.<a data-primary="SeekFrom::Start" data-type="indexterm" id="id1430"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO17-4" id="callout_tailor_swyfte_CO17-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Read from the byte position to the end of the file and place the results into the buffer.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO17-5" id="callout_tailor_swyfte_CO17-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>If the buffer is not empty, convert the selected bytes to a <code>String</code> and print.<a data-primary="String type" data-secondary="converting selected bytes to" data-type="indexterm" id="id1431"/></p></dd>
</dl>

<p>Here’s how I integrated this into the <code>run</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="n">args</code><code class="p">.</code><code class="n">lines</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal line count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">args</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">bytes</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">parse_num</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">transpose</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal byte count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">File</code><code>::</code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"</code><code class="s">{filename}: {err}</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">total_lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">                    </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">num_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">bytes</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO18-1" id="co_tailor_swyfte_CO18-1"><img alt="1" src="assets/1.png"/></a><code class="w">
                    </code><code class="n">print_bytes</code><code class="p">(</code><code class="n">file</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">num_bytes</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO18-2" id="co_tailor_swyfte_CO18-2"><img alt="2" src="assets/2.png"/></a><code class="w">
                </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                    </code><code class="n">print_lines</code><code class="p">(</code><code class="n">file</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_lines</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO18-3" id="co_tailor_swyfte_CO18-3"><img alt="3" src="assets/3.png"/></a><code class="w">
                </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO18-1" id="callout_tailor_swyfte_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Check if the user has requested a byte selection.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO18-2" id="callout_tailor_swyfte_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>If so, print the selected bytes.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO18-3" id="callout_tailor_swyfte_CO18-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Otherwise, print the line selection.</p></dd>
</dl>

<p>A quick check with <strong><code>cargo test</code></strong> shows I’m inching ever closer to passing all my tests.
All the failing tests start with <em>multiple</em>, and they are failing because my program is not printing the headers separating the output from each file.
I’ll modify the code from <a data-type="xref" href="ch04.html#ch04">Chapter 4</a> for this where we did something similar.
Here is my final <code>run</code> function <a data-primary="run function" data-secondary="final version for tailr" data-type="indexterm" id="id1432"/>that will pass all the tests:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_num</code><code class="p">(</code><code class="n">args</code><code class="p">.</code><code class="n">lines</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal line count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">args</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">bytes</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">parse_num</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">transpose</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">illegal byte count -- {e}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">num_files</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO19-1" id="co_tailor_swyfte_CO19-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">file_num</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">files</code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">enumerate</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO19-2" id="co_tailor_swyfte_CO19-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="k">match</code><code class="w"> </code><code class="n">File</code><code>::</code><code class="n">open</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"</code><code class="s">{filename}: {err}</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">args</code><code class="p">.</code><code class="n">quiet</code><code class="w"> </code><code class="o">&amp;</code><code class="o">&amp;</code><code class="w"> </code><code class="n">num_files</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_tailor_swyfte_CO19-3" id="co_tailor_swyfte_CO19-3"><img alt="3" src="assets/3.png"/></a><code class="w">
                    </code><code class="fm">println!</code><code class="p">(</code><code class="w">
</code><code class="w">                        </code><code class="s">"</code><code class="s">{}==&gt; {filename} &lt;==</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                        </code><code class="k">if</code><code class="w"> </code><code class="n">file_num</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="p">,</code><code class="w">
</code><code class="w">                    </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">total_lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">count_lines_bytes</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">num_bytes</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">bytes</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                    </code><code class="n">print_bytes</code><code class="p">(</code><code class="n">file</code><code class="p">,</code><code class="w"> </code><code class="n">num_bytes</code><code class="p">,</code><code class="w"> </code><code class="n">total_bytes</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                    </code><code class="n">print_lines</code><code class="p">(</code><code class="n">file</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">lines</code><code class="p">,</code><code class="w"> </code><code class="n">total_lines</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">                </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO19-1" id="callout_tailor_swyfte_CO19-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Find the number of files.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO19-2" id="callout_tailor_swyfte_CO19-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Use <code>Iterator::enumerate</code> to iterate through the index positions and filenames.<a data-primary="Iterator::enumerate function" data-type="indexterm" id="id1433"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO19-3" id="callout_tailor_swyfte_CO19-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>If the <code>quiet</code> option is <code>false</code> and there are multiple files, print the header.<a data-primary="quiet option (tailr)" data-type="indexterm" id="id1434"/></p></dd>
</dl>
</div></section>








<section data-pdf-bookmark="Benchmarking the Solution" data-type="sect2"><div class="sect2" id="id120">
<h2>Benchmarking the Solution</h2>

<p>How does the <code>tailr</code> program compare to <code>tail</code> for the subset of features it shares?<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="benchmarking the solution" data-type="indexterm" id="id1435"/><a data-primary="benchmarking" data-secondary="comparing tail and tailr performance" data-type="indexterm" id="id1436"/>
I suggested earlier that you could use the <code>biggie</code> program to create large input files to test your program.<a data-primary="biggie program" data-type="indexterm" id="id1437"/>
I created a file called <em>1M.txt</em> that has one million lines of randomly generated text to use in testing my program.<a data-primary="time command" data-type="indexterm" id="id1438"/>
I can use the <code>time</code> command to see how long it takes for <code>tail</code> to find the last 10 lines of the <em>1M.txt</em> file:<sup><a data-type="noteref" href="ch11.html#id1439" id="id1439-marker">2</a></sup></p>

<pre data-type="programlisting">$ time tail 1M.txt &gt; /dev/null <a class="co" href="#callout_tailor_swyfte_CO20-1" id="co_tailor_swyfte_CO20-1"><img alt="1" src="assets/1.png"/></a>

real    0m0.022s <a class="co" href="#callout_tailor_swyfte_CO20-2" id="co_tailor_swyfte_CO20-2"><img alt="2" src="assets/2.png"/></a>
user    0m0.006s <a class="co" href="#callout_tailor_swyfte_CO20-3" id="co_tailor_swyfte_CO20-3"><img alt="3" src="assets/3.png"/></a>
sys     0m0.015s <a class="co" href="#callout_tailor_swyfte_CO20-4" id="co_tailor_swyfte_CO20-4"><img alt="4" src="assets/4.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_tailor_swyfte_CO20-1" id="callout_tailor_swyfte_CO20-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>I don’t want to see the output from the command, so I redirect it to <code>/dev/null</code>, a special system device that ignores its input.</p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO20-2" id="callout_tailor_swyfte_CO20-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>real</code> time is <em>wall clock time</em>, measuring how long the process took from start to finish.<a data-primary="real time" data-type="indexterm" id="id1440"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO20-3" id="callout_tailor_swyfte_CO20-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>user</code> time is how long the CPU spent in <em>user</em> mode outside the kernel.<a data-primary="user time" data-type="indexterm" id="id1441"/><a data-primary="sys time" data-type="indexterm" id="id1442"/></p></dd>
<dt><a class="co" href="#co_tailor_swyfte_CO20-4" id="callout_tailor_swyfte_CO20-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>sys</code> time is how long the CPU spent working inside the kernel.</p></dd>
</dl>

<p>I want to build the fastest version of <code>tailr</code> possible to <a data-primary="release build, creating for tailr" data-type="indexterm" id="id1443"/>compare to <code>tail</code>, so I’ll use <strong><code>cargo build --release</code></strong> to create a <a href="https://oreil.ly/A9BMw">release build</a>.
The binary will be created at <em>target​/⁠release/tailr</em>.
This build of the program appears to be much slower than <code>tail</code>:</p>

<pre data-type="programlisting">$ time target/release/tailr 1M.txt &gt; /dev/null

real    0m0.505s
user    0m0.072s
sys     0m0.024s</pre>

<p>This is the start of a process called <em>benchmarking</em>, where I try to compare how well different programs work.<a data-primary="benchmarking" data-type="indexterm" id="id1444"/>
Running one iteration and eyeballing the output is not very scientific or effective.
Luckily, there is a Rust crate called <a href="https://oreil.ly/ICXBY"><code>hyperfine</code></a> that can do this much better.<a data-primary="hyperfine crate" data-type="indexterm" id="id1445"/>
After installing it with <strong><code>cargo install hyperfine</code></strong>, I can run benchmarks and find that my Rust program is much slower than the system <code>tail</code> when printing the last 10 lines from the <em>1M.txt</em> file:</p>

<pre data-type="programlisting">$ hyperfine -i -L prg tail,target/release/tailr '{prg} 1M.txt &gt; /dev/null'
Benchmark 1: tail 1M.txt &gt; /dev/null
  Time (mean ± σ):       4.3 ms ±   6.6 ms    [User: 1.7 ms, System: 3.2 ms]
  Range (min … max):     2.6 ms …  49.9 ms    50 runs

Benchmark 2: target/release/tailr 1M.txt &gt; /dev/null
  Time (mean ± σ):      86.9 ms ±   3.2 ms    [User: 70.2 ms, System: 16.5 ms]
  Range (min … max):    84.8 ms … 100.5 ms    27 runs

Summary
  tail 1M.txt &gt; /dev/null ran
   20.32 ± 31.44 times faster than target/release/tailr 1M.txt &gt; /dev/null</pre>

<p>If I request the last 100K lines, however, the Rust version fares better:</p>

<pre data-type="programlisting">$ hyperfine -i -L prg tail,target/release/tailr '{prg} -n 100000 1M.txt
  &gt; /dev/null'
Benchmark 1: tail -n 100000 1M.txt &gt; /dev/null
  Time (mean ± σ):      26.8 ms ±   0.5 ms    [User: 19.8 ms, System: 5.4 ms]
  Range (min … max):    25.9 ms …  28.9 ms    82 runs

Benchmark 2: target/release/tailr -n 100000 1M.txt &gt; /dev/null
  Time (mean ± σ):     154.7 ms ±   1.4 ms    [User: 108.1 ms, System: 43.8 ms]
  Range (min … max):   153.4 ms … 158.1 ms    18 runs

Summary
  tail -n 100000 1M.txt &gt; /dev/null ran
    5.78 ± 0.12 times faster than target/release/tailr -n 100000 1M.txt
    &gt; /dev/null</pre>

<p>If I change the command to <code>{prg} -c 100 1M.txt</code> to print the last 100 bytes, the Rust version is still slower:</p>

<pre data-type="programlisting">Summary
  tail -c 100 1M.txt ran
   14.98 ± 2.51 times faster than target/release/tailr -c 100 1M.txt</pre>

<p class="pagebreak-before">If I request the last million bytes, however, the Rust version is a little faster:</p>

<pre data-type="programlisting">Summary
  target/release/tailr -c 1000000 1M.txt ran
    1.34 ± 0.04 times faster than tail -c 1000000 1M.txt</pre>

<p>To improve the performance, the next step would probably be profiling the code to find where Rust is using most of the time and memory.
Program optimization is a fascinating and deep topic well beyond the scope of this book.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Going Further" data-type="sect1"><div class="sect1" id="id159">
<h1>Going Further</h1>

<p>See how many of the BSD and GNU options you can implement, including the size suffixes and reading <code>STDIN</code>.<a data-primary="tail utility" data-secondary="writing tailr version" data-tertiary="going further" data-type="indexterm" id="id1446"/>
One of the more challenging options is to <em>follow</em> the files.
When I’m developing web applications, I often use <code>tail -f</code> to watch the access and error logs of a web server to see requests and responses as they happen.
I suggest you <a href="https://oreil.ly/Lo6rG">search <em>crates.io</em> for “tail”</a> to see how others have implemented these ideas.</p>
</div></section>






<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id121">
<h1>Summary</h1>

<p>Reflect upon your progress in this chapter:</p>

<ul>
<li>
<p>You learned how to create a regular expression as a static, global variable using the <code>once_cell</code> crate.</p>
</li>
<li>
<p>You learned how to seek a line or byte position in a filehandle.</p>
</li>
<li>
<p>You saw how to indicate multiple trait bounds like <code>&lt;T: Read + Seek&gt;</code> and also how to write this using <code>where</code>.</p>
</li>
<li>
<p>You learned how to make Cargo build a release binary.</p>
</li>
<li>
<p>You used <code>hyperfine</code> to benchmark programs.<a data-primary="tail utility" data-startref="ix_tail" data-type="indexterm" id="id1447"/></p>
</li>
</ul>

<p>In the next chapter, you will learn how to use and control pseudorandom number generators to make random selections.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id1361"><sup><a href="ch11.html#id1361-marker">1</a></sup> The <em>range</em> here means all the characters between those two code points. Refer to the output from the <code>ascii</code> program in <a data-type="xref" href="ch10.html#ch10">Chapter 10</a> to see that the contiguous values from 0 to 9 are all numbers. Contrast this with the values from <em>A</em> to <em>z</em> where various punctuation characters fall in the middle, which is why you will often see the range <code>[A-Za-z]</code> to select ASCII alphabet characters.</p><p data-type="footnote" id="id1439"><sup><a href="ch11.html#id1439-marker">2</a></sup> I used macOS 14.2.1 running on a MacBook Pro M1 with 8 cores and 8 GB RAM for all the benchmarking tests.</p></div></div></section></body></html>