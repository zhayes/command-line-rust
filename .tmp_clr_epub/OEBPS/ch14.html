<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head><title>Elless Island</title><link href="epub.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e80a1ec8-ed8e-40f7-ba3d-26a647960341" name="Adept.expected.resource"/></head><body data-type="book"><section data-pdf-bookmark="Chapter 14. Elless Island" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch14">
<h1><span class="label">Chapter 14. </span>Elless Island</h1>

<blockquote>
<p>
Now you know that the girls are just making it up<br/>
Now you know that the boys are just pushing their luck<br/>
Now you know that my ride doesn’t really exist<br/>
And my name’s not really on that list
</p>
<p data-type="attribution">
They Might Be Giants, “Prevenge” (2004)
</p>
</blockquote>

<p>In this final chapter, you’ll create<a data-primary="ls utility" data-type="indexterm" id="ix_ls"/> a Rust clone of the <em>list</em> command, <code>ls</code> (pronounced <em>ell-ess</em>), which I think is perhaps the hardest-working program in Unix.
I use it many times every day to view the contents of a directory or inspect the size or permissions of some files.<a data-primary="list command" data-see="ls utility" data-type="indexterm" id="id1677"/>
The original program has more than three dozen options, but the challenge program will implement only a few features, such as printing the contents of directories or lists of files along with their permissions, sizes, and modification times.
Note that this challenge program relies on ideas of files and ownership that are specific to Unix and so will not work on Windows.<a data-primary="Unix" data-secondary="ls command and ideas of files and ownership" data-type="indexterm" id="id1678"/>
I suggest Windows users install Windows Subsystem for Linux to write and test the program in that environment.<a data-primary="Windows Subsystem for Linux" data-type="indexterm" id="id1679"/></p>

<p>In this chapter, you will learn how to do the following:</p>

<ul>
<li>
<p>Query and visually represent a file’s permissions</p>
</li>
<li>
<p>Add a method to a custom type using an implementation</p>
</li>
<li>
<p>Create a module in a separate file to organize code</p>
</li>
<li>
<p>Use text tables to create aligned columns of output</p>
</li>
<li>
<p>Create documentation comments</p>
</li>
</ul>






<section data-pdf-bookmark="How ls Works" data-type="sect1"><div class="sect1" id="id139">
<h1>How ls Works</h1>

<p>To see what will be expected of the challenge program, start by looking at the manual page for the BSD <code>ls</code>.<a data-primary="ls utility" data-secondary="how it works" data-type="indexterm" id="ix_lshow"/>
You’ll see that it has 39 options.<a data-primary="BSD version" data-secondary="ls utility" data-type="indexterm" id="id1680"/>
I’ll include only the first part, as the documentation is rather long, but I encourage you to read the whole thing:</p>

<pre data-type="programlisting">LS(1)                     BSD General Commands Manual                    LS(1)

NAME
     ls -- list directory contents

SYNOPSIS
     ls [-ABCFGHLOPRSTUW@abcdefghiklmnopqrstuwx1%] [file ...]

DESCRIPTION
     For each operand that names a file of a type other than directory, ls
     displays its name as well as any requested, associated information.  For
     each operand that names a file of type directory, ls displays the names
     of files contained within that directory, as well as any requested, asso-
     ciated information.

     If no operands are given, the contents of the current directory are dis-
     played.  If more than one operand is given, non-directory operands are
     displayed first; directory and non-directory operands are sorted sepa-
     rately and in lexicographical order.</pre>

<p>If you execute <code>ls</code> with no options, it will show you the contents of the current working directory.<a data-primary="ls utility" data-secondary="executed with no options" data-type="indexterm" id="id1681"/>
For instance, change into the <em>14_lsr</em> directory and try it:</p>

<pre data-type="programlisting">$ cd 14_lsr
$ ls
Cargo.toml         set-test-perms.sh* src/               tests/</pre>

<p>The challenge program will implement only two option flags, the <code>-l|--long</code> and 
<span class="keep-together"><code>-a|--all</code></span> options.<a data-primary="-l|--long option flag (ls)" data-primary-sortas="l|" data-type="indexterm" id="id1682"/><a data-primary="-a|--all option flag (ls)" data-primary-sortas="a|" data-type="indexterm" id="id1683"/><a data-primary="long format" data-secondary="ls -l command" data-type="indexterm" id="id1684"/>
Per the manual page:</p>

<pre data-type="programlisting">The Long Format
 If the -l option is given, the following information is displayed for
 each file: file mode, number of links, owner name, group name, number of
 bytes in the file, abbreviated month, day-of-month file was last modi-
 fied, hour file last modified, minute file last modified, and the path-
 name.  In addition, for each directory whose contents are displayed, the
 total number of 512-byte blocks used by the files in the directory is
 displayed on a line by itself, immediately before the information for the
 files in the directory.</pre>

<p>Execute <strong><code>ls -l</code></strong> in the source directory.
Of course, you will have different metadata, such as owners and modification times, than what I’m showing:</p>

<pre class="nobreakinside" data-type="programlisting">$ ls -l
total 16
-rw-r--r--  1 kyclark  staff  217 Aug 11 08:26 Cargo.toml
-rwxr-xr-x  1 kyclark  staff  447 Aug 12 17:56 set-test-perms.sh*
drwxr-xr-x  5 kyclark  staff  160 Aug 26 09:44 src/
drwxr-xr-x  4 kyclark  staff  128 Aug 17 08:42 tests/</pre>

<p>The <code>-a</code> <em>all</em> option will show entries that are normally hidden.<a data-primary="-a|--all option flag (ls)" data-primary-sortas="a|" data-type="indexterm" id="id1685"/>
For example, the current directory <code>.</code> and the parent directory <code>..</code> are not usually shown:</p>

<pre data-type="programlisting">$ ls -a
./                 Cargo.toml         src/
../                set-test-perms.sh* tests/</pre>

<p>You can specify these individually, like <strong><code>ls -a -l</code></strong>, or combined, like <strong><code>ls -la</code></strong>.
These flags can occur in any order, so <code>-la</code> or <code>-al</code> will work:</p>

<pre data-type="programlisting">$ ls -la
total 16
drwxr-xr-x   6 kyclark  staff  192 Oct 15 07:52 ./
drwxr-xr-x  24 kyclark  staff  768 Aug 24 08:22 ../
-rw-r--r--   1 kyclark  staff  217 Aug 11 08:26 Cargo.toml
-rwxr-xr-x   1 kyclark  staff  447 Aug 12 17:56 set-test-perms.sh*
drwxr-xr-x   5 kyclark  staff  160 Aug 26 09:44 src/
drwxr-xr-x   4 kyclark  staff  128 Aug 17 08:42 tests/</pre>
<div data-type="tip"><h6>Tip</h6>
<p>Any entry (directory or file) with a name starting with a dot (<code>.</code>) is hidden, leading to the existence of so-called <em>dotfiles</em>, which are often used to store program state and metadata.<a data-primary=". (dot)" data-secondary="file or directory names starting with" data-type="indexterm" id="id1686"/><a data-primary="dotfiles" data-type="indexterm" id="id1687"/> For example, the root directory of the source code repository contains a directory called <em>.git</em> that has all the information Git needs to keep track of the changes to files. It’s also common to create <em>.gitignore</em> files that contain filenames and globs that you wish to exclude from Git.</p>
</div>

<p>You can provide <a data-primary="directories" data-secondary="viewing contents with ls command" data-type="indexterm" id="id1688"/>the name of one or more directories as positional arguments to see their contents:</p>

<pre data-type="programlisting">$ ls src/ tests/
src/:
main.rs   owner.rs

tests/:
cli.rs	inputs</pre>

<p>The positional arguments can also be files:</p>

<pre class="nobreakinside" data-type="programlisting">$ ls -l src/*.rs
-rw-r--r--  1 kyclark  staff  8959 Feb 25 12:09 src/main.rs
-rw-r--r--  1 kyclark  staff   313 Feb 25 12:03 src/owner.rs</pre>

<p>Different operating systems will return the files in different orders.
For example, the <em>.hidden</em> file is shown <a data-primary="hidden files" data-type="indexterm" id="id1689"/><a data-primary="macOS" data-secondary=".hidden file" data-secondary-sortas="hidden" data-type="indexterm" id="id1690"/>before all the other files on macOS:</p>

<pre data-type="programlisting">$ ls -la tests/inputs/
total 16
drwxr-xr-x  7 kyclark  staff  224 Aug 12 10:29 ./
drwxr-xr-x  4 kyclark  staff  128 Aug 17 08:42 ../
<strong>-rw-r--r--  1 kyclark  staff    0 Mar 19  2021 .hidden</strong>
-rw-r--r--  1 kyclark  staff  193 May 31 16:43 bustle.txt
drwxr-xr-x  4 kyclark  staff  128 Aug 10 18:08 dir/
-rw-r--r--  1 kyclark  staff    0 Mar 19  2021 empty.txt
-rw-------  1 kyclark  staff   45 Aug 12 10:29 fox.txt</pre>

<p>On Linux, the <em>.hidden</em> file is<a data-primary="Linux" data-secondary=".hidden file" data-secondary-sortas="hidden" data-type="indexterm" id="id1691"/> listed last:</p>

<pre data-type="programlisting">$ ls -la tests/inputs/
total 20
drwxr-xr-x. 3 kyclark staff 4096 Aug 21 12:13 ./
drwxr-xr-x. 3 kyclark staff 4096 Aug 21 12:13 ../
-rw-r--r--. 1 kyclark staff  193 Aug 21 12:13 bustle.txt
drwxr-xr-x. 2 kyclark staff 4096 Aug 21 12:13 dir/
-rw-r--r--. 1 kyclark staff    0 Aug 21 12:13 empty.txt
-rw-------. 1 kyclark staff   45 Aug 21 12:13 fox.txt
<strong>-rw-r--r--. 1 kyclark staff    0 Aug 21 12:13 .hidden</strong></pre>
<div data-type="tip"><h6>Tip</h6>
<p>Due to these differences, the tests will not check for any particular ordering.</p>
</div>

<p>Notice that errors involving nonexistent files are printed first, and then the results for valid arguments.<a data-primary="files" data-secondary="invalid or unreadable, handling by ls" data-type="indexterm" id="id1692"/>
As usual, <em>blargh</em> is meant as a nonexistent file:</p>

<pre data-type="programlisting">$ ls Cargo.toml <strong>blargh</strong> src/main.rs
<strong>ls: blargh: No such file or directory</strong>
Cargo.toml   src/main.rs</pre>

<p>This is about as much as the challenge program should implement.
A version of <code>ls</code> dates back to the original AT&amp;T Unix, and both the BSD and GNU versions have had decades to evolve.
The challenge program won’t even scratch the surface of replacing <code>ls</code>, but it will give you a chance to consider some really interesting aspects of operating systems and information storage.<a data-primary="ls utility" data-secondary="how it works" data-startref="ix_lshow" data-type="indexterm" id="id1693"/></p>
</div></section>






<section data-pdf-bookmark="Getting Started" data-type="sect1"><div class="sect1" id="id140">
<h1>Getting Started</h1>

<p>The challenge program should be named <code>lsr</code> (pronounced <em>lesser</em> or <em>lister</em>, maybe) for a Rust version of <code>ls</code>.<a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="getting started" data-type="indexterm" id="id1694"/>
I suggest you start by running <strong><code>cargo new lsr</code></strong>.
My solution will use the following dependencies that you should add to your <em>Cargo.toml</em>:</p>

<pre data-code-language="toml" data-type="programlisting"><code class="k">[</code><code class="k">dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">anyhow</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.0.79</code><code class="s2">"</code><code class="w">
</code><code class="n">chrono</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.4.31</code><code class="s2">"</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO1-1" id="co_elless_island_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">
</code><code class="n">clap</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">version</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">4.5.0</code><code class="s2">"</code><code class="p">,</code><code class="w"> </code><code class="n">features</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"</code><code class="s2">derive</code><code class="s2">"</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">
</code><code class="n">tabular</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.2.0</code><code class="s2">"</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO1-2" id="co_elless_island_CO1-2"><img alt="2" src="assets/2.png"/></a><code class="w">
</code><code class="n">users</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.11.0</code><code class="s2">"</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO1-3" id="co_elless_island_CO1-3"><img alt="3" src="assets/3.png"/></a><code class="w">

</code><code class="k">[</code><code class="k">dev-dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">assert_cmd</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">2.0.13</code><code class="s2">"</code><code class="w">
</code><code class="n">predicates</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">3.0.4</code><code class="s2">"</code><code class="w">
</code><code class="n">pretty_assertions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.4.0</code><code class="s2">"</code><code class="w">
</code><code class="n">rand</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.8.5</code><code class="s2">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO1-1" id="callout_elless_island_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>chrono</code> will be used to<a data-primary="chrono crate" data-type="indexterm" id="id1695"/> handle the file modification times.<a data-primary="tabular crate" data-type="indexterm" id="id1696"/><a data-primary="users" data-type="indexterm" id="id1697"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO1-2" id="callout_elless_island_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>tabular</code> will be used to present a text table for the long listing.</p></dd>
<dt><a class="co" href="#co_elless_island_CO1-3" id="callout_elless_island_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>users</code> will be used to get the user and group names of the owners.</p></dd>
</dl>

<p>Copy <em>14_lsr/tests</em> into your project, and then run <strong><code>cargo test</code></strong> to build and test your program.<a data-primary="testing" data-secondary="tests for lsr" data-type="indexterm" id="id1698"/>
All the tests should fail.
Next, you must run the <code>bash</code> script <em>14_lsr/set-test​-⁠perms.sh</em> to set the file and directory permissions of the test inputs to known values.
Run with <code>-h|--help</code> for usage:</p>

<pre data-type="programlisting">$ ./set-test-perms.sh --help
Usage: set-test-perms.sh DIR</pre>

<p>You should give it the path to your new <code>lsr</code>.
For instance, if you create the project under <em>~/rust-solutions/lsr</em>, run it like so:</p>

<pre data-type="programlisting">$ ./set-test-perms.sh ~/rust-solutions/lsr
Done, fixed files in "/Users/kyclark/rust-solutions/lsr".</pre>








<section data-pdf-bookmark="Defining the Arguments" data-type="sect2"><div class="sect2" id="id141">
<h2>Defining the Arguments</h2>

<p>I suggest you update <em>src/main.rs</em> to add the<a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="defining the arguments" data-type="indexterm" id="ix_lswrdefarg"/> following struct for the program’s 
<span class="keep-together">arguments</span>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">derive(Debug)</code><code class="cp">]</code><code class="w">
</code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code><code> </code><code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">paths</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO2-1" id="co_elless_island_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">long</code><code>:</code><code> </code><code class="kt">bool</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO2-2" id="co_elless_island_CO2-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">show_hidden</code><code>:</code><code> </code><code class="kt">bool</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO2-3" id="co_elless_island_CO2-3"><img alt="3" src="assets/3.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO2-1" id="callout_elless_island_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>paths</code> argument will be a vector of strings for files and directories.<a data-primary="paths" data-secondary="paths argument, lsr program" data-type="indexterm" id="id1699"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO2-2" id="callout_elless_island_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>long</code> option is a Boolean for whether or not to print the long listing.<a data-primary="long option (lsr)" data-type="indexterm" id="id1700"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO2-3" id="callout_elless_island_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>show_hidden</code> option is a Boolean for whether or not to print hidden entries.<a data-primary="show_hidden option (lsr)" data-type="indexterm" id="id1701"/></p></dd>
</dl>

<p>There’s nothing new in this program when it comes to parsing and validating the arguments.
Annotate the struct for the <code>clap</code> derive pattern<a data-primary="derive pattern" data-secondary="using in lsr program" data-type="indexterm" id="id1702"/> or use this outline for <code>get_args</code> you can use:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_args</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code>::<code class="n">new</code><code class="p">(</code><code class="s">"lsr"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"0.1.0"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"Ken Youens-Clark &lt;kyclark@gmail.com&gt;"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"Rust version of `ls`"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="c1">// What goes here?</code>
<code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">();</code><code class="w"/>

<code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">paths</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">long</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">show_hidden</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Start your <code>main</code> function by printing the arguments:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">args</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_args</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"{args:?}"</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Make sure your program can print a usage<a data-primary="usage statement" data-secondary="lsr program" data-type="indexterm" id="id1703"/> like the following:</p>
<pre data-type="programlisting" style="widows:5;">$ cargo run -- -h
Rust version of `ls`

Usage: lsr [OPTIONS] [PATH]...

Arguments:
  [PATH]...  Files and/or directories [default: .]

Options:
  -l, --long     Long listing
  -a, --all      Show all files
  -h, --help     Print help
  -V, --version  Print version</pre>

<p>Run your program with no arguments and verify that the default for <code>paths</code> is a list containing the dot (<code>.</code>), which represents the current working directory.<a data-primary=". (dot)" data-secondary="indicating current directory" data-type="indexterm" id="id1704"/><a data-primary="paths" data-secondary="in lsr program" data-secondary-sortas="lsr" data-type="indexterm" id="id1705"/>
The two Boolean values should be <code>false</code>:</p>

<pre data-type="programlisting">$ cargo run
Args { paths: ["."], long: false, show_hidden: false }</pre>

<p>Try turning on the two flags and giving one or more positional arguments:</p>

<pre data-type="programlisting">$ cargo run -- -la tests/*
Args { paths: ["tests/cli.rs", "tests/inputs"], long: true, show_hidden: true }</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop reading and get your program working to this point.</p>
</div>

<p>I assume you figured that out, so here is my <code>get_args</code>.<a data-primary="get_args function" data-secondary="lsr utility" data-type="indexterm" id="id1706"/>
Be sure to include <code>use clap::{Arg, ArgAction, Command}</code> for the following code.
It’s similar to that used in previous programs, so I’ll eschew commentary:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_args</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code>::<code class="n">new</code><code class="p">(</code><code class="s">"lsr"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"0.1.0"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"Ken Youens-Clark &lt;kyclark@gmail.com&gt;"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"Rust version of `ls`"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"paths"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"PATH"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Files and/or directories"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">default_value</code><code class="p">(</code><code class="s">"."</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">num_args</code><code class="p">(</code><code class="mi">0</code><code class="o">..</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"long"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">action</code><code class="p">(</code><code class="n">ArgAction</code>::<code class="n">SetTrue</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Long listing"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'l'</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"long"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"all"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">action</code><code class="p">(</code><code class="n">ArgAction</code>::<code class="n">SetTrue</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Show all files"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'a'</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"all"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">();</code><code class="w"/>

<code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">paths</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_many</code><code class="p">(</code><code class="s">"paths"</code><code class="p">).</code><code class="n">unwrap</code><code class="p">().</code><code class="n">cloned</code><code class="p">().</code><code class="n">collect</code><code class="p">(),</code><code class="w"/>
<code class="w">        </code><code class="n">long</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_flag</code><code class="p">(</code><code class="s">"long"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="n">show_hidden</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_flag</code><code class="p">(</code><code class="s">"all"</code><code class="p">),</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>For the derive pattern, add <code>use clap::Parser</code> and<a data-primary="derive pattern" data-secondary="using in lsr program" data-type="indexterm" id="id1707"/> the following:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[derive(Debug, Parser)]</code><code class="w"/>
<code class="cp">#[command(author, version, about)]</code><code class="w"/>
<code class="sd">/// Rust version of `ls`</code>
<code class="k">struct</code> <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="sd">/// Files and/or directories</code>
<code class="w">    </code><code class="cp">#[arg(default_value = </code><code class="s">"."</code><code class="cp">)]</code><code class="w"/>
<code class="w">    </code><code class="n">paths</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Long listing</code>
<code class="w">    </code><code class="cp">#[arg(short, long)]</code><code class="w"/>
<code class="w">    </code><code class="n">long</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Show all files</code>
<code class="w">    </code><code class="cp">#[arg(short('a'), long(</code><code class="s">"all"</code><code class="cp">))]</code><code class="w"/>
<code class="w">    </code><code class="n">show_hidden</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Bring in the <code>run</code> function from earlier programs.
Add <code>use anyhow::Result</code> to your imports for the following code:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">run</code><code class="p">(</code><code class="n">Args</code>::<code class="n">parse</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"{e}"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="n">std</code>::<code class="n">process</code>::<code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">_args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Next, you’ll figure out how to find the input files.</p>
</div></section>








<section data-pdf-bookmark="Finding the Files" data-type="sect2"><div class="sect2" id="id142">
<h2>Finding the Files</h2>

<p>On the face of it, this program seems fairly simple.<a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswrdefarg" data-tertiary="defining the arguments" data-type="indexterm" id="id1708"/><a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="finding the files" data-type="indexterm" id="ix_lswrfndfi"/>
I want to list the given files and directories, so I’ll start by writing a <code>find_files</code> function as in several previous chapters.<a data-primary="find_files function" data-type="indexterm" id="id1709"/><a data-primary="PathBuf struct" data-secondary="found files represented as" data-type="indexterm" id="id1710"/><a data-primary="std::path::PathBuf" data-type="indexterm" id="id1711"/>
The found files can be represented by strings, as in <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>, but I’ve chosen to use a <code>PathBuf</code>, like I did <a data-type="xref" href="ch12.html#ch12">Chapter 12</a>.
If you want to follow this idea, be sure to add 
<span class="keep-together"><code>std::path::PathBuf</code></span> to your imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">find_files</code><code class="p">(</code><code class="w">
</code><code class="w">    </code><code class="n">paths</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="nb">String</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO3-1" id="co_elless_island_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">show_hidden</code><code>:</code><code> </code><code class="kt">bool</code><code> </code><a class="co" href="#callout_elless_island_CO3-2" id="co_elless_island_CO3-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">PathBuf</code><code class="o">&gt;</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO3-3" id="co_elless_island_CO3-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="fm">unimplemented!</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO3-1" id="callout_elless_island_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>paths</code> is a vector of file or directory names from the user.<a data-primary="paths" data-secondary="in lsr program" data-secondary-sortas="lsr" data-type="indexterm" id="id1712"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO3-2" id="callout_elless_island_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>show_hidden</code> indicates whether or not to include hidden files in directory 
<span class="keep-together">listings.</span><a data-primary="show_hidden option (lsr)" data-type="indexterm" id="id1713"/><a data-primary="hidden files" data-secondary="including/not including in directory listings" data-type="indexterm" id="id1714"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO3-3" id="callout_elless_island_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The result might be a vector of <a href="https://oreil.ly/Mth0r"><code>PathBuf</code> values</a>.</p></dd>
</dl>

<p>My <code>find_files</code> function will iterate through all the given <code>paths</code> and check if the value exists using <a href="https://oreil.ly/VsRxb"><code>std::fs::metadata</code></a>.
If there is no metadata, then I print an error message to <code>STDERR</code> and move to the next entry, so only existing files and directories will be returned by the function.<a data-primary="std::fs::metadata" data-type="indexterm" id="id1715"/><a data-primary="metadata" data-type="indexterm" id="id1716"/>
The printing of these error messages will be checked by the integration tests, so the function itself should return just the valid entries.
I struggled here with printing the errors rather than returning them as I cannot write a unit test that verifies the expected errors are detected, but writing the function in this way replicates the behavior of the original tool.
In the parlance of purely functional programming, printing is a side effect because it is not reflected in the function’s return values.</p>

<p>The metadata can tell me if the entry is a file or directory.
If the entry is a file, I create a <code>PathBuf</code> and add it to the results.
If the entry is a directory, I use <a href="https://oreil.ly/m95Y5"><code>fs::read_dir</code></a> to read the contents of the directory.<a data-primary="fs::read_dir function" data-type="indexterm" id="id1717"/><a data-primary=". (dot)" data-secondary="file or directory names starting with" data-type="indexterm" id="id1718"/>
The function should skip hidden entries with filenames that begin with a dot (<code>.</code>) unless <code>show_hidden</code> is <code>true</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>The filename is commonly called <em>basename</em> in command-line tools, and its corollary is <em>dirname</em>, which is the leading path information without the filename.<a data-primary="basename" data-type="indexterm" id="id1719"/><a data-primary="dirname" data-type="indexterm" id="id1720"/> There are command-line tools called 
<span class="keep-together"><code>basename</code></span> and <code>dirname</code> that will return these elements:</p>

<pre data-type="programlisting">$ basename 14_lsr/src/main.rs
main.rs
$ dirname 14_lsr/src/main.rs
14_lsr/src</pre>
</div>

<p>Following are two unit tests for <code>find_files</code> that check for listings that do and do not include hidden files.<a data-primary="find_files function" data-secondary="unit tests in lsr" data-type="indexterm" id="id1721"/><a data-primary="unit tests" data-secondary="test_find_files in lsr" data-type="indexterm" id="id1722"/>
As noted in the chapter introduction, the files may be returned in a different order depending on your OS, so the tests will sort the entries to disregard the ordering.
Note that the <code>find_files</code> function is not expected to recurse into subdirectories.
Add the following to your <em>src/main.rs</em> to start a <code>tests</code> module:</p>
<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">cfg(test)</code><code class="cp">]</code><code class="w">
</code><code class="k">mod</code><code> </code><code class="nn">test</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="k">super</code><code>::</code><code class="n">find_files</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_find_files</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="c1">// Find all nonhidden entries in a directory
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="kc">false</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-1" id="manual_co_elless_island_CO4-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-2" id="manual_co_elless_island_CO4-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">filenames</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-3" id="manual_co_elless_island_CO4-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">entry</code><code class="o">|</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">filenames</code><code class="p">.</code><code class="n">sort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-4" id="manual_co_elless_island_CO4-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-5" id="manual_co_elless_island_CO4-5"><img alt="5" src="assets/5.png"/></a><code class="w">
            </code><code class="n">filenames</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">[</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/fox.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">]</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="c1">// Find all entries in a directory
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#manual_callout_elless_island_CO4-6" id="manual_co_elless_island_CO4-6"><img alt="6" src="assets/6.png"/></a><code class="w">
        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">filenames</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">entry</code><code class="o">|</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">filenames</code><code class="p">.</code><code class="n">sort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">filenames</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">[</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/.hidden</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/fox.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">]</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="c1">// Any existing file should be found even if hidden
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs/.hidden</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="kc">false</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">filenames</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">entry</code><code class="o">|</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">filenames</code><code class="p">,</code><code class="w"> </code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs/.hidden</code><code class="s">"</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="c1">// Test multiple path arguments
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="o">&amp;</code><code class="p">[</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">]</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="kc">false</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">filenames</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">entry</code><code class="o">|</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">filenames</code><code class="p">.</code><code class="n">sort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">filenames</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">tests/inputs/dir/spiders.txt</code><code class="s">"</code><code class="p">]</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#manual_co_elless_island_CO4-1" id="manual_callout_elless_island_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Look for the entries in the <em>tests/inputs</em> directory, ignoring hidden files.</p></dd>
<dt><a class="co" href="#manual_co_elless_island_CO4-2" id="manual_callout_elless_island_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Ensure that the result is an <code>Ok</code> variant.<a data-primary="Result::ok function" data-type="indexterm" id="id-1VH1C4TRs4hPhBU9"/></p></dd>
<dt><a class="co" href="#manual_co_elless_island_CO4-3" id="manual_callout_elless_island_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Collect the display names into a <code>Vec&lt;String&gt;</code>.</p></dd>
<dt><a class="co" href="#manual_co_elless_island_CO4-4" id="manual_callout_elless_island_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Sort the entry names in alphabetical order.</p></dd>
<dt><a class="co" href="#manual_co_elless_island_CO4-5" id="manual_callout_elless_island_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Verify that the four expected files were found.</p></dd>
<dt><a class="co" href="#manual_co_elless_island_CO4-6" id="manual_callout_elless_island_CO4-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Look for the entries in the <em>tests/inputs</em> directory, including hidden files.</p></dd>
</dl>

<p>Following is the <a data-primary="hidden files" data-secondary="testing for in lsr" data-type="indexterm" id="id1723"/><a data-primary="find_files function" data-secondary="testing for hidden files in lsr" data-type="indexterm" id="id1724"/>test for hidden files:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">cfg(test)</code><code class="cp">]</code><code class="w">
</code><code class="k">mod</code><code> </code><code class="nn">test</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="k">super</code><code>::</code><code class="n">find_files</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_find_files</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w"> </code><code class="c1">// Same as before
</code><code class="w">
</code><code class="w">    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_find_files_hidden</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">tests/inputs</code><code class="s">"</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO4-1" id="co_elless_island_CO4-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">filenames</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">entry</code><code class="o">|</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">filenames</code><code class="p">.</code><code class="n">sort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="w">
</code><code class="w">            </code><code class="n">filenames</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">[</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/.hidden</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO4-2" id="co_elless_island_CO4-2"><img alt="2" src="assets/2.png"/></a><code class="w">
                </code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">                </code><code class="s">"</code><code class="s">tests/inputs/fox.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">]</code><code class="w">
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO4-1" id="callout_elless_island_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Include hidden files in the results.</p></dd>
<dt><a class="co" href="#co_elless_island_CO4-2" id="callout_elless_island_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <em>.hidden</em> file should be included in the results.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop here and ensure that <strong><code>cargo test find_files</code></strong> passes both tests.</p>
</div>

<p>Once your <code>find_files</code> function is working, integrate it into the <code>run</code> function to print the<a data-primary="run function" data-secondary="lsr program" data-type="indexterm" id="id1725"/><a data-primary="find_files function" data-secondary="integrating into run function for lsr" data-type="indexterm" id="id1726"/> found entries:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">paths</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">show_hidden</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO5-1" id="co_elless_island_CO5-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">for</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO5-2" id="co_elless_island_CO5-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="fm">println!</code><code class="p">(</code><code class="s">"</code><code class="s">{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">path</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO5-3" id="co_elless_island_CO5-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO5-1" id="callout_elless_island_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Look for the files in the provided paths and specify whether to show hidden entries.<a data-primary="paths" data-secondary="in lsr program" data-secondary-sortas="lsr" data-tertiary="looking for files in provided paths" data-type="indexterm" id="id1727"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO5-2" id="callout_elless_island_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Iterate through each of the returned paths.</p></dd>
<dt><a class="co" href="#co_elless_island_CO5-3" id="callout_elless_island_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/apWTZ"><code>Path::display</code></a> for safely printing paths that may contain non-Unicode data.<a data-primary="Path::display function" data-type="indexterm" id="id1728"/></p></dd>
</dl>

<p>If I run the program in the source directory, I see the following output:</p>

<pre data-type="programlisting">$ cargo run
./Cargo.toml
./target
./tests
./Cargo.lock
./src</pre>

<p>The output from the challenge program is not expected to completely replicate the original <code>ls</code>.
For example, the default listing for <code>ls</code> will create columns:</p>

<pre data-type="programlisting">$ ls tests/inputs/
bustle.txt  dir/        empty.txt   fox.txt</pre>

<p class="pagebreak-before">If your program can produce the following output, then you’ve already implemented the basic directory listing.
Note that the order of the files is not important. This is the output I see on macOS:</p>

<pre data-type="programlisting">$ cargo run -- -a tests/inputs/
tests/inputs/.hidden
tests/inputs/empty.txt
tests/inputs/bustle.txt
tests/inputs/fox.txt
tests/inputs/dir</pre>

<p>And this is what I see on Linux:</p>

<pre data-type="programlisting">$ cargo run -- -a tests/inputs/
tests/inputs/empty.txt
tests/inputs/.hidden
tests/inputs/fox.txt
tests/inputs/dir
tests/inputs/bustle.txt</pre>

<p>Provide a nonexistent file such as the trusty old <em>blargh</em> and check that your program prints a message to <code>STDERR</code>:</p>

<pre data-type="programlisting">$ cargo run -q -- <strong>blargh</strong> 2&gt;err
$ cat err
<strong>blargh: No such file or directory (os error 2)</strong></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop reading and ensure that <strong><code>cargo test</code></strong> passes about half of the tests. All the failing tests should have the word <em>long</em> in the name, which means you need to implement the long listing.<a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswrfndfi" data-tertiary="finding the files" data-type="indexterm" id="id1729"/></p>
</div>
</div></section>








<section data-pdf-bookmark="Formatting the Long Listing" data-type="sect2"><div class="sect2" id="id143">
<h2>Formatting the Long Listing</h2>

<p>The next step is to handle the <code>-l|--long</code> listing option, which lists metadata for each entry.<a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="formatting the long listing" data-type="indexterm" id="ix_lswrfmtlng"/><a data-primary="-l|--long option flag (lsr)" data-primary-sortas="l|" data-type="indexterm" id="ix_llong"/><a data-primary="long listing, formatting in lsr" data-type="indexterm" id="ix_longlist"/>
<a data-type="xref" href="#fig_14.1">Figure 14-1</a> shows an example of the output with the columns numbered in bold font; the column numbers are not part of the expected output.
Note that the output from your program will have different owners and modification times.</p>

<figure><div class="figure" id="fig_14.1">
<img alt="clru 1401" src="assets/clru_1401.png"/>
<h6><span class="label">Figure 14-1. </span>The long listing of the program will include eight pieces of metadata.</h6>
</div></figure>

<p class="pagebreak-before">The metadata displayed in the output, listed here by column number, is as follows:</p>
<ol>
<li>
<p>The entry type, which should be <code>d</code> for directory or a dash (<code>-</code>) for anything else</p>
</li>
<li>
<p>The permissions are represented using <code>r</code> for read, <code>w</code> for write, and <code>x</code> for execute for user, group, and other</p>
</li>
<li>
<p>The number of links pointing to the file</p>
</li>
<li>
<p>The name of the user that owns the file</p>
</li>
<li>
<p>The name of the group that owns the file</p>
</li>
<li>
<p>The size of the file or directory in bytes</p>
</li>
<li>
<p>The file’s last modification date and time</p>
</li>
<li>
<p>The path to the file</p>
</li>

</ol>

<p>Creating the output table can be tricky, so I decided to use <a href="https://oreil.ly/5HBqP"><code>tabular</code></a> to handle this for me.<a data-primary="tabular crate" data-type="indexterm" id="id1730"/>
I wrote a function called <code>format_output</code> that accepts a list of <code>PathBuf</code> values and might return a formatted table with columns of metadata.
If you want to follow my lead on this, be sure to add <code>use tabular::{Row, Table}</code> to your imports.<a data-primary="Row struct" data-type="indexterm" id="id1731"/><a data-primary="Table struct" data-type="indexterm" id="id1732"/><a data-primary="format_output function" data-type="indexterm" id="id1733"/>
Note that my function doesn’t exactly replicate the output from BSD <code>ls</code>, but it meets the expectations of the test suite:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">format_output</code><code class="p">(</code><code class="n">paths</code>: <code class="kp">&amp;</code><code class="p">[</code><code class="n">PathBuf</code><code class="p">])</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">//         1   2     3     4     5     6     7     8</code>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">fmt</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"{:&lt;}{:&lt;}  {:&gt;}  {:&lt;}  {:&lt;}  {:&gt;}  {:&lt;}  {:&lt;}"</code><code class="p">;</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">table</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Table</code>::<code class="n">new</code><code class="p">(</code><code class="n">fmt</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">table</code><code class="p">.</code><code class="n">add_row</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Row</code>::<code class="n">new</code><code class="p">()</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 1 "d" or "-"</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 2 permissions</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 3 number of links</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 4 user name</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 5 group name</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 6 size</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 7 modification</code>
<code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="s">""</code><code class="p">)</code><code class="w"> </code><code class="c1">// 8 path</code>
<code class="w">        </code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>

<code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="fm">format!</code><code class="p">(</code><code class="s">"{table}"</code><code class="p">))</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p class="pagebreak-before">You can find much of the data you need to fill in the cells with <a href="https://oreil.ly/2G3en"><code>PathBuf::metadata</code></a>.<a data-primary="PathBuf::metadata" data-type="indexterm" id="id1734"/>
Here are some pointers to help you fill in the various 
<span class="keep-together">columns:</span></p>

<ul>
<li>
<p><a href="https://oreil.ly/qhXWX"><code>metadata::is_dir</code></a> returns a Boolean for whether or not the entry is a directory.<a data-primary="metadata::is_dir function" data-type="indexterm" id="id1735"/><a data-primary="directories" data-secondary="metadata::is_dir function" data-type="indexterm" id="id1736"/></p>
</li>
<li>
<p><a href="https://oreil.ly/LuKo4"><code>metadata::mode</code></a> will return a <code>u32</code> representing the permissions for the entry.<a data-primary="metadata::mode" data-type="indexterm" id="id1737"/> In the next section, I will explain how to format this information into a display string.</p>
</li>
<li>
<p>You can find the number of links using <a href="https://oreil.ly/f2RyC"><code>metadata::nlink</code></a>.<a data-primary="metadata::uid function" data-type="indexterm" id="id1738"/><a data-primary="links" data-type="indexterm" id="id1739"/><a data-primary="metadata::nlink" data-type="indexterm" id="id1740"/><a data-primary="metadata::gid function" data-type="indexterm" id="id1741"/></p>
</li>
<li>
<p>For the user and group owners, add <code>use std::os::unix::fs::MetadataExt</code> so that you can call <a href="https://oreil.ly/P8YpO"><code>metadata::uid</code></a> to get the user ID of the owner and <a href="https://oreil.ly/ggddm">
<span class="keep-together"><code>metadata::gid</code></span></a> to get the group ID.<a data-primary="std::os::unix::fs::MetadataExt" data-type="indexterm" id="id1742"/><a data-primary="users crate" data-type="indexterm" id="id1743"/><a data-primary="groups" data-type="indexterm" id="id1744"/> Both the user and group IDs are integer values that must be converted into actual user and group names. For this, I recommend you look at the <a href="https://oreil.ly/nuvE8"><code>users</code> crate</a> that contains the functions <a href="https://oreil.ly/gaDwI"><code>get_user_by_uid</code></a> and <a href="https://oreil.ly/qFRSD"><code>get_group_by_gid</code></a>.</p>
</li>
<li>
<p>Use <a href="https://oreil.ly/129cs"><code>metadata::len</code></a> to get the size of a file or directory.<a data-primary="metadata::len function" data-type="indexterm" id="id1745"/><a data-primary="get_user_by_uid function" data-type="indexterm" id="id1746"/><a data-primary="get_group_by_gid function" data-type="indexterm" id="id1747"/></p>
</li>
<li>
<p>Displaying the file’s <a href="https://oreil.ly/buVC9"><code>metadata::modified</code></a> time is tricky. This method returns a <a href="https://oreil.ly/GIiqd"><code>std::time::SystemTime</code> struct</a>, and I recommend that you use<a data-primary="std::time::SystemTime struct" data-type="indexterm" id="id1748"/><a data-primary="SystemTime struct" data-type="indexterm" id="id1749"/><a data-primary="metadata::modified" data-type="indexterm" id="id1750"/> <a href="https://oreil.ly/TUBOK"><code>chrono​::Date⁠Time::format</code></a> to format the date using <a href="https://oreil.ly/075dF"><code>strftime</code> syntax</a>, a format that will likely be familiar to C and Perl programmers.<a data-primary="strftime syntax" data-type="indexterm" id="id1751"/><a data-primary="chrono::DateTime::format" data-type="indexterm" id="id1752"/></p>
</li>
<li>
<p>Use <a href="https://oreil.ly/8tnwX"><code>Path::display</code></a> for the file or directory name.<a data-primary="Path::display function" data-type="indexterm" id="id1753"/></p>
</li>
</ul>

<p>I have unit tests for this function, but first I need to explain more about how to display the permissions.<a data-primary="long listing, formatting in lsr" data-startref="ix_longlist" data-type="indexterm" id="id1754"/><a data-primary="-l|--long option flag (lsr)" data-primary-sortas="l|" data-startref="ix_llong" data-type="indexterm" id="id1755"/><a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswrfmtlong" data-tertiary="formatting the long listing" data-type="indexterm" id="id1756"/></p>
</div></section>








<section data-pdf-bookmark="Displaying Octal Permissions" data-type="sect2"><div class="sect2" id="id144">
<h2>Displaying Octal Permissions</h2>

<p>The file type and permissions will be displayed using a string of 10 characters like <code>drwxr-xr-x</code>, where each letter or dash indicates a specific piece of information.<a data-primary="octal permissions, displaying in lsr" data-type="indexterm" id="ix_octperm"/><a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="displaying octal permissions" data-type="indexterm" id="ix_lswroctprm"/><a data-primary="permissions" data-secondary="displaying octal permissions in lsr" data-type="indexterm" id="ix_permoct"/>
The first character is either a <code>d</code> for <em>directory</em> or a dash for anything else.
The standard <code>ls</code> will also use <code>l</code> for a <em>link</em>, but the challenge program will not distinguish links.</p>

<p>The other nine characters represent the permissions for the entry.
In Unix, each file and directory has three levels of sharing for a <em>user</em>, a <em>group</em>, and <em>other</em> for everyone else.<a data-primary="Unix" data-secondary="files and directories, levels of sharing and ownership" data-type="indexterm" id="id1757"/>
Only one user and one group can own a file at a time.
For each ownership level, there are permissions for reading, writing, and executing, as shown in <a data-type="xref" href="#fig_14.2">Figure 14-2</a>.</p>

<figure><div class="figure" id="fig_14.2">
<img alt="clru 1402" src="assets/clru_1402.png"/>
<h6><span class="label">Figure 14-2. </span>Each level of ownership (user, group, and other) has permissions for read, write, and execute.</h6>
</div></figure>

<p>These three permissions are either <em>on</em> or <em>off</em> and can be represented with three bits using <code>1</code> and <code>0</code>, respectively.
This means there are three combinations of two choices, which makes eight possible outcomes because 2<sup>3</sup> = 8.
In binary encoding, each bit position corresponds to a power of 2, so <code>001</code> is the number <code>1</code> (2<sup>0</sup>), and <code>010</code> is the number <code>2</code> (2<sup>1</sup>).
To represent the number <code>3</code>, both bits are added, so the binary version is <code>011</code>.
You can verify this with Rust by using the prefix <code>0b</code> to represent a binary 
<span class="keep-together">number:</span></p>

<pre data-code-language="rust" data-type="programlisting"><code class="fm">assert_eq!</code><code class="p">(</code><code class="mb">0b001</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mb">0b010</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">);</code><code class="w"/></pre>

<p>The number <code>4</code> is <code>100</code> (2<sup>2</sup>), and so <code>5</code> is <code>101</code> (4 + 1).
Because a three-bit value can represent only eight numbers, this is called <em>octal</em> notation.<a data-primary="octal notation" data-type="indexterm" id="id1758"/>
You can see the binary representation of the first eight numbers with the following loop:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="mi">0</code><code class="o">..=</code><code class="mi">7</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO6-1" id="co_elless_island_CO6-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"</code><code class="s">{n} = {n:03b}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO6-2" id="co_elless_island_CO6-2"><img alt="2" src="assets/2.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO6-1" id="callout_elless_island_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>..=</code> range operator includes the ending value.<a data-primary="..= (range) operator" data-type="indexterm" id="id1759"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO6-2" id="callout_elless_island_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Print the value <code>n</code> as is and in binary format to three places using leading zeros.</p></dd>
</dl>

<p>The preceding code will print this:</p>

<pre data-type="programlisting">0 = 000
1 = 001
2 = 010
3 = 011
4 = 100
5 = 101
6 = 110
7 = 111</pre>

<p><a data-type="xref" href="#fig_14.3">Figure 14-3</a> shows that each of the three bit positions corresponds to a permission.
The <code>4</code> position is for <em>read</em>, the <code>2</code> position for <em>write</em>, and the <code>1</code> position for <em>execute</em>.<a data-primary="read/write/execute permissions" data-type="indexterm" id="id1760"/><a data-primary="chmod command" data-secondary="octal notation with" data-type="indexterm" id="id1761"/>
Octal notation is commonly used with the <code>chmod</code> command I mentioned in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.html#ch02">2</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch03.html#ch03">3</a>.
For example, the command <code>chmod 775</code> will enable the read/write/execute bits for the user and group of a file but will enable only read and execute for everyone else.
This allows anyone to execute a program, but only the owner or group can 
<span class="keep-together">modify</span> it.
The permission <code>600</code>, where only the owner can read and write a file, is often used for sensitive data like SSH keys.</p>

<figure><div class="figure" id="fig_14.3">
<img alt="clru 1403" src="assets/clru_1403.png"/>
<h6><span class="label">Figure 14-3. </span>The permissions <code>775</code> and <code>600</code> in octal notation translate to read/write/execute permissions for user/group/other.</h6>
</div></figure>

<p>I recommend you read the documentation for <a href="https://oreil.ly/LuKo4"><code>metadata::mode</code></a> to get a file’s permissions.
That documentation shows you how to mask the mode with a value like <code>0o200</code> to determine if the user has write access.<a data-primary="metadata::mode" data-type="indexterm" id="id1762"/>
(The prefix <code>0o</code> is the Rust way to write in octal notation.)
That is, if you use the binary 
<span class="keep-together"><em>AND</em> operator <code>&amp;</code></span> to combine two binary values, only those bits that are both set (meaning they have a value of <code>1</code>) will produce a <code>1</code>.</p>

<p>As shown in <a data-type="xref" href="#fig_14.4">Figure 14-4</a>, if you <code>&amp;</code> the values <code>0o700</code> and <code>0o200</code>, the <em>write</em> bits in position <code>2</code> are both set and so the result is <code>0o200</code>.
The other <a data-primary="masking" data-type="indexterm" id="id1763"/>bits can’t be set because the zeros in <code>0o200</code> will <em>mask</em> or hide those values, hence the term <em>masking</em> for this 
<span class="keep-together">operation.</span>
If you <code>&amp;</code> the values <code>0o400</code> and <code>0o200</code>, the result is <code>0</code> because none of the three positions contains a <code>1</code> in both operands.<a data-primary="&amp; operator" data-secondary="binary AND" data-type="indexterm" id="id1764"/></p>

<figure><div class="figure" id="fig_14.4">
<img alt="clru 1404" src="assets/clru_1404.png"/>
<h6><span class="label">Figure 14-4. </span>The binary <em>AND</em> operator <code>&amp;</code> will set bit values in the result where both bits are set in the operands.</h6>
</div></figure>

<p>I wrote a function called <code>format_mode</code> to create the needed output for the per­mis⁠sions.<a data-primary="format_mode function" data-type="indexterm" id="id1765"/>
It accepts the <code>u32</code> value returned by <code>mode</code> and returns a <code>String</code> of nine 
<span class="keep-together">characters:</span></p>

<pre data-code-language="rust" data-type="programlisting"><code class="sd">/// Given a file mode in octal format like 0o751,</code>
<code class="sd">/// return a string like "rwxr-x--x"</code>
<code class="k">fn</code> <code class="nf">format_mode</code><code class="p">(</code><code class="n">mode</code>: <code class="kt">u32</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">String</code> <code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="fm">unimplemented!</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The preceding function needs to create three groupings of <code>rwx</code> for user, group, and other using <a data-primary="read/write/execute mask values" data-type="indexterm" id="id1766"/>the mask values shown in <a data-type="xref" href="#table_14.1">Table 14-1</a>.</p>
<table id="table_14.1">
<caption><span class="label">Table 14-1. </span>Read/write/execute mask values for user, group, and other</caption>
<thead>
<tr>
<th>Owner</th>
<th>Read</th>
<th>Write</th>
<th>Execute</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>User</p></td>
<td><p><code>0o400</code></p></td>
<td><p><code>0o200</code></p></td>
<td><p><code>0o100</code></p></td>
</tr>
<tr>
<td><p>Group</p></td>
<td><p><code>0o040</code></p></td>
<td><p><code>0o020</code></p></td>
<td><p><code>0o010</code></p></td>
</tr>
<tr>
<td><p>Other</p></td>
<td><p><code>0o004</code></p></td>
<td><p><code>0o002</code></p></td>
<td><p><code>0o001</code></p></td>
</tr>
</tbody>
</table>

<p>It might help to see the unit test that <a data-primary="format_mode function" data-secondary="unit test for in lsr" data-type="indexterm" id="id1767"/><a data-primary="unit tests" data-secondary="test_format_mode in lsr" data-type="indexterm" id="id1768"/>you can add to your <code>tests</code> module:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">cfg(test)</code><code class="cp">]</code><code class="w">
</code><code class="k">mod</code><code> </code><code class="nn">test</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="k">super</code><code>:</code><code>:</code><code class="p">{</code><code class="n">find_files</code><code class="p">,</code><code class="w"> </code><code class="n">format_mode</code><code class="p">}</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO7-1" id="co_elless_island_CO7-1"><img alt="1" src="assets/1.png"/></a><code class="w">

    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_find_files</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w"> </code><code class="c1">// Same as before
</code><code class="w">
</code><code class="w">    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_find_files_hidden</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w"> </code><code class="c1">// Same as before
</code><code class="w">
</code><code class="w">    </code><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="w">    </code><code class="k">fn</code><code> </code><code class="nf">test_format_mode</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">format_mode</code><code class="p">(</code><code class="mo">0o755</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">rwxr-xr-x</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO7-2" id="co_elless_island_CO7-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">format_mode</code><code class="p">(</code><code class="mo">0o421</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">r---w---x</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO7-1" id="callout_elless_island_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Import the <code>format_mode</code> function.</p></dd>
<dt><a class="co" href="#co_elless_island_CO7-2" id="callout_elless_island_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>These are two spot checks for the function. Presumably, the function works if these two pass.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop reading and write the code that will pass <strong><code>cargo test for⁠mat​_mode</code></strong>. Then, incorporate the output from <code>format_mode</code> into the <code>format_output</code> function.<a data-primary="octal permissions, displaying in lsr" data-startref="ix_octperm" data-type="indexterm" id="id1769"/><a data-primary="permissions" data-secondary="displaying octal permissions in lsr" data-startref="ix_permoct" data-type="indexterm" id="id1770"/><a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswroctprm" data-tertiary="displaying octal permissions" data-type="indexterm" id="id1771"/></p>
</div>
</div></section>








<section data-pdf-bookmark="Testing the Long Format" data-type="sect2"><div class="sect2" id="id145">
<h2>Testing the Long Format</h2>

<p>It’s not easy to test the <a data-primary="format_output function" data-type="indexterm" id="id1772"/>output from the <code>format_output</code> function, because the output on your system will necessarily be different from mine.<a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="testing the long format" data-type="indexterm" id="ix_lswrtstlong"/><a data-primary="long format" data-secondary="testing in lsr" data-type="indexterm" id="ix_longfmttst"/>
For instance, you will likely have a different user name, group name, and file modification times.
We should still have the same permissions (if you ran the <em>set-test-perms.sh</em> script), number of links, file sizes, and paths, so I have written the tests to inspect only those columns.
In addition, I can’t rely on the specific widths of the columns or any delimiting characters, as user and group names will vary. The unit tests I’ve created for the <code>format_output</code> function should help you write a working solution while also providing enough flexibility to account for the differences in our systems.</p>

<p>The following helper function, which you can add to your <code>tests</code> module, will inspect the long output for any one directory entry.
Be sure to add 
<span class="keep-together"><code>pretty_assertions::assert_eq</code></span> to <a data-primary="pretty_assertions::assert_eq macro" data-type="indexterm" id="id1773"/><a data-primary="assert_eq! macro" data-type="indexterm" id="id1774"/>your imports to make failing tests easier to read:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">long_match</code><code class="p">(</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-1" id="co_elless_island_CO8-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">line</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">expected_name</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">expected_perms</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">expected_size</code><code>:</code><code> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="o">&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="p">,</code><code class="w">
</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">parts</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">split_whitespace</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-2" id="co_elless_island_CO8-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="o">&amp;</code><code class="o">&amp;</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">&lt;</code><code class="o">=</code><code class="w"> </code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-3" id="co_elless_island_CO8-3"><img alt="3" src="assets/3.png"/></a><code class="w">

    </code><code class="kd">let</code><code class="w"> </code><code class="n">perms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-4" id="co_elless_island_CO8-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">perms</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">expected_perms</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">size</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">expected_size</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-5" id="co_elless_island_CO8-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">file_size</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">file_size</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">size</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">display_name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO8-6" id="co_elless_island_CO8-6"><img alt="6" src="assets/6.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">display_name</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">expected_name</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO8-1" id="callout_elless_island_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The function takes a line of the output along with the expected values for the permissions, size, and path.</p></dd>
<dt><a class="co" href="#co_elless_island_CO8-2" id="callout_elless_island_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Split the line of text on whitespace.</p></dd>
<dt><a class="co" href="#co_elless_island_CO8-3" id="callout_elless_island_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Verify that the line was split into an expected range of fields.</p></dd>
<dt><a class="co" href="#co_elless_island_CO8-4" id="callout_elless_island_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Verify the permissions string, which is in the first column.</p></dd>
<dt><a class="co" href="#co_elless_island_CO8-5" id="callout_elless_island_CO8-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Verify the file size, which is in the fifth column. Directory sizes are not tested, so this is an optional argument.</p></dd>
<dt><a class="co" href="#co_elless_island_CO8-6" id="callout_elless_island_CO8-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Verify the filepath, which is in the last column.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I use <a href="https://oreil.ly/mvd2C"><code>Iterator::last</code></a> rather than try to 
<span class="keep-together">use a</span> positive offset because the modification date column has 
<span class="keep-together">whitespace.</span><a data-primary="Iterator::last function" data-type="indexterm" id="id1775"/></p>
</div>

<p>Expand the <code>tests</code> with the following unit test for the <code>format_output</code> function that checks the long listing for one file.<a data-primary="format_output function" data-secondary="unit test for in lsr" data-type="indexterm" id="id1776"/><a data-primary="unit tests" data-secondary="test_format_output in lsr" data-type="indexterm" id="id1777"/>
Note that you will need to add <code>use std​::path::PathBuf</code> and <code>format_output</code> to the imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="k">fn</code><code> </code><code class="nf">test_format_output_one</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bustle_path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bustle</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">PathBuf</code><code>::</code><code class="n">from</code><code class="p">(</code><code class="n">bustle_path</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO9-1" id="co_elless_island_CO9-1"><img alt="1" src="assets/1.png"/></a><code class="w">

    </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">format_output</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="n">bustle</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO9-2" id="co_elless_island_CO9-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="o">&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">        </code><code class="n">out</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">s</code><code class="o">|</code><code class="w"> </code><code class="o">!</code><code class="n">s</code><code class="p">.</code><code class="n">is_empty</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO9-3" id="co_elless_island_CO9-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">line1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="n">long_match</code><code class="p">(</code><code class="o">&amp;</code><code class="n">line1</code><code class="p">,</code><code class="w"> </code><code class="n">bustle_path</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-rw-r--r--</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"</code><code class="s">193</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO9-4" id="co_elless_island_CO9-4"><img alt="4" src="assets/4.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO9-1" id="callout_elless_island_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a <code>PathBuf</code> value for <em>tests/inputs/bustle.txt</em>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO9-2" id="callout_elless_island_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Execute the function with one path.<a data-primary="PathBuf struct" data-type="indexterm" id="id1778"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO9-3" id="callout_elless_island_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Break the output on newlines and verify there is just one line.</p></dd>
<dt><a class="co" href="#co_elless_island_CO9-4" id="callout_elless_island_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Use the helper function to inspect the permissions, size, and path.</p></dd>
</dl>

<p>The following unit test passes two files and checks both lines for the correct output:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="k">fn</code><code> </code><code class="nf">test_format_output_two</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">res</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">format_output</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO10-1" id="co_elless_island_CO10-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="n">PathBuf</code><code>::</code><code class="n">from</code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">PathBuf</code><code>::</code><code class="n">from</code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">res</code><code class="p">.</code><code class="n">is_ok</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">res</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">lines</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="o">&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">        </code><code class="n">out</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">s</code><code class="o">|</code><code class="w"> </code><code class="o">!</code><code class="n">s</code><code class="p">.</code><code class="n">is_empty</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="n">lines</code><code class="p">.</code><code class="n">sort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO10-2" id="co_elless_island_CO10-2"><img alt="2" src="assets/2.png"/></a><code class="w">

    </code><code class="kd">let</code><code class="w"> </code><code class="n">empty_line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">lines</code><code class="p">.</code><code class="n">remove</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO10-3" id="co_elless_island_CO10-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="n">long_match</code><code class="p">(</code><code class="w">
</code><code class="w">        </code><code class="o">&amp;</code><code class="n">empty_line</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="s">"</code><code class="s">-rw-r--r--</code><code class="s">"</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="s">"</code><code class="s">0</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">dir_line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">lines</code><code class="p">.</code><code class="n">remove</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO10-4" id="co_elless_island_CO10-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="n">long_match</code><code class="p">(</code><code class="o">&amp;</code><code class="n">dir_line</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">drwxr-xr-x</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="nb">None</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO10-1" id="callout_elless_island_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Execute the function with two arguments, one of which is a directory.</p></dd>
<dt><a class="co" href="#co_elless_island_CO10-2" id="callout_elless_island_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Verify that two lines are returned.</p></dd>
<dt><a class="co" href="#co_elless_island_CO10-3" id="callout_elless_island_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Verify the expected values for the <em>empty.txt</em> file.</p></dd>
<dt><a class="co" href="#co_elless_island_CO10-4" id="callout_elless_island_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Verify the expected values for the directory listing. Don’t bother checking the size, as different systems will report different sizes.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop reading and write the code to pass <strong><code>cargo test for⁠mat​_out⁠put</code></strong>. Once that works, incorporate the long output into the <code>run</code> function. Have at you!<a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswrtstlong" data-tertiary="testing the long format" data-type="indexterm" id="id1779"/><a data-primary="long format" data-secondary="testing in lsr" data-startref="ix_longfmttst" data-type="indexterm" id="id1780"/></p>
</div>
</div></section>
</div></section>






<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="id146">
<h1>Solution</h1>

<p>This became a surprisingly complicated program that needed to be decomposed into several smaller functions.<a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="solution" data-type="indexterm" id="ix_lswrsol"/>
I’ll show you how I wrote each<a data-primary="find_files function" data-type="indexterm" id="id1781"/> function, starting with <code>find_files</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">find_files</code><code class="p">(</code><code class="n">paths</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="nb">String</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="n">show_hidden</code><code>:</code><code> </code><code class="kt">bool</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">PathBuf</code><code class="o">&gt;</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">results</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="fm">vec!</code><code class="p">[</code><code class="p">]</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-1" id="co_elless_island_CO11-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">for</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">metadata</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-2" id="co_elless_island_CO11-2"><img alt="2" src="assets/2.png"/></a><code class="w">
            </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"</code><code class="s">{name}: {e}</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-3" id="co_elless_island_CO11-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">meta</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="n">meta</code><code class="p">.</code><code class="n">is_dir</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-4" id="co_elless_island_CO11-4"><img alt="4" src="assets/4.png"/></a><code class="w">
                    </code><code class="k">for</code><code class="w"> </code><code class="n">entry</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_dir</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-5" id="co_elless_island_CO11-5"><img alt="5" src="assets/5.png"/></a><code class="w">
                        </code><code class="kd">let</code><code class="w"> </code><code class="n">entry</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">entry</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-6" id="co_elless_island_CO11-6"><img alt="6" src="assets/6.png"/></a><code class="w">
                        </code><code class="kd">let</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">entry</code><code class="p">.</code><code class="n">path</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-7" id="co_elless_island_CO11-7"><img alt="7" src="assets/7.png"/></a><code class="w">
                        </code><code class="kd">let</code><code class="w"> </code><code class="n">is_hidden</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-8" id="co_elless_island_CO11-8"><img alt="8" src="assets/8.png"/></a><code class="w">
                            </code><code class="n">path</code><code class="p">.</code><code class="n">file_name</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">map_or</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code><code class="w"> </code><code class="o">|</code><code class="n">file_name</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                                </code><code class="n">file_name</code><code class="p">.</code><code class="n">to_string_lossy</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="sc">'.'</code><code class="p">)</code><code class="w">
</code><code class="w">                            </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">                        </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">is_hidden</code><code class="w"> </code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">show_hidden</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-9" id="co_elless_island_CO11-9"><img alt="9" src="assets/9.png"/></a><code class="w">
                            </code><code class="n">results</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">entry</code><code class="p">.</code><code class="n">path</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">                        </code><code class="p">}</code><code class="w">
</code><code class="w">                    </code><code class="p">}</code><code class="w">
</code><code class="w">                </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                    </code><code class="n">results</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">PathBuf</code><code>::</code><code class="n">from</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO11-10" id="co_elless_island_CO11-10"><img alt="10" src="assets/10.png"/></a><code class="w">
                </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">results</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO11-1" id="callout_elless_island_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Initialize a mutable vector for the results.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-2" id="callout_elless_island_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Attempt to get the metadata for the path.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-3" id="callout_elless_island_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>In the event of an error such as a nonexistent file, print an error message to <code>STDERR</code> and move to the next file.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-4" id="callout_elless_island_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Check if the entry is a directory.<a data-primary="fs::read_dir function" data-type="indexterm" id="id1782"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO11-5" id="callout_elless_island_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>If so, use <code>fs::read_dir</code> to read the entries.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-6" id="callout_elless_island_CO11-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Unpack the <code>Result</code>.<a data-primary="DirEntry::path" data-type="indexterm" id="id1783"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO11-7" id="callout_elless_island_CO11-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/koDWO"><code>DirEntry::path</code></a> to get the <code>Path</code> value for the entry.<a data-primary="paths" data-secondary="DirEntry::path" data-type="indexterm" id="id1784"/><a data-primary="hidden files" data-type="indexterm" id="id1785"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO11-8" id="callout_elless_island_CO11-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Check if the basename starts with a dot and is therefore hidden.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-9" id="callout_elless_island_CO11-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>If the entry should be displayed, add a <code>PathBuf</code> to the results.</p></dd>
<dt><a class="co" href="#co_elless_island_CO11-10" id="callout_elless_island_CO11-10"><img alt="10" src="assets/10.png"/></a></dt>
<dd><p>Add a <code>PathBuf</code> for the file to the results.<a data-primary="PathBuf struct" data-type="indexterm" id="id1786"/></p></dd>
</dl>

<p>Next, I’ll show how to format the permissions.
Recall <a data-type="xref" href="#table_14.1">Table 14-1</a> with the nine masks needed to handle the nine bits that make up the permissions.<a data-primary="Owner enum" data-type="indexterm" id="id1787"/>
To encapsulate this data, I created an <code>enum</code> type called <code>Owner</code>, which I define with variants for <code>User</code>, <code>Group</code>, and <code>Other</code>.<a data-primary="User enum" data-type="indexterm" id="id1788"/><a data-primary="Group enum" data-type="indexterm" id="id1789"/><a data-primary="Other enum" data-type="indexterm" id="id1790"/>
By default, all the variables and functions in a module are private, which means they are accessible only to other code within the same module, so I must use the <a href="https://oreil.ly/Jmj7b"><code>pub</code></a> keyword to make this visible to the rest of the program<a data-primary="pub keyword, using to define public functions and variables" data-type="indexterm" id="id1791"/>.
Additionally, I want to add a method to my type that will return the masks needed to create the permissions string.<a data-primary="masking" data-secondary="masks needed to construct permissions string" data-type="indexterm" id="id1792"/>
I would like to group this code into a separate module called <code>owner</code>, so I will place the following code into the file <em>src/owner.rs</em>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">derive(Clone, Copy)</code><code class="cp">]</code><code class="w">
</code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code><code> </code><code class="nc">Owner</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-1" id="co_elless_island_CO12-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">User</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">Group</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">Other</code><code class="p">,</code><code class="w">
</code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="k">impl</code><code class="w"> </code><code class="n">Owner</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-2" id="co_elless_island_CO12-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code><code> </code><code class="nf">masks</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="p">[</code><code class="kt">u32</code><code class="p">;</code><code class="w"> </code><code class="mi">3</code><code class="p">]</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-3" id="co_elless_island_CO12-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-4" id="co_elless_island_CO12-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="bp">Self</code><code>::</code><code class="n">User</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">[</code><code class="mo">0o400</code><code class="p">,</code><code class="w"> </code><code class="mo">0o200</code><code class="p">,</code><code class="w"> </code><code class="mo">0o100</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-5" id="co_elless_island_CO12-5"><img alt="5" src="assets/5.png"/></a><code class="w">
            </code><code class="bp">Self</code><code>::</code><code class="n">Group</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">[</code><code class="mo">0o040</code><code class="p">,</code><code class="w"> </code><code class="mo">0o020</code><code class="p">,</code><code class="w"> </code><code class="mo">0o010</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-6" id="co_elless_island_CO12-6"><img alt="6" src="assets/6.png"/></a><code class="w">
            </code><code class="bp">Self</code><code>::</code><code class="n">Other</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="p">[</code><code class="mo">0o004</code><code class="p">,</code><code class="w"> </code><code class="mo">0o002</code><code class="p">,</code><code class="w"> </code><code class="mo">0o001</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO12-7" id="co_elless_island_CO12-7"><img alt="7" src="assets/7.png"/></a><code class="w">
        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO12-1" id="callout_elless_island_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>An owner can be a user, group, or other.<a data-primary="users" data-type="indexterm" id="id1793"/><a data-primary="groups" data-type="indexterm" id="id1794"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO12-2" id="callout_elless_island_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>This is an implementation (<code>impl</code>) block for <code>Owner</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO12-3" id="callout_elless_island_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Define a method called <code>masks</code> that will return an array of the mask values for a given owner.<a data-primary="mask method" data-type="indexterm" id="id1795"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO12-4" id="callout_elless_island_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p><code>self</code> will be one of the <code>enum</code> variants.</p></dd>
<dt><a class="co" href="#co_elless_island_CO12-5" id="callout_elless_island_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>These are the read, write, and execute masks for <code>User</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO12-6" id="callout_elless_island_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>These are the read, write, and execute masks for <code>Group</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO12-7" id="callout_elless_island_CO12-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>These are the read, write, and execute masks for <code>Other</code>.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you come from an object-oriented background, you’ll find this syntax is suspiciously similar to a class definition and an object method declaration, complete with a reference to <code>self</code> as the 
<span class="keep-together">invocant.</span></p>
</div>

<p>To use this module, add <code>mod owner</code> to the top of <em>src/main.rs</em>, then add <code>use owner::Owner</code> to the list of imports.<a data-primary="owner::Owner enum" data-type="indexterm" id="id1796"/>
As you’ve seen in almost every chapter, the <a href="https://oreil.ly/GqfkT"><code>mod</code> keyword</a> is used to create new modules, such as the <code>tests</code> module for unit tests.<a data-primary="mod keyword" data-type="indexterm" id="id1797"/>
In this case, adding <code>mod owner</code> declares a new module named <code>owner</code>.<a data-primary="mod owner" data-type="indexterm" id="id1798"/>
Because you haven’t specified the contents of the module here, the Rust compiler knows to look in <em>src/owner.rs</em> for the module’s code.
Then, you can import the <code>Owner</code> type into the root module’s scope with <code>use owner::Owner</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>As your programs grow more complicated, it’s useful to organize code into modules. This will make it easier to isolate and test ideas as well as reuse code in other projects.<a data-primary="modules imported to finish lsr" data-type="indexterm" id="id1799"/></p>
</div>

<p class="pagebreak-before">Following is a list of all the imports I used to finish the program:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">mod</code> <code class="nn">owner</code><code class="p">;</code><code class="w"/>

<code class="k">use</code><code class="w"> </code><code class="n">anyhow</code>::<code class="nb">Result</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">chrono</code>::<code class="p">{</code><code class="n">DateTime</code><code class="p">,</code><code class="w"> </code><code class="n">Local</code><code class="p">};</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">clap</code>::<code class="n">Parser</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">owner</code>::<code class="n">Owner</code><code class="p">;</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="p">{</code><code class="n">fs</code><code class="p">,</code><code class="w"> </code><code class="n">os</code>::<code class="n">unix</code>::<code class="n">fs</code>::<code class="n">MetadataExt</code><code class="p">,</code><code class="w"> </code><code class="n">path</code>::<code class="n">PathBuf</code><code class="p">};</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">tabular</code>::<code class="p">{</code><code class="n">Row</code><code class="p">,</code><code class="w"> </code><code class="n">Table</code><code class="p">};</code><code class="w"/>
<code class="k">use</code><code class="w"> </code><code class="n">users</code>::<code class="p">{</code><code class="n">get_group_by_gid</code><code class="p">,</code><code class="w"> </code><code class="n">get_user_by_uid</code><code class="p">};</code><code class="w"/></pre>

<p>I added the <a data-primary="mk_triple helper function" data-type="indexterm" id="id1800"/>following <code>mk_triple</code> helper function, which creates part of the permissions string given the file’s <code>mode</code> and an <code>Owner</code> variant:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="sd">/// Given an octal number like 0o500 and an [`Owner`],
</code><code class="sd">/// return a string like "r-x"
</code><code class="k">fn</code><code> </code><code class="nf">mk_triple</code><code class="p">(</code><code class="n">mode</code><code>:</code><code> </code><code class="kt">u32</code><code class="p">,</code><code class="w"> </code><code class="n">owner</code><code>:</code><code> </code><code class="nc">Owner</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">String</code><code> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-1" id="co_elless_island_CO13-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="p">[</code><code class="n">read</code><code class="p">,</code><code class="w"> </code><code class="n">write</code><code class="p">,</code><code class="w"> </code><code class="n">execute</code><code class="p">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">owner</code><code class="p">.</code><code class="n">masks</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-2" id="co_elless_island_CO13-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="fm">format!</code><code class="p">(</code><code class="w">
</code><code class="w">        </code><code class="s">"</code><code class="s">{}{}{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-3" id="co_elless_island_CO13-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">mode</code><code class="w"> </code><code class="o">&amp;</code><code class="w"> </code><code class="n">read</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">-</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">r</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-4" id="co_elless_island_CO13-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">mode</code><code class="w"> </code><code class="o">&amp;</code><code class="w"> </code><code class="n">write</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">-</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">w</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-5" id="co_elless_island_CO13-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">mode</code><code class="w"> </code><code class="o">&amp;</code><code class="w"> </code><code class="n">execute</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">-</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">x</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO13-6" id="co_elless_island_CO13-6"><img alt="6" src="assets/6.png"/></a><code class="w">
    </code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist nobreakinside">
<dt><a class="co" href="#co_elless_island_CO13-1" id="callout_elless_island_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The function<a data-primary="permissions" data-type="indexterm" id="id1801"/> takes a permissions <code>mode</code> and an <code>Owner</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO13-2" id="callout_elless_island_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Unpack the three mask values for this <code>owner</code>.<a data-primary="format! macro" data-type="indexterm" id="id1802"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO13-3" id="callout_elless_island_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Use the <code>format!</code> macro to create a new <code>String</code> to return.</p></dd>
<dt><a class="co" href="#co_elless_island_CO13-4" id="callout_elless_island_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>If the <code>mode</code> masked with the <code>read</code> value returns <code>0</code>, then the <em>read</em> bit is not set. Show a dash (<code>-</code>) when unset and <code>r</code> when set.</p></dd>
<dt><a class="co" href="#co_elless_island_CO13-5" id="callout_elless_island_CO13-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Likewise, mask the <code>mode</code> with the <code>write</code> value and display <code>w</code> if set and a dash otherwise.</p></dd>
<dt><a class="co" href="#co_elless_island_CO13-6" id="callout_elless_island_CO13-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Mask the <code>mode</code> with the <code>execute</code> value and return <code>x</code> if set and a dash otherwise.</p></dd>
</dl>

<p class="pagebreak-before">Following is the unit test for this function, which you can add to the <code>tests</code> module.<a data-primary="mk_triple helper function" data-secondary="unit test for in lsr" data-type="indexterm" id="id1803"/><a data-primary="unit tests" data-secondary="test_mk_triple function in lsr" data-type="indexterm" id="id1804"/>
Be sure to add <code>super::{mk_triple, Owner}</code> to the list of imports:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[test]</code><code class="w"/>
<code class="k">fn</code> <code class="nf">test_mk_triple</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">mk_triple</code><code class="p">(</code><code class="mo">0o751</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code>::<code class="n">User</code><code class="p">),</code><code class="w"> </code><code class="s">"rwx"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">mk_triple</code><code class="p">(</code><code class="mo">0o751</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code>::<code class="n">Group</code><code class="p">),</code><code class="w"> </code><code class="s">"r-x"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">mk_triple</code><code class="p">(</code><code class="mo">0o751</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code>::<code class="n">Other</code><code class="p">),</code><code class="w"> </code><code class="s">"--x"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">mk_triple</code><code class="p">(</code><code class="mo">0o600</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code>::<code class="n">Other</code><code class="p">),</code><code class="w"> </code><code class="s">"---"</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Finally, I can bring this all<a data-primary="format_mode function" data-type="indexterm" id="id1805"/> together in my <code>format_mode</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="sd">/// Given a file mode in octal format like 0o751,
</code><code class="sd">/// return a string like "rwxr-x--x"
</code><code class="k">fn</code><code> </code><code class="nf">format_mode</code><code class="p">(</code><code class="n">mode</code><code>:</code><code> </code><code class="kt">u32</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">String</code><code> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO14-1" id="co_elless_island_CO14-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="fm">format!</code><code class="p">(</code><code class="w">
</code><code class="w">        </code><code class="s">"</code><code class="s">{}{}{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO14-2" id="co_elless_island_CO14-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="n">mk_triple</code><code class="p">(</code><code class="n">mode</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code><code>::</code><code class="n">User</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO14-3" id="co_elless_island_CO14-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="n">mk_triple</code><code class="p">(</code><code class="n">mode</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code><code>::</code><code class="n">Group</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">mk_triple</code><code class="p">(</code><code class="n">mode</code><code class="p">,</code><code class="w"> </code><code class="n">Owner</code><code>::</code><code class="n">Other</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO14-1" id="callout_elless_island_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The function takes a <code>u32</code> value and returns a new string.</p></dd>
<dt><a class="co" href="#co_elless_island_CO14-2" id="callout_elless_island_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The returned string will be made of three triple values, like <code>rwx</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO14-3" id="callout_elless_island_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Create triples for user, group, and other.</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>You’ve seen throughout the book that Rust uses two slashes (<code>//</code>) to indicate that all text that follows on the line will be ignored. <a data-primary="comments" data-type="indexterm" id="id1806"/>This is commonly called a <em>comment</em> because it can be used to add commentary to your code, but it’s also a handy way to temporarily disable lines of code.<a data-primary="// (slashes), comments beginning with" data-type="indexterm" id="id1807"/> In the preceding functions, you may have noticed the use of three slashes (<code>///</code>) to create a special kind of comment that has the <a href="https://oreil.ly/VP1AV"><code>#[doc]</code> attribute</a>.<a data-primary="doc comments" data-type="indexterm" id="id1808"/><a data-primary="/// (slashes), to indicate documentation" data-type="indexterm" id="id1809"/> Note that the doc com­ment should precede the function declaration. Execute 
<span class="keep-together"><strong><code>cargo doc --open --document-private-items</code></strong></span> to have Cargo create documentation for your code. This should cause your web browser to open with HTML documentation as shown in <a data-type="xref" href="#fig_14.5">Figure 14-5</a>, and the triple-commented text should be displayed next to the function name.</p>
</div>

<figure><div class="figure" id="fig_14.5">
<img alt="clru 1405" src="assets/clru_1405.png"/>
<h6><span class="label">Figure 14-5. </span>The documentation created by Cargo will include comments that begin with three slashes.</h6>
</div></figure>

<p>Following is how I use the <code>format_mode</code> function <a data-primary="format_mode function" data-secondary="use in format_output function" data-type="indexterm" id="id1810"/><a data-primary="format_output function" data-type="indexterm" id="id1811"/>in the <code>format_output</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">format_output</code><code class="p">(</code><code class="n">paths</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="n">PathBuf</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="c1">//         1   2     3     4     5     6     7     8
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">fmt</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"</code><code class="s">{:&lt;}{:&lt;}  {:&gt;}  {:&lt;}  {:&lt;}  {:&gt;}  {:&lt;}  {:&lt;}</code><code class="s">"</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">table</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Table</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">fmt</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-1" id="co_elless_island_CO15-1"><img alt="1" src="assets/1.png"/></a><code class="w">

    </code><code class="k">for</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">metadata</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">path</code><code class="p">.</code><code class="n">metadata</code><code class="p">(</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-2" id="co_elless_island_CO15-2"><img alt="2" src="assets/2.png"/></a><code class="w">

        </code><code class="kd">let</code><code class="w"> </code><code class="n">uid</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">metadata</code><code class="p">.</code><code class="n">uid</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-3" id="co_elless_island_CO15-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">user</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_user_by_uid</code><code class="p">(</code><code class="n">uid</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">u</code><code class="o">|</code><code class="w"> </code><code class="n">u</code><code class="p">.</code><code class="n">name</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string_lossy</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">into_owned</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">uid</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">gid</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">metadata</code><code class="p">.</code><code class="n">gid</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-4" id="co_elless_island_CO15-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">group</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">get_group_by_gid</code><code class="p">(</code><code class="n">gid</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">g</code><code class="o">|</code><code class="w"> </code><code class="n">g</code><code class="p">.</code><code class="n">name</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_string_lossy</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">into_owned</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">            </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">|</code><code class="o">|</code><code class="w"> </code><code class="n">gid</code><code class="p">.</code><code class="n">to_string</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">file_type</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">path</code><code class="p">.</code><code class="n">is_dir</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">d</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="s">"</code><code class="s">-</code><code class="s">"</code><code class="w"> </code><code class="p">}</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-5" id="co_elless_island_CO15-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">perms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">format_mode</code><code class="p">(</code><code class="n">metadata</code><code class="p">.</code><code class="n">mode</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-6" id="co_elless_island_CO15-6"><img alt="6" src="assets/6.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">modified</code><code>:</code><code> </code><code class="nc">DateTime</code><code class="o">&lt;</code><code class="n">Local</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">DateTime</code><code>::</code><code class="n">from</code><code class="p">(</code><code class="n">metadata</code><code class="p">.</code><code class="n">modified</code><code class="p">(</code><code class="p">)</code><code class="o">?</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-7" id="co_elless_island_CO15-7"><img alt="7" src="assets/7.png"/></a><code class="w">

        </code><code class="n">table</code><code class="p">.</code><code class="n">add_row</code><code class="p">(</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-8" id="co_elless_island_CO15-8"><img alt="8" src="assets/8.png"/></a><code class="w">
            </code><code class="n">Row</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">file_type</code><code class="p">)</code><code class="w"> </code><code class="c1">// 1
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">perms</code><code class="p">)</code><code class="w"> </code><code class="c1">// 2
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">metadata</code><code class="p">.</code><code class="n">nlink</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><code class="c1">// 3 </code><a class="co" href="#callout_elless_island_CO15-9" id="co_elless_island_CO15-9"><img alt="9" src="assets/9.png"/></a><code class="c1">
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">user</code><code class="p">)</code><code class="w"> </code><code class="c1">// 4
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">group</code><code class="p">)</code><code class="w"> </code><code class="c1">// 5
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">metadata</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><code class="c1">// 6 </code><a class="co" href="#callout_elless_island_CO15-10" id="co_elless_island_CO15-10"><img alt="10" src="assets/10.png"/></a><code class="c1">
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">modified</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="s">"</code><code class="s">%b %d %y %H:%M</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><code class="c1">// 7 </code><a class="co" href="#callout_elless_island_CO15-11" id="co_elless_island_CO15-11"><img alt="11" src="assets/11.png"/></a><code class="c1">
</code><code class="w">                </code><code class="p">.</code><code class="n">with_cell</code><code class="p">(</code><code class="n">path</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="c1">// 8
</code><code class="w">        </code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="fm">format!</code><code class="p">(</code><code class="s">"</code><code class="s">{table}</code><code class="s">"</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO15-12" id="co_elless_island_CO15-12"><img alt="12" src="assets/12.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO15-1" id="callout_elless_island_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a new <a href="https://oreil.ly/z73wW"><code>tabular::Table</code></a> using the given format string.<a data-primary="tabular::Table struct" data-type="indexterm" id="id1812"/><a data-primary="Table struct" data-type="indexterm" id="id1813"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO15-2" id="callout_elless_island_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Attempt to get the entry’s metadata. This should not fail because of the earlier use of <code>fs::metadata</code>. <a data-primary="fs::metadata function" data-type="indexterm" id="id1814"/>This method is an alias to that function.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-3" id="callout_elless_island_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Get the user ID of the owner from the metadata. Attempt to convert to a user name and fall back on a string version of the ID.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-4" id="callout_elless_island_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Do likewise for the group ID and name.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-5" id="callout_elless_island_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Choose whether to print a <code>d</code> if the entry is a directory or a dash (<code>-</code>) otherwise.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-6" id="callout_elless_island_CO15-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Use the <code>format_mode</code> function to format the entry’s permissions.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-7" id="callout_elless_island_CO15-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Create a <code>DateTime</code> struct using the metadata’s <a href="https://oreil.ly/buVC9"><code>modified</code> value</a>.<a data-primary="DateTime struct" data-type="indexterm" id="id1815"/><a data-primary="modified value (metadata)" data-type="indexterm" id="id1816"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO15-8" id="callout_elless_island_CO15-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Add a new <a href="https://oreil.ly/Mrmvg"><code>Row</code></a> to the table using the given cells.<a data-primary="Row struct" data-type="indexterm" id="id1817"/><a data-primary="metadata::nlink" data-type="indexterm" id="id1818"/><a data-primary="links" data-type="indexterm" id="id1819"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO15-9" id="callout_elless_island_CO15-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/f2RyC"><code>metadata::nlink</code></a> to find the number of links.</p></dd>
<dt><a class="co" href="#co_elless_island_CO15-10" id="callout_elless_island_CO15-10"><img alt="10" src="assets/10.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/129cs"><code>metadata::len</code></a> to get the size.<a data-primary="metadata::len function" data-type="indexterm" id="id1820"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO15-11" id="callout_elless_island_CO15-11"><img alt="11" src="assets/11.png"/></a></dt>
<dd><p>Use <a href="https://oreil.ly/075dF"><code>strftime</code> format options</a> to display the modification time.<a data-primary="strftime format options" data-type="indexterm" id="id1821"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO15-12" id="callout_elless_island_CO15-12"><img alt="12" src="assets/12.png"/></a></dt>
<dd><p>Convert the table to a string to return.</p></dd>
</dl>

<p class="pagebreak-after">Finally, I bring it all <a data-primary="run function" data-secondary="lsr program" data-type="indexterm" id="id1822"/>together in the <code>run</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">find_files</code><code class="p">(</code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">paths</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">show_hidden</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO16-1" id="co_elless_island_CO16-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">if</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">long</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="fm">println!</code><code class="p">(</code><code class="s">"</code><code class="s">{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">format_output</code><code class="p">(</code><code class="o">&amp;</code><code class="n">paths</code><code class="p">)</code><code class="o">?</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO16-2" id="co_elless_island_CO16-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">for</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">paths</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO16-3" id="co_elless_island_CO16-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="fm">println!</code><code class="p">(</code><code class="s">"</code><code class="s">{}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">path</code><code class="p">.</code><code class="n">display</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO16-1" id="callout_elless_island_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Find all the entries in the given list of files and directories.</p></dd>
<dt><a class="co" href="#co_elless_island_CO16-2" id="callout_elless_island_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>If the user wants the long listing, print the results of <code>format_output</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO16-3" id="callout_elless_island_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Otherwise, print each path on a separate line.</p></dd>
</dl>

<p>At this point, the program passes all the tests, and you have implemented a simple replacement for <code>ls</code>.</p>
</div></section>






<section data-pdf-bookmark="Notes from the Testing Underground" data-type="sect1"><div class="sect1" id="id147">
<h1>Notes from the Testing Underground</h1>

<p>In this last chapter, I’d like you to consider some of the challenges of writing tests, as I hope this will become an integral part of your coding skills.<a data-primary="testing" data-secondary="notes from testing underground" data-type="indexterm" id="ix_tstnote"/>
For example, the output from your <code>lsr</code> program will <em>necessarily</em> always be different from what I see when I’m creating the tests because you will have different owners and modification times.
I’ve found that different systems will report different sizes for directories, and the column widths of the output will be different because you are likely to have shorter or longer user and group names.
The most that testing can do is verify that the filenames, permissions, and sizes are the expected values while assuming the layout is kosher.</p>

<p>If you read <em>tests/cli.rs</em>, you’ll see I borrowed some of the same ideas from the unit tests for the integration tests.<a data-primary="run_long function" data-type="indexterm" id="id1823"/><a data-primary="permissions" data-secondary="checking for" data-type="indexterm" id="id1824"/><a data-primary="paths" data-secondary="checking for file path" data-type="indexterm" id="id1825"/><a data-primary="size, checking for files" data-type="indexterm" id="id1826"/>
For the long listing, I created a <code>run_long</code> function to run for a particular file, checking for the permissions, size, and path:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run_long</code><code class="p">(</code><code class="n">filename</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">permissions</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">size</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-1" id="co_elless_island_CO17-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">cmd</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-2" id="co_elless_island_CO17-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">args</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">--long</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="p">]</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">assert</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">cmd</code><code class="p">.</code><code class="n">get_output</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">stdout</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-3" id="co_elless_island_CO17-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">parts</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">stdout</code><code class="p">.</code><code class="n">split_whitespace</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-4" id="co_elless_island_CO17-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">permissions</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-5" id="co_elless_island_CO17-5"><img alt="5" src="assets/5.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">size</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-6" id="co_elless_island_CO17-6"><img alt="6" src="assets/6.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">filename</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO17-7" id="co_elless_island_CO17-7"><img alt="7" src="assets/7.png"/></a><code class="w">
    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO17-1" id="callout_elless_island_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The function accepts the filename and the expected permissions and size.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-2" id="callout_elless_island_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Run <code>lsr</code> with the <code>--long</code> option for the given filename.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-3" id="callout_elless_island_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Convert <code>STDOUT</code> to UTF-8.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-4" id="callout_elless_island_CO17-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Break the output on whitespace and collect it into a vector.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-5" id="callout_elless_island_CO17-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Check that the first column is the expected permissions.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-6" id="callout_elless_island_CO17-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Check that the fifth column is the expected size.</p></dd>
<dt><a class="co" href="#co_elless_island_CO17-7" id="callout_elless_island_CO17-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Check that the last column is the given path.</p></dd>
</dl>

<p>I use this function like so:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[test]</code><code class="w"/>
<code class="k">fn</code> <code class="nf">fox_long</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">run_long</code><code class="p">(</code><code class="n">FOX</code><code class="p">,</code><code class="w"> </code><code class="s">"-rw-------"</code><code class="p">,</code><code class="w"> </code><code class="s">"45"</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Checking the directory listings is tricky, too.
I found I needed to ignore the directory sizes because different systems report different sizes.<a data-primary="dir_long utility function" data-type="indexterm" id="id1827"/>
Here is my <code>dir_long</code> function that handles this:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">allow(suspicious_double_ref_op)</code><code class="cp">]</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-1" id="co_elless_island_CO18-1"><img alt="1" src="assets/1.png"/></a><code class="w">
</code><code class="k">fn</code><code> </code><code class="nf">dir_long</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="o">&amp;</code><code class="kt">str</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="p">[</code><code class="p">(</code><code class="o">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-2" id="co_elless_island_CO18-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">cmd</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="p">.</code><code class="n">args</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">.</code><code class="n">assert</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-3" id="co_elless_island_CO18-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">cmd</code><code class="p">.</code><code class="n">get_output</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">stdout</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-4" id="co_elless_island_CO18-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">lines</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="o">&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">        </code><code class="n">stdout</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">s</code><code class="o">|</code><code class="w"> </code><code class="o">!</code><code class="n">s</code><code class="p">.</code><code class="n">is_empty</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-5" id="co_elless_island_CO18-5"><img alt="5" src="assets/5.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code class="p">.</code><code class="n">len</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-6" id="co_elless_island_CO18-6"><img alt="6" src="assets/6.png"/></a><code class="w">

    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">check</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="fm">vec!</code><code class="p">[</code><code class="p">]</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-7" id="co_elless_island_CO18-7"><img alt="7" src="assets/7.png"/></a><code class="w">
    </code><code class="k">for</code><code class="w"> </code><code class="n">line</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">parts</code><code>:</code><code> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">split_whitespace</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-8" id="co_elless_island_CO18-8"><img alt="8" src="assets/8.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">permissions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">size</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="n">permissions</code><code class="p">.</code><code class="n">chars</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">next</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="nb">Some</code><code class="p">(</code><code class="sc">'d'</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-9" id="co_elless_island_CO18-9"><img alt="9" src="assets/9.png"/></a><code class="w">
            </code><code class="n">_</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">check</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="p">(</code><code class="n">path</code><code class="p">,</code><code class="w"> </code><code class="n">permissions</code><code class="p">,</code><code class="w"> </code><code class="n">size</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">entry</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="fm">assert!</code><code class="p">(</code><code class="n">check</code><code class="p">.</code><code class="n">contains</code><code class="p">(</code><code class="n">entry</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO18-10" id="co_elless_island_CO18-10"><img alt="10" src="assets/10.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO18-1" id="callout_elless_island_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>This annotation asks Clippy to ignore the warning “using <code>.clone()</code> on a double reference, which returns <code>&amp;str</code> instead of cloning the inner type.”</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-2" id="callout_elless_island_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The function accepts the arguments and a slice of tuples with the expected results.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-3" id="callout_elless_island_CO18-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Run <code>lsr</code> with the given arguments and assert it is successful.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-4" id="callout_elless_island_CO18-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Convert <code>STDOUT</code> to a string.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-5" id="callout_elless_island_CO18-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Break <code>STDOUT</code> into lines, ignoring any empty lines.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-6" id="callout_elless_island_CO18-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Check that the number of lines matches the expected number.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-7" id="callout_elless_island_CO18-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Initialize a mutable vector of items to check.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-8" id="callout_elless_island_CO18-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Break the line on whitespace and extract the path, permissions, and size.</p></dd>
<dt><a class="co" href="#co_elless_island_CO18-9" id="callout_elless_island_CO18-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Ignore the size of directories.<a data-primary="Vec::contains" data-type="indexterm" id="id1828"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO18-10" id="callout_elless_island_CO18-10"><img alt="10" src="assets/10.png"/></a></dt>
<dd><p>Ensure that each of the expected paths, permissions, and sizes is present in the <code>check</code> vector using <a href="https://oreil.ly/PnrUd"><code>Vec::contains</code></a>.</p></dd>
</dl>

<p>I use the <code>dir_long</code> utility function<a data-primary="dir_long utility function" data-secondary="using in a test" data-type="indexterm" id="id1829"/> in a test like this:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">test</code><code class="cp">]</code><code class="w">
</code><code class="k">fn</code><code> </code><code class="nf">dir1_long_all</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">dir_long</code><code class="p">(</code><code class="w">
</code><code class="w">        </code><code class="o">&amp;</code><code class="p">[</code><code class="s">"</code><code class="s">-la</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">tests/inputs</code><code class="s">"</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO19-1" id="co_elless_island_CO19-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="o">&amp;</code><code class="p">[</code><code class="w">
</code><code class="w">            </code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-rw-r--r--</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">0</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO19-2" id="co_elless_island_CO19-2"><img alt="2" src="assets/2.png"/></a><code class="w">
            </code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/bustle.txt</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-rw-r--r--</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">193</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">            </code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/fox.txt</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-rw-------</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">45</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO19-3" id="co_elless_island_CO19-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/dir</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">drwxr-xr-x</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_elless_island_CO19-4" id="co_elless_island_CO19-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="p">(</code><code class="s">"</code><code class="s">tests/inputs/.hidden</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-rw-r--r--</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">0</code><code class="s">"</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="p">]</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_elless_island_CO19-1" id="callout_elless_island_CO19-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>These are the arguments to <code>lsr</code>.</p></dd>
<dt><a class="co" href="#co_elless_island_CO19-2" id="callout_elless_island_CO19-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <em>empty.txt</em> file should have permissions of <code>644</code> and a file size of <code>0</code>.<a data-primary="octal notation" data-type="indexterm" id="id1830"/><a data-primary="permissions" data-secondary="octal" data-type="indexterm" id="id1831"/></p></dd>
<dt><a class="co" href="#co_elless_island_CO19-3" id="callout_elless_island_CO19-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <em>fox.txt</em> file’s permissions should be set to <code>600</code> by <em>set-test-perms.sh</em>. If you forget to run this script, then you will fail this test.</p></dd>
<dt><a class="co" href="#co_elless_island_CO19-4" id="callout_elless_island_CO19-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <em>dir</em> entry should report <code>d</code> and permissions of <code>755</code>. Ignore the size.</p></dd>
</dl>

<p>In many ways, the tests for this program were as challenging as the program itself.
I hope I’ve shown throughout the book the importance of writing and using tests to ensure a working program.<a data-primary="testing" data-secondary="notes from testing underground" data-startref="ix_tstnote" data-type="indexterm" id="id1832"/><a data-primary="ls utility" data-secondary="writing lsr version" data-startref="ix_lswrsol" data-tertiary="solution" data-type="indexterm" id="id1833"/></p>
</div></section>






<section data-pdf-bookmark="Going Further" data-type="sect1"><div class="sect1" id="id154">
<h1>Going Further</h1>

<p>The challenge program works fairly differently from the native <code>ls</code> programs.
Modify your program <a data-primary="ls utility" data-secondary="writing lsr version" data-tertiary="going further" data-type="indexterm" id="id1834"/>to mimic the <code>ls</code> on your system, then start trying to implement all the other options, making sure that you add tests for every feature.
If you want inspiration, check out the source code for other Rust implementations of <code>ls</code>, such as <a href="https://oreil.ly/2ZWIe"><code>exa</code></a> and <a href="https://oreil.ly/u38PE"><code>lsd</code></a>.</p>

<p>Write Rust versions of the command-line utilities <code>basename</code> and <code>dirname</code>, which will print the filename or directory name of given inputs, respectively.
Start by reading the manual pages to decide which features your programs will implement.
Use a test-driven approach where you write tests for each feature you add to your programs.
Release your code to the world, and reap the fame and fortune that inevitably follow open source development.</p>

<p>In <a data-type="xref" href="ch07.html#ch07">Chapter 7</a>, I suggested writing a Rust version of <code>tree</code>, which will find and display the tree structure of files and directories.<a data-primary="tree command" data-secondary="writing Rust version of" data-type="indexterm" id="id1835"/>
The program can also display much of the same information as <code>ls</code>:</p>

<pre class="nobreakinside" data-type="programlisting">$ tree -pughD
.
├── [-rw-r--r-- kyclark  staff     193 May 31 16:43]  bustle.txt
├── [drwxr-xr-x kyclark  staff     128 Aug 10 18:08]  dir
│   └── [-rw-r--r-- kyclark  staff      45 May 31 16:43]  spiders.txt
├── [-rw-r--r-- kyclark  staff       0 Mar 19  2021]  empty.txt
└── [-rw------- kyclark  staff      45 Aug 12 10:29]  fox.txt

1 directory, 4 files</pre>

<p>Use what you learned from this chapter to write or expand that program.</p>
</div></section>






<section class="pagebreak-before less_space" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id148">
<h1>Summary</h1>

<p>One of my favorite parts of this challenge program is the formatting of the octal permission bits.
I also enjoyed finding all the other pieces of metadata that go into the long listing.
Consider what you did in this chapter:</p>

<ul>
<li>
<p>You learned how to summon the metadata of a file to find everything from the file’s owners and size to the last modification time.</p>
</li>
<li>
<p>You found that directory entries starting with a dot are normally hidden from view, leading to the existence of <em>dotfiles</em> and directories for hiding program data.<a data-primary="hidden files" data-type="indexterm" id="id1836"/></p>
</li>
<li>
<p>You delved into the mysteries of file permissions, octal notation, and bit masking and came through more knowledgeable about Unix file ownership.</p>
</li>
<li>
<p>You discovered how to add <code>impl</code> (implementation) to a custom type <code>Owner</code> as well as how to segregate this module into <em>src/owner.rs</em> and declare it with <code>mod owner</code> in <em>src/main.rs</em>.</p>
</li>
<li>
<p>You learned to use three slashes (<code>///</code>) to create doc comments that are included in the documentation created by Cargo and that can be read using <strong><code>cargo doc</code></strong>.</p>
</li>
<li>
<p>You saw how to use the <code>tabular</code> crate to create text tables.</p>
</li>
<li>
<p>You explored ways to write flexible tests for programs that can create different output on different systems and when run by different people.<a data-primary="ls utility" data-startref="ix_ls" data-type="indexterm" id="id1837"/></p>
</li>
</ul>
</div></section>
</div></section></body></html>