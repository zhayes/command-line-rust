<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head><title>Den of Uniquity</title><link href="epub.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e80a1ec8-ed8e-40f7-ba3d-26a647960341" name="Adept.expected.resource"/></head><body data-type="book"><section data-pdf-bookmark="Chapter 6. Den of Uniquity" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch06">
<h1><span class="label">Chapter 6. </span>Den of Uniquity</h1>

<blockquote>
<p>
There’s only one everything
</p>
<p data-type="attribution">
They Might Be Giants, “One Everything” (2008)
</p>
</blockquote>

<p>In this chapter, you will write a Rust version of the <code>uniq</code> program (pronounced <em>unique</em>), which will find the distinct lines of text from either a file or <code>STDIN</code>.<a data-primary="uniq program" data-type="indexterm" id="ix_uniq"/>
Among its many uses, it is often employed to count how many times each unique string is found.</p>

<p>Along the way, you will learn how to do the following:</p>

<ul>
<li>
<p>Write to a file or <code>STDOUT</code></p>
</li>
<li>
<p>Use a closure to capture a variable</p>
</li>
<li>
<p>Apply the don’t repeat yourself (DRY) concept</p>
</li>
<li>
<p>Use the <code>Write</code> trait and the <code>write!</code> and <code>writeln!</code> macros</p>
</li>
<li>
<p>Use temporary files</p>
</li>
<li>
<p>Indicate the lifetime of a variable</p>
</li>
</ul>






<section data-pdf-bookmark="How uniq Works" data-type="sect1"><div class="sect1" id="id58">
<h1>How uniq Works</h1>

<p>As usual, I’ll start by explaining how <code>uniq</code> works so that you understand what is expected of your program.<a data-primary="uniq program" data-secondary="how it works" data-type="indexterm" id="ix_uniqhow"/>
Following is part of the manual<a data-primary="BSD version" data-secondary="uniq program" data-type="indexterm" id="id760"/> page for the BSD version of <code>uniq</code>.
The challenge program in this chapter will only implement the reading of a file or <code>STDIN</code>, writing to a file or <code>STDOUT</code>, and counting the lines for the <code>-c</code> flag, but I include more of the documentation so that you can see the full scope of the program:</p>

<pre class="widows_orphans_33" data-type="programlisting">UNIQ(1)                   BSD General Commands Manual                  UNIQ(1)

NAME
     uniq -- report or filter out repeated lines in a file

SYNOPSIS
     uniq [-c | -d | -u] [-i] [-f num] [-s chars] [input_file [output_file]]

DESCRIPTION
     The uniq utility reads the specified input_file comparing adjacent lines,
     and writes a copy of each unique input line to the output_file.  If
     input_file is a single dash ('-') or absent, the standard input is read.
     If output_file is absent, standard output is used for output.  The second
     and succeeding copies of identical adjacent input lines are not written.
     Repeated lines in the input will not be detected if they are not adja-
     cent, so it may be necessary to sort the files first.

     The following options are available:

     -c      Precede each output line with the count of the number of times
             the line occurred in the input, followed by a single space.

     -d      Only output lines that are repeated in the input.

     -f num  Ignore the first num fields in each input line when doing compar-
             isons.  A field is a string of non-blank characters separated
             from adjacent fields by blanks.  Field numbers are one based,
             i.e., the first field is field one.

     -s chars
             Ignore the first chars characters in each input line when doing
             comparisons.  If specified in conjunction with the -f option, the
             first chars characters after the first num fields will be
             ignored.  Character numbers are one based, i.e., the first char-
             acter is character one.

     -u      Only output lines that are not repeated in the input.

     -i      Case insensitive comparison of lines.</pre>

<p>In the <em>06_uniqr/tests/inputs</em> directory of the book’s Git repository, you will find the following input files I’ll use for testing:</p>

<ul>
<li>
<p><em>empty.txt</em>: an empty file</p>
</li>
<li>
<p><em>one.txt</em>: a file with one line of text</p>
</li>
<li>
<p><em>two.txt</em>: a file with two lines of the same text</p>
</li>
<li>
<p><em>three.txt</em>: a file with 13 lines of 4 unique values</p>
</li>
<li>
<p><em>skip.txt</em>: a file with four lines of two unique values plus an empty line</p>
</li>
</ul>

<p>The other files <em>t[1–6].txt</em> are examples from <a href="https://oreil.ly/I9QA5">a Perl program</a> used to test the GNU version.
These are generated by the <em>mk-outs.sh</em> file:</p>

<pre data-type="programlisting">$ cat mk-outs.sh
#!/usr/bin/env bash

ROOT="tests/inputs"
OUT_DIR="tests/expected"

[[ ! -d "$OUT_DIR" ]] &amp;&amp; mkdir -p "$OUT_DIR"

# Cf https://github.com/coreutils/coreutils/blob/master/tests/misc/uniq.pl
echo -ne "a\na\n"    &gt; $ROOT/t1.txt <a class="co" href="#callout_den_of_uniquity_CO1-1" id="co_den_of_uniquity_CO1-1"><img alt="1" src="assets/1.png"/></a>
echo -ne "a\na"      &gt; $ROOT/t2.txt <a class="co" href="#callout_den_of_uniquity_CO1-2" id="co_den_of_uniquity_CO1-2"><img alt="2" src="assets/2.png"/></a>
echo -ne "a\nb"      &gt; $ROOT/t3.txt <a class="co" href="#callout_den_of_uniquity_CO1-3" id="co_den_of_uniquity_CO1-3"><img alt="3" src="assets/3.png"/></a>
echo -ne "a\na\nb"   &gt; $ROOT/t4.txt <a class="co" href="#callout_den_of_uniquity_CO1-4" id="co_den_of_uniquity_CO1-4"><img alt="4" src="assets/4.png"/></a>
echo -ne "b\na\na\n" &gt; $ROOT/t5.txt <a class="co" href="#callout_den_of_uniquity_CO1-5" id="co_den_of_uniquity_CO1-5"><img alt="5" src="assets/5.png"/></a>
echo -ne "a\nb\nc\n" &gt; $ROOT/t6.txt <a class="co" href="#callout_den_of_uniquity_CO1-6" id="co_den_of_uniquity_CO1-6"><img alt="6" src="assets/6.png"/></a>

for FILE in $ROOT/*.txt; do
    BASENAME=$(basename "$FILE")
    uniq      $FILE &gt; ${OUT_DIR}/${BASENAME}.out
    uniq -c   $FILE &gt; ${OUT_DIR}/${BASENAME}.c.out
    uniq    &lt; $FILE &gt; ${OUT_DIR}/${BASENAME}.stdin.out
    uniq -c &lt; $FILE &gt; ${OUT_DIR}/${BASENAME}.stdin.c.out
done</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO1-1" id="callout_den_of_uniquity_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Two lines each ending with a newline</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO1-2" id="callout_den_of_uniquity_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>No trailing newline on last line</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO1-3" id="callout_den_of_uniquity_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Two different lines, no trailing newline</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO1-4" id="callout_den_of_uniquity_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Two lines the same; last is different with no trailing newline</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO1-5" id="callout_den_of_uniquity_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Two different values with newlines on each</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO1-6" id="callout_den_of_uniquity_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Three different values with newlines on each</p></dd>
</dl>

<p>To demonstrate <code>uniq</code>, note that it will print nothing when given an empty file:</p>

<pre data-type="programlisting">$ uniq tests/inputs/empty.txt</pre>

<p>Given a file with just one line, the one line will be printed:</p>

<pre data-type="programlisting">$ uniq tests/inputs/one.txt
a</pre>

<p>It will also print the number of times a line occurs before the line when run with the 
<span class="keep-together"><code>-c</code></span> option.
The count is right-justified in a field four characters wide and is followed by a single space and then the line of text:</p>

<pre data-type="programlisting">$ uniq -c tests/inputs/one.txt
   1 a</pre>

<p>The file <em>tests/inputs/two.txt</em> contains two duplicate lines:</p>

<pre data-type="programlisting">$ cat tests/inputs/two.txt
a
a</pre>

<p>Given this input, <code>uniq</code> will emit one line:</p>

<pre data-type="programlisting">$ uniq tests/inputs/two.txt
a</pre>

<p>With the <code>-c</code> option, <code>uniq</code> will also include the count of unique lines:</p>

<pre data-type="programlisting">$ uniq -c tests/inputs/two.txt
   2 a</pre>

<p>A longer input file shows that <code>uniq</code> only considers the lines in order and not globally.
For example, the value <em>a</em> appears four times in this input file:</p>

<pre data-type="programlisting">$ cat tests/inputs/three.txt
<strong>a</strong>
<strong>a</strong>
b
b
<strong>a</strong>
c
c
c
<strong>a</strong>
d
d
d
d</pre>

<p>When counting, <code>uniq</code> starts over at 1 each time it<a data-primary="counts" data-secondary="counting in uniq" data-type="indexterm" id="id761"/> sees a new string.
Since <em>a</em> occurs in three different places in the input file, it will also appear three times in the output:</p>

<pre data-type="programlisting">$ uniq -c tests/inputs/three.txt
   <strong>2 a</strong>
   2 b
   <strong>1 a</strong>
   3 c
   <strong>1 a</strong>
   4 d</pre>

<p>If you want the actual unique values, you must first sort the input, which can be done with the aptly named <code>sort</code> command.<a data-primary="sort command" data-type="indexterm" id="id762"/>
In the following output, you’ll finally see that <em>a</em> occurs a total of four times in the input file:</p>

<pre data-type="programlisting">$ sort tests/inputs/three.txt | uniq -c
   <strong>4 a</strong>
   2 b
   3 c
   4 d</pre>

<p>The file <em>tests/inputs/skip.txt</em> contains a blank line:</p>

<pre data-type="programlisting">$ cat tests/inputs/skip.txt
a

a
b</pre>

<p>The blank line acts just like any other value, and so it will reset the counter:</p>

<pre data-type="programlisting">$ uniq -c tests/inputs/skip.txt
   1 a
   1
   1 a
   1 b</pre>

<p>If you study the Synopsis of the usage closely, you’ll see a very subtle indication of how to write the output to a file.<a data-primary="input files" data-secondary="uniq program" data-type="indexterm" id="id763"/><a data-primary="output files" data-secondary="uniq program" data-type="indexterm" id="id764"/><a data-primary="[] (square brackets)" data-secondary="use with input_file and output_file" data-type="indexterm" id="id765"/>
Notice how <code>input_file</code> and <code>output_file</code> in the following are grouped inside square brackets to indicate that they are optional <em>as a pair</em>.
That is, if you provide <code>input_file</code>, you may also optionally provide <code>output​_file</code>:</p>

<pre data-type="programlisting">uniq [-c | -d | -u] [-i] [-f num] [-s chars] <strong>[input_file [output_file]]</strong></pre>

<p>For example, I can count <em>tests/inputs/two.txt</em> and place the output into <em>out</em>:</p>

<pre data-type="programlisting">$ uniq -c tests/inputs/two.txt out
$ cat out
      2 a</pre>

<p>With no <a data-primary="STDIN" data-secondary="reading from with uniq" data-type="indexterm" id="id766"/>positional arguments, <code>uniq</code> will read from <code>STDIN</code> by default:</p>

<pre data-type="programlisting">$ cat tests/inputs/two.txt | uniq -c
      2 a</pre>

<p>If you want to read from <code>STDIN</code> <em>and</em> indicate the output filename, you must use a dash (<code>-</code>) for the input filename:</p>

<pre data-type="programlisting">$ cat tests/inputs/two.txt | uniq -c - out
$ cat out
      2 a</pre>

<p>The GNU version works <a data-primary="GNU version" data-secondary="uniq program" data-type="indexterm" id="id767"/>basically the same while also providing many more options:</p>

<pre data-type="programlisting">$ uniq --help
Usage: uniq [OPTION]... [INPUT [OUTPUT]]
Filter adjacent matching lines from INPUT (or standard input),
writing to OUTPUT (or standard output).

With no options, matching lines are merged to the first occurrence.

Mandatory arguments to long options are mandatory for short options too.
  -c, --count           prefix lines by the number of occurrences
  -d, --repeated        only print duplicate lines, one for each group
  -D, --all-repeated[=METHOD]  print all duplicate lines
                          groups can be delimited with an empty line
                          METHOD={none(default),prepend,separate}
  -f, --skip-fields=N   avoid comparing the first N fields
      --group[=METHOD]  show all items, separating groups with an empty line
                          METHOD={separate(default),prepend,append,both}
  -i, --ignore-case     ignore differences in case when comparing
  -s, --skip-chars=N    avoid comparing the first N characters
  -u, --unique          only print unique lines
  -z, --zero-terminated  end lines with 0 byte, not newline
  -w, --check-chars=N   compare no more than N characters in lines
      --help     display this help and exit
      --version  output version information and exit

A field is a run of blanks (usually spaces and/or TABs), then nonblank
characters.  Fields are skipped before chars.

Note: 'uniq' does not detect repeated lines unless they are adjacent.
You may want to sort the input first, or use 'sort -u' without 'uniq'.
Also, comparisons honor the rules specified by 'LC_COLLATE'.</pre>

<p>As you can see, both the BSD and GNU versions have many more options, but this is as much as the challenge program is expected to implement.<a data-primary="uniq program" data-secondary="how it works" data-startref="ix_uniqhow" data-type="indexterm" id="id768"/></p>
</div></section>






<section data-pdf-bookmark="Getting Started" data-type="sect1"><div class="sect1" id="id156">
<h1>Getting Started</h1>

<p>This chapter’s challenge program should be called <code>uniqr</code> (pronounced <em>you-neek-er</em>) for a Rust version of <code>uniq</code>.<a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="getting started" data-type="indexterm" id="id769"/>
Start by running <strong><code>cargo new uniqr</code></strong>, then modify your <em>Cargo.toml</em> to add the following dependencies:</p>

<pre data-code-language="toml" data-type="programlisting"><code class="k">[</code><code class="k">dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">anyhow</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.0.79</code><code class="s2">"</code><code class="w">
</code><code class="n">clap</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">version</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">4.5.0</code><code class="s2">"</code><code class="p">,</code><code class="w"> </code><code class="n">features</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"</code><code class="s2">derive</code><code class="s2">"</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">

</code><code class="k">[</code><code class="k">dev-dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">assert_cmd</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">2.0.13</code><code class="s2">"</code><code class="w">
</code><code class="n">predicates</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">3.0.4</code><code class="s2">"</code><code class="w">
</code><code class="n">pretty_assertions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">1.4.0</code><code class="s2">"</code><code class="w">
</code><code class="n">tempfile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">3.10.0</code><code class="s2">"</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO2-1" id="co_den_of_uniquity_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">
</code><code class="n">rand</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.8.5</code><code class="s2">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO2-1" id="callout_den_of_uniquity_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The tests will create temporary files using the <a href="https://oreil.ly/AYcMa"><code>tempfile</code> crate</a>.</p></dd>
</dl>

<p>Copy the book’s <em>06_uniqr/tests</em> directory into your project, and then run <strong><code>cargo test</code></strong> to ensure that the program compiles and the tests run and fail.</p>








<section class="less_space pagebreak-before" data-pdf-bookmark="Defining the Arguments" data-type="sect2"><div class="sect2" id="id59">
<h2>Defining the Arguments</h2>

<p>Update your <em>src/main.rs</em> to add the<a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="defining the arguments" data-type="indexterm" id="ix_uniqwrarg"/><a data-primary="Args struct" data-secondary="representing arguments in uniqr" data-type="indexterm" id="id770"/> following <code>Args</code> structure to represent the program’s arguments:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[</code><code class="cp">derive(Debug)</code><code class="cp">]</code><code class="w">
</code><code class="k">struct</code><code> </code><code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">in_file</code><code>:</code><code> </code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO3-1" id="co_den_of_uniquity_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">out_file</code><code>:</code><code> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO3-2" id="co_den_of_uniquity_CO3-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">count</code><code>:</code><code> </code><code class="kt">bool</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO3-3" id="co_den_of_uniquity_CO3-3"><img alt="3" src="assets/3.png"/></a><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO3-1" id="callout_den_of_uniquity_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>This is the input filename to read, which may be <code>STDIN</code> if the filename is a dash.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO3-2" id="callout_den_of_uniquity_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The output will be written either to an optional output filename or <code>STDOUT</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO3-3" id="callout_den_of_uniquity_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>count</code> is a Boolean for whether or not to print the counts of each line.</p></dd>
</dl>

<p>If you want to use the <a data-primary="derive pattern" data-secondary="using in uniqr program" data-type="indexterm" id="id771"/>derive pattern, then annotate the <code>Args</code> as needed.
For the builder pattern, you <a data-primary="builder pattern" data-secondary="writing get_args function to use in uniqr" data-type="indexterm" id="id772"/>can start from the following skeleton for <code>get_args</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_args</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code>::<code class="n">new</code><code class="p">(</code><code class="s">"uniqr"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"0.1.0"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"Ken Youens-Clark &lt;kyclark@gmail.com&gt;"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"Rust version of `uniq`"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="c1">// What goes here?</code>
<code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">();</code><code class="w"/>

<code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">in_file</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">out_file</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">        </code><code class="n">count</code>: <code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You can start your <code>main</code> by printing the arguments, parsing them however you like as in previous chapters:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">args</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Args</code>::<code class="n">parse</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="fm">println!</code><code class="p">(</code><code class="s">"{:?}"</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Your program should be able<a data-primary="usage statement" data-secondary="uniqr program" data-type="indexterm" id="id773"/> to produce the following usage:</p>

<pre data-type="programlisting">$ cargo run -- -h
Rust version of `uniq`

Usage: uniqr [OPTIONS] [IN_FILE] [OUT_FILE]

Arguments:
  [IN_FILE]   Input file [default: -] <a class="co" href="#callout_den_of_uniquity_CO4-1" id="co_den_of_uniquity_CO4-1"><img alt="1" src="assets/1.png"/></a>
  [OUT_FILE]  Output file <a class="co" href="#callout_den_of_uniquity_CO4-2" id="co_den_of_uniquity_CO4-2"><img alt="2" src="assets/2.png"/></a>

Options:
  -c, --count    Show counts <a class="co" href="#callout_den_of_uniquity_CO4-3" id="co_den_of_uniquity_CO4-3"><img alt="3" src="assets/3.png"/></a>
  -h, --help     Print help
  -V, --version  Print version</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO4-1" id="callout_den_of_uniquity_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The input file is the first positional argument and defaults to a dash (<code>-</code>).</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO4-2" id="callout_den_of_uniquity_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The output file is the second positional argument and is optional.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO4-3" id="callout_den_of_uniquity_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>-c|--count</code> flag is optional.</p></dd>
</dl>

<p>By default the program<a data-primary="STDIN" data-secondary="uniqr program reading from" data-type="indexterm" id="id774"/> will read from <code>STDIN</code>, which can be represented using a dash:</p>

<pre data-type="programlisting">$ cargo run
Args { in_file: "-", out_file: None, count: false }</pre>

<p>The first positional argument <a data-primary="optional arguments" data-secondary="optional positional parameters" data-type="indexterm" id="id775"/><a data-primary="positional arguments" data-secondary="optional" data-type="indexterm" id="id776"/>should be interpreted as the input file and the second positional argument as the output file.<sup><a data-type="noteref" href="ch06.html#id777" id="id777-marker">1</a></sup>
Note that <code>clap</code> can handle options <a data-primary="clap utility" data-secondary="handling options before or after positional arguments" data-type="indexterm" id="id778"/>either before or after positional arguments:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/one.txt out --count
Args { in_file: "tests/inputs/one.txt", out_file: Some("out"), count: true }</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Take a moment to finish the parsing of your arguments before reading further.</p>
</div>

<p>I assume you are an upright and moral person who figured out the parsing code on your own, so I will now<a data-primary="get_args function" data-secondary="uniqr program" data-type="indexterm" id="id779"/> share my solution, starting with the builder pattern.<a data-primary="builder pattern" data-secondary="writing get_args function to use in uniqr" data-type="indexterm" id="id780"/>
The following code requires <code>use clap::{Arg, ArgAction, Command}</code> and is similar to previous versions, so I won’t comment:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">get_args</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">matches</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code>::<code class="n">new</code><code class="p">(</code><code class="s">"uniqr"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">version</code><code class="p">(</code><code class="s">"0.1.0"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">author</code><code class="p">(</code><code class="s">"Ken Youens-Clark &lt;kyclark@gmail.com&gt;"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">about</code><code class="p">(</code><code class="s">"Rust version of `uniq`"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"in_file"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"IN_FILE"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Input file"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">default_value</code><code class="p">(</code><code class="s">"-"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"out_file"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">value_name</code><code class="p">(</code><code class="s">"OUT_FILE"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Output file"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="w"/>
<code class="w">            </code><code class="n">Arg</code>::<code class="n">new</code><code class="p">(</code><code class="s">"count"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">short</code><code class="p">(</code><code class="sc">'c'</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">long</code><code class="p">(</code><code class="s">"count"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">action</code><code class="p">(</code><code class="n">ArgAction</code>::<code class="n">SetTrue</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">.</code><code class="n">help</code><code class="p">(</code><code class="s">"Show counts"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">.</code><code class="n">get_matches</code><code class="p">();</code><code class="w"/>

<code class="w">    </code><code class="n">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">in_file</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_one</code><code class="p">(</code><code class="s">"in_file"</code><code class="p">).</code><code class="n">cloned</code><code class="p">().</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"/>
<code class="w">        </code><code class="n">out_file</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_one</code><code class="p">(</code><code class="s">"out_file"</code><code class="p">).</code><code class="n">cloned</code><code class="p">(),</code><code class="w"/>
<code class="w">        </code><code class="n">count</code>: <code class="nc">matches</code><code class="p">.</code><code class="n">get_flag</code><code class="p">(</code><code class="s">"count"</code><code class="p">),</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The derive <a data-primary="derive pattern" data-secondary="using in uniqr program" data-type="indexterm" id="id781"/><a data-primary="clap::Parser trait" data-type="indexterm" id="id782"/><a data-primary="Parser trait" data-type="indexterm" id="id783"/>pattern requires <code>use clap::Parser</code> and is as follows:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="cp">#[derive(Debug, Parser)]</code><code class="w"/>
<code class="cp">#[command(author, version, about)]</code><code class="w"/>
<code class="sd">/// Rust version of `uniq`</code>
<code class="k">struct</code> <code class="nc">Args</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="sd">/// Input file</code>
<code class="w">    </code><code class="cp">#[arg(value_name = </code><code class="s">"IN_FILE"</code><code class="cp">, default_value = </code><code class="s">"-"</code><code class="cp">)]</code><code class="w"/>
<code class="w">    </code><code class="n">in_file</code>: <code class="nb">String</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Output file</code>
<code class="w">    </code><code class="cp">#[arg(value_name = </code><code class="s">"OUT_FILE"</code><code class="cp">)]</code><code class="w"/>
<code class="w">    </code><code class="n">out_file</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"/>

<code class="w">    </code><code class="sd">/// Show counts</code>
<code class="w">    </code><code class="cp">#[arg(short, long)]</code><code class="w"/>
<code class="w">    </code><code class="n">count</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
</div></section>








<section data-pdf-bookmark="Testing the Program" data-type="sect2"><div class="sect2" id="id60">
<h2>Testing the Program</h2>

<p>The test suite in <em>tests/cli.rs</em> is fairly large, containing<a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="testing the program" data-type="indexterm" id="ix_uniqwrtst"/><a data-primary="testing" data-secondary="of uniqr program" data-secondary-sortas="uniqr" data-type="indexterm" id="ix_tstuniqr"/><a data-primary="input files" data-secondary="uniqr program" data-type="indexterm" id="id784"/><a data-primary="output files" data-secondary="uniqr program" data-type="indexterm" id="id785"/> 78 tests that check the program under the following conditions:</p>

<ul>
<li>
<p>Input file as the only positional argument, check <code>STDOUT</code></p>
</li>
<li>
<p>Input file as a positional argument with <code>--count</code> option, check <code>STDOUT</code></p>
</li>
<li>
<p>Input from <code>STDIN</code> with no positional arguments, check <code>STDOUT</code></p>
</li>
<li>
<p>Input from <code>STDIN</code> with <code>--count</code> and no positional arguments, check <code>STDOUT</code></p>
</li>
<li>
<p>Input and output files as positional arguments, check the output file</p>
</li>
<li>
<p>Input and output files as positional arguments with <code>--count</code>, check the output file<a data-primary="counts" data-secondary="--count option for uniqr input and output files" data-secondary-sortas="count" data-type="indexterm" id="id786"/></p>
</li>
<li>
<p>Input from <code>STDIN</code> and output files as positional arguments with <code>--count</code>, check the output file</p>
</li>
</ul>

<p>Given how large and complicated the tests became, you may be interested to see how I structured <em>tests/cli.rs</em>, which starts with the following:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">use</code><code class="w"> </code><code class="n">anyhow</code><code>::</code><code class="nb">Result</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">assert_cmd</code><code>::</code><code class="n">Command</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">predicates</code><code>::</code><code class="n">prelude</code><code>:</code><code>:</code><code class="o">*</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">pretty_assertions</code><code>::</code><code class="n">assert_eq</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">rand</code><code>:</code><code>:</code><code class="p">{</code><code class="n">distributions</code><code>::</code><code class="n">Alphanumeric</code><code class="p">,</code><code class="w"> </code><code class="n">Rng</code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">std</code><code>::</code><code class="n">fs</code><code class="p">;</code><code class="w">
</code><code class="k">use</code><code class="w"> </code><code class="n">tempfile</code><code>::</code><code class="n">NamedTempFile</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO5-1" id="co_den_of_uniquity_CO5-1"><img alt="1" src="assets/1.png"/></a><code class="w">

</code><code class="k">struct</code><code> </code><code class="nc">Test</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO5-2" id="co_den_of_uniquity_CO5-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">input</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="o">'</code><code class="nb">static</code><code> </code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">out</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="o">'</code><code class="nb">static</code><code> </code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">out_count</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="o">'</code><code class="nb">static</code><code> </code><code class="kt">str</code><code class="p">,</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO5-1" id="callout_den_of_uniquity_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>This is used to create temporary output files.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO5-2" id="callout_den_of_uniquity_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>A struct to define the input files and expected output values with and without the counts.</p></dd>
</dl>

<p>Note the use of <code>'static</code> to denote the lifetime of the values.<a data-primary="static annotation, denoting lifetime of values" data-type="indexterm" id="id787"/><a data-primary="lifetime specifiers for variables" data-type="indexterm" id="id788"/>
The <em>lifetime</em> refers to how long a value is valid for borrowing throughout a program.
I want to define structs with <code>&amp;str</code> values, and the Rust compiler would like to know exactly how long the values are expected to stick around relative to one another.
The <code>'static</code> annotation shows that this data will live for the entire lifetime of the program.
If you remove it and run the tests, you’ll see errors from the compiler along with a suggestion of how to fix it:</p>

<pre data-type="programlisting">error[E0106]: missing lifetime specifier
  --&gt; tests/cli.rs:10:12
   |
10 |     input: &amp;str,
   |            ^ expected named lifetime parameter
   |
help: consider introducing a named lifetime parameter</pre>

<p class="pagebreak-before">Next, I define some constant values I need for testing:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">const</code><code class="w"> </code><code class="n">PRG</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code> </code><code class="o">=</code><code class="w"> </code><code class="s">"</code><code class="s">uniqr</code><code class="s">"</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO6-1" id="co_den_of_uniquity_CO6-1"><img alt="1" src="assets/1.png"/></a><code class="w">

</code><code class="k">const</code><code class="w"> </code><code class="n">EMPTY</code><code>:</code><code> </code><code class="nc">Test</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Test</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="n">input</code><code>:</code><code> </code><code class="s">"</code><code class="s">tests/inputs/empty.txt</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO6-2" id="co_den_of_uniquity_CO6-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">out</code><code>:</code><code> </code><code class="s">"</code><code class="s">tests/inputs/empty.txt.out</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO6-3" id="co_den_of_uniquity_CO6-3"><img alt="3" src="assets/3.png"/></a><code class="w">
    </code><code class="n">out_count</code><code>:</code><code> </code><code class="s">"</code><code class="s">tests/inputs/empty.txt.c.out</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO6-4" id="co_den_of_uniquity_CO6-4"><img alt="4" src="assets/4.png"/></a><code class="w">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO6-1" id="callout_den_of_uniquity_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The name of the program being tested</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO6-2" id="callout_den_of_uniquity_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The location of the input file for this test</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO6-3" id="callout_den_of_uniquity_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The location of the output file without the counts</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO6-4" id="callout_den_of_uniquity_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The location of the output file with the counts</p></dd>
</dl>

<p>After the declaration of <code>EMPTY</code>, there are many more <code>Test</code> structures followed by several helper functions.<a data-primary="run function" data-secondary="uniqr program" data-type="indexterm" id="id789"/>
The <code>run</code> function will use <code>Test.input</code> as an input file and will compare <code>STDOUT</code> to the contents of the <code>Test.out</code> file:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">test</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">Test</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO7-1" id="co_den_of_uniquity_CO7-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">out</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO7-2" id="co_den_of_uniquity_CO7-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">output</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO7-3" id="co_den_of_uniquity_CO7-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">input</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">output</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">fail</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">status</code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">stdout</code><code class="p">)</code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">invalid UTF-8</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">stdout</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO7-4" id="co_den_of_uniquity_CO7-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO7-1" id="callout_den_of_uniquity_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The function accepts a <code>Test</code> and returns a <code>Result</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO7-2" id="callout_den_of_uniquity_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Try to read the expected output file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO7-3" id="callout_den_of_uniquity_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Try to run the program with the input file as an argument, and verify it ran 
<span class="keep-together">successfully</span>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO7-4" id="callout_den_of_uniquity_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Compare <code>STDOUT</code> to the expected value.</p></dd>
</dl>

<p>The <code>run_count</code> helper function works<a data-primary="run_count helper function" data-type="indexterm" id="id790"/> very similarly, but this time it tests for the counting:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run_count</code><code class="p">(</code><code class="n">test</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">Test</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">out_count</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO8-1" id="co_den_of_uniquity_CO8-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">output</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">args</code><code class="p">(</code><code class="p">[</code><code class="n">test</code><code class="p">.</code><code class="n">input</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">-c</code><code class="s">"</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO8-2" id="co_den_of_uniquity_CO8-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">output</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">fail</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">status</code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">stdout</code><code class="p">)</code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">invalid UTF-8</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">stdout</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO8-1" id="callout_den_of_uniquity_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Read the <code>Test.out_count</code> file for the expected output.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO8-2" id="callout_den_of_uniquity_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Pass both the <code>Test.input</code> value and the flag <code>-c</code> to count the lines.</p></dd>
</dl>

<p>The <code>run_stdin</code> function <a data-primary="run_stdin function" data-type="indexterm" id="id791"/>will supply the input to the program through <code>STDIN</code>:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run_stdin</code><code class="p">(</code><code class="n">test</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">Test</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">input</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">input</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO9-1" id="co_den_of_uniquity_CO9-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">out</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO9-2" id="co_den_of_uniquity_CO9-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">output</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO9-3" id="co_den_of_uniquity_CO9-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">write_stdin</code><code class="p">(</code><code class="n">input</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">output</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">fail</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">status</code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">stdout</code><code class="p">)</code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">invalid UTF-8</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">stdout</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO9-4" id="co_den_of_uniquity_CO9-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO9-1" id="callout_den_of_uniquity_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Try to read the <code>Test.input</code> file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO9-2" id="callout_den_of_uniquity_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Try to read the <code>Test.out</code> file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO9-3" id="callout_den_of_uniquity_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Pass the <code>input</code> through <code>STDIN</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO9-4" id="callout_den_of_uniquity_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Verify that <code>STDOUT</code> is the expected value.</p></dd>
</dl>

<p>The <code>run_stdin_count</code> function tests both<a data-primary="run_stdin_count function" data-type="indexterm" id="id792"/> reading from <code>STDIN</code> and counting the lines:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run_stdin_count</code><code class="p">(</code><code class="n">test</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">Test</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">input</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">input</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">out_count</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">output</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO10-1" id="co_den_of_uniquity_CO10-1"><img alt="1" src="assets/1.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">arg</code><code class="p">(</code><code class="s">"</code><code class="s">--count</code><code class="s">"</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">write_stdin</code><code class="p">(</code><code class="n">input</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">output</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">fail</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert!</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">status</code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">stdout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">from_utf8</code><code class="p">(</code><code class="n">output</code><code class="p">.</code><code class="n">stdout</code><code class="p">)</code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"</code><code class="s">invalid UTF-8</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="n">stdout</code><code class="p">,</code><code class="w"> </code><code class="n">expected</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO10-2" id="co_den_of_uniquity_CO10-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO10-1" id="callout_den_of_uniquity_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Run the program with the long <code>--count</code> flag, feed the input to <code>STDIN</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO10-2" id="callout_den_of_uniquity_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Verify that <code>STDOUT</code> is correct.</p></dd>
</dl>

<p>The <code>run_outfile</code> function checks that the program accepts both the input and output files as positional arguments.<a data-primary="run_outfile function" data-type="indexterm" id="id793"/>
This is somewhat more interesting as I needed to use temporary files in the testing because Rust will run the tests in parallel.
If I were to use the same dummy filename like <em>blargh</em> to write all the output files, the tests would overwrite one another’s output.<a data-primary="tempfile::NamedTempFile" data-type="indexterm" id="id794"/>
To get around this, I use the <a href="https://oreil.ly/BnbCk"><code>tempfile::NamedTempFile</code></a> to get a dynamically generated temporary filename that will automatically be removed when I finish:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run_outfile</code><code class="p">(</code><code class="n">test</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="nc">Test</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="n">test</code><code class="p">.</code><code class="n">out</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">outfile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">NamedTempFile</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO11-1" id="co_den_of_uniquity_CO11-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="n">outpath</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">outfile</code><code class="p">.</code><code class="n">path</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">to_str</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO11-2" id="co_den_of_uniquity_CO11-2"><img alt="2" src="assets/2.png"/></a><code class="w">

    </code><code class="n">Command</code><code>::</code><code class="n">cargo_bin</code><code class="p">(</code><code class="n">PRG</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO11-3" id="co_den_of_uniquity_CO11-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="p">.</code><code class="n">args</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[</code><code class="n">test</code><code class="p">.</code><code class="n">input</code><code class="p">,</code><code class="w"> </code><code class="n">outpath</code><code class="p">]</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">assert</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">success</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">stdout</code><code class="p">(</code><code class="s">"</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">contents</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fs</code><code>::</code><code class="n">read_to_string</code><code class="p">(</code><code class="o">&amp;</code><code class="n">outpath</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO11-4" id="co_den_of_uniquity_CO11-4"><img alt="4" src="assets/4.png"/></a><code class="w">
    </code><code class="fm">assert_eq!</code><code class="p">(</code><code class="o">&amp;</code><code class="n">expected</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">contents</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO11-5" id="co_den_of_uniquity_CO11-5"><img alt="5" src="assets/5.png"/></a><code class="w">

    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO11-1" id="callout_den_of_uniquity_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Try to get a named temporary file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO11-2" id="callout_den_of_uniquity_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Get the <a href="https://oreil.ly/BBq4n"><code>path</code></a> to the file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO11-3" id="callout_den_of_uniquity_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Run the program with the input and output filenames as arguments, then verify there is nothing in <code>STDOUT</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO11-4" id="callout_den_of_uniquity_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Try to read the output file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO11-5" id="callout_den_of_uniquity_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Check that the contents of the output file match the expected value.</p></dd>
</dl>

<p>The next two functions are variations on what I’ve already shown, adding in the 
<span class="keep-together"><code>--count</code></span> flag and finally asking the program to read from <code>STDIN</code> when the input filename is a dash.
The rest of the module calls these helpers using the various structs to run all the tests.<a data-primary="uniq program" data-secondary="writing uniqr version" data-startref="ix_uniqwrtst" data-tertiary="testing the program" data-type="indexterm" id="id795"/><a data-primary="testing" data-secondary="of uniqr program" data-secondary-sortas="uniqr" data-startref="ix_tstuniqr" data-type="indexterm" id="id796"/></p>
</div></section>








<section data-pdf-bookmark="Processing the Input Files" data-type="sect2"><div class="sect2" id="id61">
<h2>Processing the Input Files</h2>

<p>As in previous chapters, I recommend you have your <code>main</code> pass the <code>Args</code> structure to a <code>run</code> function and handle errors.
Be sure to add <code>use anyhow::Result</code> for the following code:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">run</code><code class="p">(</code><code class="n">Args</code>::<code class="n">parse</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="fm">eprintln!</code><code class="p">(</code><code class="s">"{e}"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="n">std</code>::<code class="n">process</code>::<code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">_args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Your program will need to read <a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="processing input files" data-type="indexterm" id="ix_uniqwrin"/><a data-primary="input files" data-secondary="processing in uniqr program" data-type="indexterm" id="ix_inuniqr"/>the input file, so it makes sense to use the <code>open</code> function from previous chapters:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">open</code><code class="p">(</code><code class="n">filename</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Box</code><code class="o">&lt;</code><code class="k">dyn</code><code class="w"> </code><code class="n">BufRead</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="s">"-"</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="nb">Box</code>::<code class="n">new</code><code class="p">(</code><code class="n">BufReader</code>::<code class="n">new</code><code class="p">(</code><code class="n">io</code>::<code class="n">stdin</code><code class="p">()))),</code><code class="w"/>
<code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="nb">Box</code>::<code class="n">new</code><code class="p">(</code><code class="n">BufReader</code>::<code class="n">new</code><code class="p">(</code><code class="n">File</code>::<code class="n">open</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">))),</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Be sure you expand your imports to include the following:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">use</code><code class="w"> </code><code class="n">std</code><code>:</code><code>:</code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO12-1" id="co_den_of_uniquity_CO12-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="n">fs</code><code>::</code><code class="n">File</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="n">io</code><code>:</code><code>:</code><code class="p">{</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">BufRead</code><code class="p">,</code><code class="w"> </code><code class="n">BufReader</code><code class="p">}</code><code class="p">,</code><code class="w">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO12-1" id="callout_den_of_uniquity_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>This syntax will group imports by common prefixes, so all the following come from <code>std</code>.</p></dd>
</dl>

<p>You can borrow quite a bit of code from <a data-type="xref" href="ch03.html#ch03">Chapter 3</a> that reads lines of text from an input file or <code>STDIN</code> while preserving the line endings.
Note that the following code requires importing the <a href="https://oreil.ly/AMqFU"><code>anyhow::anyhow</code></a> macro.
I use this rather than <code>format!</code> to create the <a data-primary="anyhow::anyhow macro" data-type="indexterm" id="id797"/>error message when the input file cannot be opened:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="w">
</code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">{}: {e}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-1" id="co_den_of_uniquity_CO13-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-2" id="co_den_of_uniquity_CO13-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-3" id="co_den_of_uniquity_CO13-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_line</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-4" id="co_den_of_uniquity_CO13-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-5" id="co_den_of_uniquity_CO13-5"><img alt="5" src="assets/5.png"/></a><code class="w">
            </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{line}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-6" id="co_den_of_uniquity_CO13-6"><img alt="6" src="assets/6.png"/></a><code class="w">
        </code><code class="n">line</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO13-7" id="co_den_of_uniquity_CO13-7"><img alt="7" src="assets/7.png"/></a><code class="w">
    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO13-1" id="callout_den_of_uniquity_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Either read <code>STDIN</code> if the input file is a dash or open the given filename. Create an informative error message when this fails.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-2" id="callout_den_of_uniquity_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create a new, empty mutable <code>String</code> buffer to hold each line.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-3" id="callout_den_of_uniquity_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Create an infinite loop.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-4" id="callout_den_of_uniquity_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Read a line of text while preserving the line endings.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-5" id="callout_den_of_uniquity_CO13-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>If no bytes were read, break out of the loop.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-6" id="callout_den_of_uniquity_CO13-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Print the line buffer.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO13-7" id="callout_den_of_uniquity_CO13-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Clear the line buffer.</p></dd>
</dl>

<p>Run your program with an input file to ensure it works:</p>

<pre data-type="programlisting">$ cargo run -- tests/inputs/one.txt
a</pre>

<p>It should also work for reading <code>STDIN</code>:</p>

<pre data-type="programlisting">$ cargo run -- - &lt; tests/inputs/one.txt
a</pre>

<p>Next, make your program iterate the lines of input and count each unique run of lines, then print the lines with and without the counts.
Once you can create the correct output, you will need to handle printing it either to <code>STDOUT</code> or a given filename.
I suggest that you copy ideas from the <code>open</code> function and use <a href="https://oreil.ly/QPy35"><code>File::create</code></a>.<a data-primary="File::create function" data-type="indexterm" id="id798"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Stop reading here and finish your program. Remember that you can run just a subset of tests with a command like <strong><code>cargo test empty</code></strong> to run all the tests with the string <em>empty</em> in the name.<a data-primary="uniq program" data-secondary="writing uniqr version" data-startref="ix_uniqwrin" data-tertiary="processing input files" data-type="indexterm" id="id799"/><a data-primary="input files" data-secondary="processing in uniqr program" data-startref="ix_inuniqr" data-type="indexterm" id="id800"/></p>
</div>
</div></section>
</div></section>






<section class="pagebreak-before less_space" data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="id62">
<h1>Solution</h1>

<p>I’ll step you through how I arrived at a solution.<a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="solution" data-type="indexterm" id="ix_uniqwrsol"/>
Your version may be different, but it’s fine as long as it passes the test suite.
I decided to create two additional mutable variables to hold the previous line of text and the running count.
For now, I will always print the count to make sure it’s working correctly:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">        </code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">{}: {e}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">previous</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-1" id="co_den_of_uniquity_CO14-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">count</code><code>:</code><code> </code><code class="kt">u64</code><code> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-2" id="co_den_of_uniquity_CO14-2"><img alt="2" src="assets/2.png"/></a><code class="w">

    </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_line</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">!</code><code class="o">=</code><code class="w"> </code><code class="n">previous</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-3" id="co_den_of_uniquity_CO14-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="k">if</code><code class="w"> </code><code class="n">count</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-4" id="co_den_of_uniquity_CO14-4"><img alt="4" src="assets/4.png"/></a><code class="w">
                </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{count:&gt;4} {previous}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-5" id="co_den_of_uniquity_CO14-5"><img alt="5" src="assets/5.png"/></a><code class="w">
            </code><code class="p">}</code><code class="w">
</code><code class="w">            </code><code class="n">previous</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-6" id="co_den_of_uniquity_CO14-6"><img alt="6" src="assets/6.png"/></a><code class="w">
            </code><code class="n">count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-7" id="co_den_of_uniquity_CO14-7"><img alt="7" src="assets/7.png"/></a><code class="w">
        </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="n">count</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-8" id="co_den_of_uniquity_CO14-8"><img alt="8" src="assets/8.png"/></a><code class="w">
        </code><code class="n">line</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">count</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO14-9" id="co_den_of_uniquity_CO14-9"><img alt="9" src="assets/9.png"/></a><code class="w">
        </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{count:&gt;4} {previous}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO14-1" id="callout_den_of_uniquity_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a mutable variable to hold the previous line of text.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-2" id="callout_den_of_uniquity_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create a mutable variable to hold the count.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-3" id="callout_den_of_uniquity_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Compare the current line to the previous line, both trimmed of any possible trailing whitespace.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-4" id="callout_den_of_uniquity_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Print the output only when <code>count</code> is greater than <code>0</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-5" id="callout_den_of_uniquity_CO14-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Print the <code>count</code> right-justified in a column four characters wide followed by a space and the <code>previous</code> value.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-6" id="callout_den_of_uniquity_CO14-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Set the <code>previous</code> variable to a copy of the current <code>line</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-7" id="callout_den_of_uniquity_CO14-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Reset the counter to 0.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-8" id="callout_den_of_uniquity_CO14-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Increment the counter by 1.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO14-9" id="callout_den_of_uniquity_CO14-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Handle the last line of the file.</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I didn’t have to indicate the type <code>u64</code> for the <code>count</code> variable. Rust will happily infer a type. On a 32-bit system, Rust would use an <code>i32</code>, which would limit the maximum number of duplicates to <a href="https://oreil.ly/sE2YC"><code>i32::MAX</code></a>, or 2,147,483,647. That’s a big number that’s likely to be adequate, but I think it’s better to have the program work consistently by specifying <code>u64</code>.</p>
</div>

<p>If I run <strong><code>cargo test</code></strong>, this will pass a fair number of tests.
This code is clunky, though.
I don’t like having to check <code>if count &gt; 0</code> twice, as it violates the <em>don’t repeat yourself</em> (DRY) principle, where you isolate a common idea into a single abstraction like a function rather than copying and pasting the same lines of code throughout a program.<a data-primary="don’t repeat yourself (DRY) principle" data-type="indexterm" id="id801"/>
Also, my code always prints the count, but it should print the count only when <code>args.count</code> is <code>true</code>.<a data-primary="closures" data-secondary="using to capture a value" data-type="indexterm" id="id802"/>
I can put all of this logic into a function, and I will specifically use a closure to <em>close around</em> the <code>args.count</code> value.
Add this inside the <code>run</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="kd">let</code><code class="w"> </code><code class="n">print</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">|</code><code class="n">num</code><code>:</code><code> </code><code class="kt">u64</code><code class="p">,</code><code class="w"> </code><code class="n">text</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO15-1" id="co_den_of_uniquity_CO15-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO15-2" id="co_den_of_uniquity_CO15-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">count</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO15-3" id="co_den_of_uniquity_CO15-3"><img alt="3" src="assets/3.png"/></a><code class="w">
            </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{num:&gt;4} {text}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO15-4" id="co_den_of_uniquity_CO15-4"><img alt="4" src="assets/4.png"/></a><code class="w">
        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="fm">print!</code><code class="p">(</code><code class="s">"</code><code class="s">{text}</code><code class="s">"</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO15-5" id="co_den_of_uniquity_CO15-5"><img alt="5" src="assets/5.png"/></a><code class="w">
        </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO15-1" id="callout_den_of_uniquity_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>print</code> closure will accept <code>num</code> and <code>text</code> values.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO15-2" id="callout_den_of_uniquity_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Print only if <code>num</code> is greater than <code>0</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO15-3" id="callout_den_of_uniquity_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Check if the <code>args.count</code> value is <code>true</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO15-4" id="callout_den_of_uniquity_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Use the <code>print!</code> macro to print the <code>num</code> and <code>text</code> to <code>STDOUT</code>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO15-5" id="callout_den_of_uniquity_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Otherwise, print the <code>text</code> to <code>STDOUT</code>.</p></dd>
</dl>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id803">
<h1>Closures Versus Functions</h1>
<p>A closure is a function, so you might<a data-primary="closures" data-secondary="versus functions" data-secondary-sortas="functions" data-type="indexterm" id="id804"/><a data-primary="functions" data-secondary="closures versus" data-type="indexterm" id="id805"/> be tempted to write <code>print</code> as a function inside the <code>run</code> function:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="n">args</code>: <code class="nc">Args</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="o">..</code><code class="p">.</code><code class="w"/>
<code class="w">    </code><code class="k">fn</code> <code class="nf">print</code><code class="p">(</code><code class="n">num</code>: <code class="kt">u64</code><code class="p">,</code><code class="w"> </code><code class="n">text</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">count</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="fm">print!</code><code class="p">(</code><code class="s">"{num:&gt;4} {text}"</code><code class="p">);</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="fm">print!</code><code class="p">(</code><code class="s">"{text}"</code><code class="p">);</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="o">..</code><code class="p">.</code><code class="w"/></pre>

<p>This is a common way to write a closure in other languages, and Rust does allow you to declare a function inside another function; however, the Rust compiler specifically disallows<a data-primary="|| (pipes)" data-secondary="|| { …​ } closure form" data-type="indexterm" id="id806"/> capturing a dynamic value from the environment:</p>

<pre data-type="programlisting">error[E0434]: can't capture dynamic environment in a fn item
  --&gt; src/main.rs:40:16
   |
40 |             if args.count {
   |                ^^^^
   |
   = help: use the `|| { ... }` closure form instead</pre>
</div></aside>

<p>I can update the rest of the function to use this closure:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_line</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">!</code><code class="o">=</code><code class="w"> </code><code class="n">previous</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><strong><code class="n">print</code><code class="p">(</code><code class="n">count</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">previous</code><code class="p">)</code><code class="p">;</code></strong><code class="w">
</code><code class="w">        </code><code class="n">previous</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="n">count</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="n">line</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="p">}</code><code class="w">
</code><code class="w">
</code><strong><code class="n">print</code><code class="p">(</code><code class="n">count</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">previous</code><code class="p">)</code><code class="p">;</code></strong></pre>

<p>At this point, the program will pass several more tests.
All the failed test names have the string <em>outfile</em> because the program fails to write a named output file.
To add this last feature, you can open the output file in the same way as the input file, either by creating a named output file using <code>File::create</code> or by using <code>std::io::stdout</code>.<a data-primary="File::create function" data-type="indexterm" id="id807"/><a data-primary="std::io::stdout" data-type="indexterm" id="id808"/><a data-primary="std::io::Write" data-type="indexterm" id="id809"/>
Be sure to add <code>use std::io::Write</code> for the following code, which you can place just after the <code>file</code> variable:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">out_file</code><code>:</code><code> </code><code class="nb">Box</code><code class="o">&lt;</code><code class="k">dyn</code><code class="w"> </code><code class="n">Write</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">out_file</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO16-1" id="co_den_of_uniquity_CO16-1"><img alt="1" src="assets/1.png"/></a><code class="w">
    </code><code class="nb">Some</code><code class="p">(</code><code class="n">out_name</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="nb">Box</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">File</code><code>::</code><code class="n">create</code><code class="p">(</code><code class="n">out_name</code><code class="p">)</code><code class="o">?</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO16-2" id="co_den_of_uniquity_CO16-2"><img alt="2" src="assets/2.png"/></a><code class="w">
    </code><code class="n">_</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="nb">Box</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">io</code><code>::</code><code class="n">stdout</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO16-3" id="co_den_of_uniquity_CO16-3"><img alt="3" src="assets/3.png"/></a><code class="w">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO16-1" id="callout_den_of_uniquity_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The mutable <code>out_file</code> will be a boxed value that implements the <a href="https://oreil.ly/Hlk6A"><code>std::io​::Write</code> trait</a>.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO16-2" id="callout_den_of_uniquity_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>When <code>args.out_file</code> is <code>Some</code> filename, use <a href="https://oreil.ly/QPy35"><code>File::create</code></a> to try to create the file.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO16-3" id="callout_den_of_uniquity_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Otherwise, use <a href="https://oreil.ly/gjxor"><code>std::io::stdout</code></a>.</p></dd>
</dl>

<p>If you look at the documentation for <code>File::create</code> and <code>io::stdout</code>, you’ll see both have a “Traits” section showing the various traits they implement.<a data-primary="Write trait" data-type="indexterm" id="id810"/>
Both show that they implement <code>Write</code>, so they satisfy the type requirement <code>Box&lt;dyn Write&gt;</code>, which says that the value inside the <code>Box</code> must implement this trait.</p>

<p>The second change I need to make is to use <code>out_file</code> for the output.
I will replace the <code>print!</code> macro with <a href="https://oreil.ly/oiJaM"><code>write!</code></a> to write the output to a stream like a filehandle or <code>STDOUT</code>.
The first argument to <code>write!</code> must be a mutable value that implements the <code>Write</code> trait.
The documentation shows that <code>write!</code> will return a <code>std::io::Result</code> because it might fail.
As such, I changed my <code>print</code> closure to return <code>Result</code>.
Here is the final version of my <code>run</code> function that passes all the tests:</p>

<pre data-code-language="rust" data-type="programlisting"><code class="k">fn</code><code> </code><code class="nf">run</code><code class="p">(</code><code class="n">args</code><code>:</code><code> </code><code class="nc">Args</code><code class="p">)</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w">
</code><code class="w">        </code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">anyhow</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="s">{}: {e}</code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">in_file</code><code class="p">)</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO17-1" id="co_den_of_uniquity_CO17-1"><img alt="1" src="assets/1.png"/></a><code class="w">

    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">out_file</code><code>:</code><code> </code><code class="nb">Box</code><code class="o">&lt;</code><code class="k">dyn</code><code class="w"> </code><code class="n">Write</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="o">&amp;</code><code class="n">args</code><code class="p">.</code><code class="n">out_file</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO17-2" id="co_den_of_uniquity_CO17-2"><img alt="2" src="assets/2.png"/></a><code class="w">
        </code><code class="nb">Some</code><code class="p">(</code><code class="n">out_name</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="nb">Box</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">File</code><code>::</code><code class="n">create</code><code class="p">(</code><code class="n">out_name</code><code class="p">)</code><code class="o">?</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=</code><code class="o">&gt;</code><code class="w"> </code><code class="nb">Box</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="n">io</code><code>::</code><code class="n">stdout</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">print</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">|</code><code class="n">num</code><code>:</code><code> </code><code class="kt">u64</code><code class="p">,</code><code class="w"> </code><code class="n">text</code><code>:</code><code> </code><code class="kp">&amp;</code><code class="kt">str</code><code class="o">|</code><code class="w"> </code><code>-&gt;</code><code> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="p">(</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO17-3" id="co_den_of_uniquity_CO17-3"><img alt="3" src="assets/3.png"/></a><code class="w">
        </code><code class="k">if</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">args</code><code class="p">.</code><code class="n">count</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="fm">write!</code><code class="p">(</code><code class="n">out_file</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">{num:&gt;4} {text}</code><code class="s">"</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">                </code><code class="fm">write!</code><code class="p">(</code><code class="n">out_file</code><code class="p">,</code><code class="w"> </code><code class="s">"</code><code class="s">{text}</code><code class="s">"</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="p">}</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="p">;</code><code class="w">
</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">previous</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code><code>::</code><code class="n">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">count</code><code>:</code><code> </code><code class="kt">u64</code><code> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">file</code><code class="p">.</code><code class="n">read_line</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">line</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">bytes</code><code class="w"> </code><code class="o">=</code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="k">break</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">!</code><code class="o">=</code><code class="w"> </code><code class="n">previous</code><code class="p">.</code><code class="n">trim_end</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">            </code><code class="n">print</code><code class="p">(</code><code class="n">count</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">previous</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO17-4" id="co_den_of_uniquity_CO17-4"><img alt="4" src="assets/4.png"/></a><code class="w">
            </code><code class="n">previous</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">line</code><code class="p">.</code><code class="n">clone</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">            </code><code class="n">count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="n">count</code><code class="w"> </code><code class="o">+</code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w">
</code><code class="w">        </code><code class="n">line</code><code class="p">.</code><code class="n">clear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">    </code><code class="n">print</code><code class="p">(</code><code class="n">count</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">previous</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"> </code><a class="co" href="#callout_den_of_uniquity_CO17-5" id="co_den_of_uniquity_CO17-5"><img alt="5" src="assets/5.png"/></a><code class="w">

    </code><code class="nb">Ok</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_den_of_uniquity_CO17-1" id="callout_den_of_uniquity_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Open either <code>STDIN</code> or the given input filename.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO17-2" id="callout_den_of_uniquity_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Open either <code>STDOUT</code> or the given output filename.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO17-3" id="callout_den_of_uniquity_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Create a mutable <code>print</code> closure to format the output.</p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO17-4" id="callout_den_of_uniquity_CO17-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Use the <code>print</code> closure to possibly print output. Use <code>?</code> to propagate potential errors.<a data-primary="print closure" data-type="indexterm" id="id811"/></p></dd>
<dt><a class="co" href="#co_den_of_uniquity_CO17-5" id="callout_den_of_uniquity_CO17-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Handle the last line of the file.</p></dd>
</dl>

<p>Note <a data-primary="mut (mutable) keyword" data-secondary="creating mutable print closure" data-type="indexterm" id="id812"/>that the <code>print</code> closure must be declared with the <code>mut</code> keyword because the <code>out_file</code> filehandle is borrowed as a mutable value.
Without this, the compiler will show the following error:</p>

<pre data-type="programlisting">error[E0596]: cannot borrow `print` as mutable, as it is not declared as mutable
  --&gt; src/main.rs:41:9
   |
41 |     let print = |num: u64, text: &amp;str| -&gt; Result&lt;()&gt; {
   |         ^^^^^ not mutable
...
44 |                 write!(out_file, "{num:&gt;4} {text}")?;
   |                        -------- calling `print` requires mutable binding
   |                                 due to mutable borrow of `out_file`</pre>

<p>Again, it’s okay if your solution is different from mine, as long as it passes the tests.
Part of what I like about writing with tests is that there is an objective determination of when a program meets some level of specifications.
As Louis Srygley once said, “Without requirements or design, programming is the art of adding bugs to an empty text file.”<sup><a data-type="noteref" href="ch06.html#id813" id="id813-marker">2</a></sup>
I would say that tests are the requirements made incarnate.
Without tests, you simply have no way to know when a change to your program strays from the requirements or breaks the design.</p>
</div></section>






<section data-pdf-bookmark="Going Further" data-type="sect1"><div class="sect1" id="id63">
<h1>Going Further</h1>

<p>Can you find other ways to write this algorithm?
For instance, I tried another method that read all the lines of the input file into a vector and used <a href="https://oreil.ly/vudZO"><code>Vec::windows</code></a> to look at pairs of lines.<a data-primary="Vec::windows" data-type="indexterm" id="id814"/><a data-primary="uniq program" data-secondary="writing uniqr version" data-tertiary="going further" data-type="indexterm" id="id815"/>
This was interesting but could fail if the size of the input file exceeded the available memory on my machine.
The solution presented here will only ever allocate memory for the current and previous lines and so should scale to any size file.</p>

<p>As usual, the BSD and GNU versions of <code>uniq</code> both have many more features than I chose to include in the challenge.
I would encourage you to add all the features you would like to have in your version.
Be sure to add tests for each feature, and always run the entire test suite to verify that all previous features still work.</p>

<p>In my mind, <code>uniq</code> is closely tied <a data-primary="sort command" data-type="indexterm" id="id816"/>with <code>sort</code>, as I often use them together.
Consider implementing a Rust version of <code>sort</code>, at least to the point of sorting values lexicographically (in dictionary order) or numerically.</p>
</div></section>






<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id64">
<h1>Summary</h1>

<p>In about 80 lines of Rust, the <code>uniqr</code> program manages to replicate a reasonable subset of features from the original <code>uniq</code> program.
Compare this to <a href="https://oreil.ly/X8ipY">the GNU C source code</a>, which has more than 600 lines of code.
I would feel much more confident extending <code>uniqr</code> than I would using C due to the Rust compiler’s use of types and useful error messages.</p>

<p class="pagebreak-before">Let’s review some of the things you learned in this chapter:</p>

<ul>
<li>
<p>You can now open a new file for writing or print to <code>STDOUT</code>.</p>
</li>
<li>
<p>DRY says that any duplicated code should be moved into a single abstraction like a function or a closure.</p>
</li>
<li>
<p>A closure must be used to capture values from the enclosing scope.</p>
</li>
<li>
<p>When a value implements the <code>Write</code> trait, it can be used with the <code>write!</code> and <code>writeln!</code> macros.<a data-primary="Write trait" data-type="indexterm" id="id817"/><a data-primary="tempfile crate" data-type="indexterm" id="id818"/></p>
</li>
<li>
<p>The <code>tempfile</code> crate helps you create and remove temporary files.</p>
</li>
<li>
<p>The Rust compiler may sometimes require you to indicate the lifetime of a variable, which is how long it lives in relation to other variables.</p>
</li>
</ul>

<p>In the next chapter, I’ll show how to create Rust’s enumerated <code>enum</code> type and how to use regular expressions.<a data-primary="uniq program" data-startref="ix_uniq" data-type="indexterm" id="id819"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id777"><sup><a href="ch06.html#id777-marker">1</a></sup> While the goal is to mimic the original versions as much as possible, I would note that I do not like optional positional parameters. In my opinion, it would be better to create an <code>-o|--output</code> option that defaults to <code>STDOUT</code> and one optional positional argument for the input file that defaults to <code>STDIN</code>.</p><p data-type="footnote" id="id813"><sup><a href="ch06.html#id813-marker">2</a></sup> Programming Wisdom (@CodeWisdom), “‘Without requirements or design, programming is the art of adding bugs to an empty text file.’ - Louis Srygley,” Twitter, January 24, 2018, 1:00 p.m., <a class="bare" href="https://oreil.ly/FC6aS"><em class="hyperlink">https://oreil.ly/FC6aS</em></a>.</p></div></div></section></body></html>